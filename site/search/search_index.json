{"config":{"lang":["ru"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"BionicPRO Architecture Documentation","text":"<p>BionicPRO \u2014 \u0440\u043e\u0441\u0441\u0438\u0439\u0441\u043a\u0430\u044f \u043a\u043e\u043c\u043f\u0430\u043d\u0438\u044f, \u043f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u044f\u0449\u0430\u044f \u0438 \u043f\u0440\u043e\u0434\u0430\u044e\u0449\u0430\u044f \u0431\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u043f\u0440\u043e\u0442\u0435\u0437\u044b. \u0414\u0430\u043d\u043d\u0430\u044f \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430\u0446\u0438\u044f \u043e\u043f\u0438\u0441\u044b\u0432\u0430\u0435\u0442 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0443 enterprise-\u0440\u0435\u0448\u0435\u043d\u0438\u044f \u0434\u043b\u044f \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0435\u0439 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439, \u0441\u0431\u043e\u0440\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0441 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 \u0438 \u0444\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432.</p>"},{"location":"#_1","title":"\u041e\u0431\u0437\u043e\u0440 \u0441\u0438\u0441\u0442\u0435\u043c\u044b","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     SECURITY LAYER                               \u2502\n\u2502 LDAP (389) \u2192 Keycloak (8080) \u2192 BFF Auth (8000) \u2192 Redis          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    APPLICATION LAYER                             \u2502\n\u2502 Frontend React (3000) \u2190 BFF \u2192 Reports Service FastAPI (8001)    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    DATA PIPELINE                                 \u2502\n\u2502 CRM PostgreSQL \u2500\u2500\u2500 Debezium CDC \u2500\u2500\u2500 Kafka \u2500\u2500\u2500 ClickHouse        \u2502\n\u2502 Telemetry PostgreSQL \u2500\u2500\u2500 Airflow ETL (15min) \u2500\u2500\u2500 ClickHouse     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   CDN &amp; CACHING                                  \u2502\n\u2502 Reports Service \u2192 MinIO S3 (9002) \u2192 Nginx CDN (8002)            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"#_2","title":"\u041a\u043b\u044e\u0447\u0435\u0432\u044b\u0435 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b","text":"\u0417\u0430\u0434\u0430\u043d\u0438\u0435 \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Task 1 Security Architecture LDAP + Keycloak OAuth2/PKCE + BFF pattern + MFA Task 2 Reports &amp; ETL Airflow ETL + ClickHouse OLAP + FastAPI Reports Service Task 3 S3/CDN Caching MinIO S3 + Nginx CDN \u0434\u043b\u044f \u0441\u043d\u0438\u0436\u0435\u043d\u0438\u044f \u043d\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u043d\u0430 \u0411\u0414 Task 4 CDC Pipeline Debezium + Kafka + ClickHouse KafkaEngine"},{"location":"#_3","title":"\u0411\u044b\u0441\u0442\u0440\u044b\u0439 \u0441\u0442\u0430\u0440\u0442","text":"<pre><code># 1. \u041a\u043b\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0440\u0435\u043f\u043e\u0437\u0438\u0442\u043e\u0440\u0438\u044f\ngit clone &lt;repository-url&gt;\ncd architecture-bionicpro\n\n# 2. \u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0445 \u043e\u043a\u0440\u0443\u0436\u0435\u043d\u0438\u044f\ncp .env.example .env\n# \u041e\u0442\u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u0443\u0439\u0442\u0435 .env \u0438 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0435 \u0437\u043d\u0430\u0447\u0435\u043d\u0438\u044f \u043a\u043b\u044e\u0447\u0435\u0439\n\n# 3. \u0417\u0430\u043f\u0443\u0441\u043a \u0432\u0441\u0435\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432\ndocker-compose up -d\n\n# 4. \u041e\u0436\u0438\u0434\u0430\u043d\u0438\u0435 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438 (2-3 \u043c\u0438\u043d\u0443\u0442\u044b)\ndocker-compose logs -f airflow-etl-trigger\n\n# 5. \u0414\u043e\u0441\u0442\u0443\u043f \u043a \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044e\nopen http://localhost:3000\n</code></pre> <p>\u041f\u043e\u0434\u0440\u043e\u0431\u043d\u044b\u0435 \u0438\u043d\u0441\u0442\u0440\u0443\u043a\u0446\u0438\u0438: Deployment Guide</p>"},{"location":"#_4","title":"\u0422\u0435\u0441\u0442\u043e\u0432\u044b\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438","text":"<p>\u0412\u0441\u0435 \u043f\u0430\u0440\u043e\u043b\u0438: <code>password123</code></p> Username \u0420\u043e\u043b\u044c \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 ivan.petrov prothetic_user \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430 (\u0420\u0424) john.mueller prothetic_user \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430 (\u0415\u0432\u0440\u043e\u043f\u0430) maria.sidorova user \u041e\u0431\u044b\u0447\u043d\u044b\u0439 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c alexey.kozlov administrator \u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440 \u0441\u0438\u0441\u0442\u0435\u043c\u044b"},{"location":"#_5","title":"\u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u0441\u0442\u0435\u043a","text":""},{"location":"#backend","title":"Backend","text":"<ul> <li>Python 3.11: FastAPI 0.109, Flask 3.0, Apache Airflow 2.8.1</li> <li>Databases: PostgreSQL 14 (OLTP), ClickHouse 24.1 (OLAP)</li> <li>Messaging: Apache Kafka 3.6 (Confluent 7.5.0), Debezium CDC</li> </ul>"},{"location":"#frontend","title":"Frontend","text":"<ul> <li>React 18 \u0441 TypeScript</li> <li>Tailwind CSS \u0434\u043b\u044f \u0441\u0442\u0438\u043b\u0438\u0437\u0430\u0446\u0438\u0438</li> </ul>"},{"location":"#infrastructure","title":"Infrastructure","text":"<ul> <li>Keycloak 26.5.2: Identity Provider \u0441 LDAP Federation</li> <li>OpenLDAP 1.5.0: Directory Service</li> <li>Redis 7: Session Storage &amp; Caching</li> <li>MinIO: S3-compatible Object Storage</li> <li>Nginx 1.25: CDN Proxy \u0441 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c</li> </ul>"},{"location":"#_6","title":"\u041d\u0430\u0432\u0438\u0433\u0430\u0446\u0438\u044f \u043f\u043e \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430\u0446\u0438\u0438","text":"<ul> <li> <p>:material-shield-lock:{ .lg .middle } Security Architecture</p> <p>BFF pattern, OAuth2 PKCE, MFA, LDAP Federation</p> <p>:octicons-arrow-right-24: Task 1</p> </li> <li> <p>:material-chart-bar:{ .lg .middle } Reports &amp; ETL</p> <p>Airflow DAGs, ClickHouse OLAP, FastAPI</p> <p>:octicons-arrow-right-24: Task 2</p> </li> <li> <p>:material-cloud:{ .lg .middle } S3/CDN Caching</p> <p>MinIO, Nginx CDN, Cache Invalidation</p> <p>:octicons-arrow-right-24: Task 3</p> </li> <li> <p>:material-database-sync:{ .lg .middle } CDC Pipeline</p> <p>Debezium, Kafka, KafkaEngine</p> <p>:octicons-arrow-right-24: Task 4</p> </li> </ul>"},{"location":"api/auth/","title":"Auth API (BFF)","text":""},{"location":"api/auth/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>BFF (Backend-for-Frontend) service \u043e\u0431\u0435\u0441\u043f\u0435\u0447\u0438\u0432\u0430\u0435\u0442 \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044e \u0447\u0435\u0440\u0435\u0437 Keycloak \u0441 \u043f\u0430\u0442\u0442\u0435\u0440\u043d\u043e\u043c PKCE.</p> <p>Base URL: <code>http://localhost:8000</code></p>"},{"location":"api/auth/#_2","title":"\u041e\u0441\u043e\u0431\u0435\u043d\u043d\u043e\u0441\u0442\u0438","text":"<ul> <li>\u0422\u043e\u043a\u0435\u043d\u044b \u0445\u0440\u0430\u043d\u044f\u0442\u0441\u044f \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435 (\u043d\u0435 \u043f\u0435\u0440\u0435\u0434\u0430\u044e\u0442\u0441\u044f \u043a\u043b\u0438\u0435\u043d\u0442\u0443)</li> <li>\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 HTTP-only, Secure cookies \u0434\u043b\u044f \u0441\u0435\u0441\u0441\u0438\u0439</li> <li>\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0435 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0435 access_token</li> <li>PKCE flow (S256 challenge)</li> </ul>"},{"location":"api/auth/#endpoints","title":"Endpoints","text":""},{"location":"api/auth/#authentication","title":"Authentication","text":""},{"location":"api/auth/#get-authlogin","title":"GET /auth/login","text":"<p>\u0418\u043d\u0438\u0446\u0438\u0430\u0446\u0438\u044f OAuth2 PKCE flow.</p> <p>Request: <pre><code>GET /auth/login HTTP/1.1\nHost: localhost:8000\n</code></pre></p> <p>Response <code>302 Found</code>: <pre><code>HTTP/1.1 302 Found\nLocation: http://localhost:8080/realms/reports-realm/protocol/openid-connect/auth\n  ?client_id=bionicpro-auth\n  &amp;response_type=code\n  &amp;scope=openid%20profile%20email\n  &amp;redirect_uri=http://localhost:8000/auth/callback\n  &amp;state=abc123\n  &amp;code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM\n  &amp;code_challenge_method=S256\n</code></pre></p>"},{"location":"api/auth/#get-authcallback","title":"GET /auth/callback","text":"<p>OAuth2 callback endpoint. \u041e\u0431\u043c\u0435\u043d authorization code \u043d\u0430 \u0442\u043e\u043a\u0435\u043d\u044b.</p> <p>Request: <pre><code>GET /auth/callback?code=xxx&amp;state=abc123 HTTP/1.1\nHost: localhost:8000\n</code></pre></p> <p>Response <code>302 Found</code>: <pre><code>HTTP/1.1 302 Found\nLocation: http://localhost:3000\nSet-Cookie: session_id=xyz789; HttpOnly; Secure; SameSite=Lax; Path=/\n</code></pre></p>"},{"location":"api/auth/#post-authlogout","title":"POST /auth/logout","text":"<p>\u0417\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u0435 \u0441\u0435\u0441\u0441\u0438\u0438.</p> <p>Request: <pre><code>POST /auth/logout HTTP/1.1\nHost: localhost:8000\nCookie: session_id=xyz789\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"status\": \"logged_out\"\n}\n</code></pre></p> <p>Response <code>302 Found</code> (\u043f\u0440\u0438 redirect): <pre><code>HTTP/1.1 302 Found\nLocation: http://localhost:3000\nSet-Cookie: session_id=; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=0\n</code></pre></p>"},{"location":"api/auth/#user-info","title":"User Info","text":""},{"location":"api/auth/#get-authme","title":"GET /auth/me","text":"<p>\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f \u043e \u0442\u0435\u043a\u0443\u0449\u0435\u043c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435.</p> <p>Request: <pre><code>GET /auth/me HTTP/1.1\nHost: localhost:8000\nCookie: session_id=xyz789\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"sub\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"preferred_username\": \"ivan.petrov\",\n  \"email\": \"ivan.petrov@bionicpro.com\",\n  \"name\": \"Ivan Petrov\",\n  \"email_verified\": true,\n  \"roles\": [\"prothetic_user\"],\n  \"groups\": [\"/prothetic_users\"]\n}\n</code></pre></p> <p>Response <code>401 Unauthorized</code>: <pre><code>{\n  \"error\": \"Not authenticated\"\n}\n</code></pre></p>"},{"location":"api/auth/#api-proxy","title":"API Proxy","text":""},{"location":"api/auth/#any-api","title":"ANY /api/*","text":"<p>\u041f\u0440\u043e\u043a\u0441\u0438 \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043a Reports Service \u0441 \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0439 \u043f\u0435\u0440\u0435\u0434\u0430\u0447\u0435\u0439 \u0442\u043e\u043a\u0435\u043d\u0430.</p> <p>Request: <pre><code>GET /api/reports HTTP/1.1\nHost: localhost:8000\nCookie: session_id=xyz789\n</code></pre></p> <p>Flow: 1. BFF \u0438\u0437\u0432\u043b\u0435\u043a\u0430\u0435\u0442 access_token \u0438\u0437 Redis \u043f\u043e session_id 2. \u0415\u0441\u043b\u0438 \u0442\u043e\u043a\u0435\u043d \u0438\u0441\u0442\u0451\u043a, \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0435\u0442 \u0447\u0435\u0440\u0435\u0437 refresh_token 3. \u041f\u0440\u043e\u043a\u0441\u0438\u0440\u0443\u0435\u0442 \u0437\u0430\u043f\u0440\u043e\u0441 \u043a Reports Service \u0441 Bearer token</p> <p>Response: \u041e\u0442\u0432\u0435\u0442 \u043e\u0442 Reports Service</p>"},{"location":"api/auth/#health","title":"Health","text":""},{"location":"api/auth/#get-health","title":"GET /health","text":"<p>\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0440\u0430\u0431\u043e\u0442\u043e\u0441\u043f\u043e\u0441\u043e\u0431\u043d\u043e\u0441\u0442\u0438 BFF.</p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"status\": \"healthy\",\n  \"keycloak\": \"connected\",\n  \"redis\": \"connected\"\n}\n</code></pre></p>"},{"location":"api/auth/#session-management","title":"Session Management","text":""},{"location":"api/auth/#cookie-structure","title":"Cookie Structure","text":"<pre><code>session_id=&lt;uuid&gt;; HttpOnly; Secure; SameSite=Lax; Path=/; Max-Age=86400\n</code></pre> Attribute Value \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 HttpOnly true \u041d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u0435\u043d \u0438\u0437 JavaScript Secure true (prod) \u0422\u043e\u043b\u044c\u043a\u043e HTTPS SameSite Lax \u0417\u0430\u0449\u0438\u0442\u0430 \u043e\u0442 CSRF Max-Age 86400 24 \u0447\u0430\u0441\u0430"},{"location":"api/auth/#redis-storage","title":"Redis Storage","text":"<pre><code>session:{session_id}:\n  access_token: &lt;encrypted&gt;\n  refresh_token: &lt;encrypted&gt;\n  user_info: { ... }\n  created_at: timestamp\n  expires_at: timestamp\n</code></pre>"},{"location":"api/auth/#token-refresh","title":"Token Refresh","text":"<p>BFF \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0435\u0442 \u0442\u043e\u043a\u0435\u043d\u044b:</p> <pre><code>sequenceDiagram\n    participant C as Client\n    participant BFF\n    participant R as Redis\n    participant KC as Keycloak\n\n    C-&gt;&gt;BFF: Request + session cookie\n    BFF-&gt;&gt;R: Get tokens\n    R-&gt;&gt;BFF: Encrypted tokens\n\n    alt Token expired\n        BFF-&gt;&gt;KC: Refresh token request\n        KC-&gt;&gt;BFF: New access + refresh tokens\n        BFF-&gt;&gt;R: Store new tokens\n    end\n\n    BFF-&gt;&gt;API: Request + Bearer token</code></pre>"},{"location":"api/auth/#error-responses","title":"Error Responses","text":""},{"location":"api/auth/#401-unauthorized","title":"401 Unauthorized","text":"<pre><code>{\n  \"error\": \"Not authenticated\",\n  \"detail\": \"Session not found or expired\"\n}\n</code></pre>"},{"location":"api/auth/#403-forbidden","title":"403 Forbidden","text":"<pre><code>{\n  \"error\": \"Access denied\",\n  \"detail\": \"Insufficient permissions\"\n}\n</code></pre>"},{"location":"api/auth/#_3","title":"\u041f\u0440\u0438\u043c\u0435\u0440\u044b \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f","text":""},{"location":"api/auth/#frontend-react","title":"Frontend (React)","text":"<pre><code>// Login\nconst login = () =&gt; {\n  window.location.href = 'http://localhost:8000/auth/login';\n};\n\n// Get user info\nconst getUser = async () =&gt; {\n  const response = await fetch('http://localhost:8000/auth/me', {\n    credentials: 'include'  // Include cookies\n  });\n  if (response.ok) {\n    return response.json();\n  }\n  return null;\n};\n\n// Logout\nconst logout = async () =&gt; {\n  await fetch('http://localhost:8000/auth/logout', {\n    method: 'POST',\n    credentials: 'include'\n  });\n  window.location.href = '/';\n};\n\n// API request (proxied through BFF)\nconst getReports = async () =&gt; {\n  const response = await fetch('http://localhost:8000/api/reports', {\n    credentials: 'include'\n  });\n  return response.json();\n};\n</code></pre>"},{"location":"api/auth/#curl","title":"cURL","text":"<pre><code># 1. Login (\u043e\u0442\u043a\u0440\u044b\u0442\u044c \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435)\nopen \"http://localhost:8000/auth/login\"\n\n# 2. \u041f\u043e\u0441\u043b\u0435 \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c cookie\ncurl -c cookies.txt -b cookies.txt http://localhost:8000/auth/me\n\n# 3. API \u0437\u0430\u043f\u0440\u043e\u0441\ncurl -b cookies.txt http://localhost:8000/api/reports\n\n# 4. Logout\ncurl -X POST -b cookies.txt http://localhost:8000/auth/logout\n</code></pre>"},{"location":"api/auth/#configuration","title":"Configuration","text":""},{"location":"api/auth/#environment-variables","title":"Environment Variables","text":"Variable Default \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 KEYCLOAK_URL http://keycloak:8080 Keycloak internal URL KEYCLOAK_PUBLIC_URL http://localhost:8080 Keycloak public URL KEYCLOAK_REALM reports-realm Realm name CLIENT_ID bionicpro-auth OAuth client ID REDIRECT_URI http://localhost:8000/auth/callback Callback URL FRONTEND_URL http://localhost:3000 Frontend redirect URL REDIS_HOST redis Redis host ENCRYPTION_KEY - Fernet key for token encryption SECURE_COOKIES true Use secure cookies"},{"location":"api/auth/#_4","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture: Security</li> <li>Reports API</li> <li>Environment Setup</li> </ul>"},{"location":"api/cdc-health/","title":"CDC Health API","text":""},{"location":"api/cdc-health/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>API \u0434\u043b\u044f \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433\u0430 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044f CDC pipeline (Debezium \u2192 Kafka \u2192 ClickHouse).</p>"},{"location":"api/cdc-health/#endpoints","title":"Endpoints","text":""},{"location":"api/cdc-health/#get-healthcdc","title":"GET /health/cdc","text":"<p>\u041a\u043e\u043c\u043f\u043b\u0435\u043a\u0441\u043d\u0430\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 CDC pipeline.</p> <p>Base URL: <code>http://localhost:8001</code></p> <p>Request: <pre><code>GET /health/cdc HTTP/1.1\nHost: localhost:8001\n</code></pre></p> <p>Response <code>200 OK</code> (healthy): <pre><code>{\n  \"status\": \"healthy\",\n  \"cdc_tables\": {\n    \"crm_customers\": {\n      \"rows\": 5,\n      \"last_update\": \"2024-01-15T10:30:00Z\"\n    },\n    \"crm_prostheses\": {\n      \"rows\": 5,\n      \"last_update\": \"2024-01-15T10:30:00Z\"\n    },\n    \"crm_prosthesis_models\": {\n      \"rows\": 5,\n      \"last_update\": \"2024-01-15T10:30:00Z\"\n    }\n  },\n  \"kafka_lag\": {\n    \"crm.crm.customers\": 0,\n    \"crm.crm.prostheses\": 0,\n    \"crm.crm.prosthesis_models\": 0\n  },\n  \"debezium\": {\n    \"status\": \"RUNNING\",\n    \"connector\": \"crm-connector\",\n    \"tasks\": 1\n  }\n}\n</code></pre></p> <p>Response <code>503 Service Unavailable</code> (degraded): <pre><code>{\n  \"status\": \"degraded\",\n  \"cdc_tables\": {\n    \"crm_customers\": {\n      \"rows\": 5,\n      \"last_update\": \"2024-01-15T08:00:00Z\"\n    }\n  },\n  \"kafka_lag\": {\n    \"crm.crm.customers\": 1500\n  },\n  \"debezium\": {\n    \"status\": \"FAILED\",\n    \"connector\": \"crm-connector\",\n    \"error\": \"Connection refused\"\n  },\n  \"issues\": [\n    \"High Kafka lag detected (&gt;1000)\",\n    \"Debezium connector not running\"\n  ]\n}\n</code></pre></p>"},{"location":"api/cdc-health/#debezium-rest-api","title":"Debezium REST API","text":""},{"location":"api/cdc-health/#base-url","title":"Base URL","text":"<p><code>http://localhost:8083</code></p>"},{"location":"api/cdc-health/#list-connectors","title":"List Connectors","text":"<pre><code>GET /connectors HTTP/1.1\nHost: localhost:8083\n</code></pre> <p>Response: <pre><code>[\"crm-connector\"]\n</code></pre></p>"},{"location":"api/cdc-health/#connector-status","title":"Connector Status","text":"<pre><code>GET /connectors/crm-connector/status HTTP/1.1\nHost: localhost:8083\n</code></pre> <p>Response: <pre><code>{\n  \"name\": \"crm-connector\",\n  \"connector\": {\n    \"state\": \"RUNNING\",\n    \"worker_id\": \"debezium:8083\"\n  },\n  \"tasks\": [\n    {\n      \"id\": 0,\n      \"state\": \"RUNNING\",\n      \"worker_id\": \"debezium:8083\"\n    }\n  ],\n  \"type\": \"source\"\n}\n</code></pre></p>"},{"location":"api/cdc-health/#pause-connector","title":"Pause Connector","text":"<pre><code>PUT /connectors/crm-connector/pause HTTP/1.1\nHost: localhost:8083\n</code></pre>"},{"location":"api/cdc-health/#resume-connector","title":"Resume Connector","text":"<pre><code>PUT /connectors/crm-connector/resume HTTP/1.1\nHost: localhost:8083\n</code></pre>"},{"location":"api/cdc-health/#restart-connector","title":"Restart Connector","text":"<pre><code>POST /connectors/crm-connector/restart HTTP/1.1\nHost: localhost:8083\n</code></pre>"},{"location":"api/cdc-health/#delete-connector","title":"Delete Connector","text":"<pre><code>DELETE /connectors/crm-connector HTTP/1.1\nHost: localhost:8083\n</code></pre>"},{"location":"api/cdc-health/#createupdate-connector","title":"Create/Update Connector","text":"<pre><code>POST /connectors HTTP/1.1\nHost: localhost:8083\nContent-Type: application/json\n\n{\n  \"name\": \"crm-connector\",\n  \"config\": {\n    \"connector.class\": \"io.debezium.connector.postgresql.PostgresConnector\",\n    \"database.hostname\": \"crm_db\",\n    \"database.port\": \"5432\",\n    \"database.user\": \"debezium_user\",\n    \"database.password\": \"debezium_password\",\n    \"database.dbname\": \"crm_db\",\n    \"database.server.name\": \"crm\",\n    \"schema.include.list\": \"crm\",\n    \"table.include.list\": \"crm.customers,crm.prostheses,crm.prosthesis_models\",\n    \"plugin.name\": \"pgoutput\",\n    \"topic.prefix\": \"crm\"\n  }\n}\n</code></pre>"},{"location":"api/cdc-health/#clickhouse-cdc-queries","title":"ClickHouse CDC Queries","text":""},{"location":"api/cdc-health/#check-cdc-tables","title":"Check CDC Tables","text":"<pre><code># Row counts\ncurl \"http://localhost:8123/\" -d \"\nSELECT\n    'crm_customers' as table,\n    count() as rows\nFROM reports.crm_customers FINAL\nWHERE _deleted = 0\nUNION ALL\nSELECT\n    'crm_prostheses',\n    count()\nFROM reports.crm_prostheses FINAL\nWHERE _deleted = 0\nUNION ALL\nSELECT\n    'crm_prosthesis_models',\n    count()\nFROM reports.crm_prosthesis_models FINAL\nWHERE _deleted = 0\n\"\n</code></pre>"},{"location":"api/cdc-health/#check-kafka-consumers","title":"Check Kafka Consumers","text":"<pre><code>curl \"http://localhost:8123/\" -d \"\nSELECT\n    database,\n    table,\n    name as consumer,\n    last_poll_time,\n    num_messages_read,\n    last_commit_time\nFROM system.kafka_consumers\n\"\n</code></pre>"},{"location":"api/cdc-health/#check-recent-updates","title":"Check Recent Updates","text":"<pre><code>curl \"http://localhost:8123/\" -d \"\nSELECT\n    id,\n    name,\n    ldap_username,\n    updated_at,\n    _version\nFROM reports.crm_customers FINAL\nORDER BY _version DESC\nLIMIT 10\n\"\n</code></pre>"},{"location":"api/cdc-health/#kafka-cli-commands","title":"Kafka CLI Commands","text":""},{"location":"api/cdc-health/#list-topics","title":"List Topics","text":"<pre><code>docker-compose exec kafka kafka-topics \\\n  --bootstrap-server localhost:9092 \\\n  --list\n</code></pre>"},{"location":"api/cdc-health/#describe-topic","title":"Describe Topic","text":"<pre><code>docker-compose exec kafka kafka-topics \\\n  --bootstrap-server localhost:9092 \\\n  --describe \\\n  --topic crm.crm.customers\n</code></pre>"},{"location":"api/cdc-health/#consumer-lag","title":"Consumer Lag","text":"<pre><code>docker-compose exec kafka kafka-consumer-groups \\\n  --bootstrap-server localhost:9092 \\\n  --describe \\\n  --group clickhouse_customers\n</code></pre>"},{"location":"api/cdc-health/#read-messages","title":"Read Messages","text":"<pre><code># First message\ndocker-compose exec kafka kafka-console-consumer \\\n  --bootstrap-server localhost:9092 \\\n  --topic crm.crm.customers \\\n  --from-beginning \\\n  --max-messages 1\n\n# Latest messages\ndocker-compose exec kafka kafka-console-consumer \\\n  --bootstrap-server localhost:9092 \\\n  --topic crm.crm.customers \\\n  --max-messages 5\n</code></pre>"},{"location":"api/cdc-health/#monitoring-dashboard","title":"Monitoring Dashboard","text":""},{"location":"api/cdc-health/#kafka-ui","title":"Kafka UI","text":"<ul> <li>URL: http://localhost:8084</li> <li>Features:</li> <li>Topic list and messages</li> <li>Consumer groups</li> <li>Connector status</li> </ul>"},{"location":"api/cdc-health/#health-check-script","title":"Health Check Script","text":"<pre><code>#!/bin/bash\n# scripts/check-cdc.sh\n\necho \"=== CDC Health Check ===\"\n\necho -e \"\\n1. Debezium Connector Status:\"\ncurl -s http://localhost:8083/connectors/crm-connector/status | jq .\n\necho -e \"\\n2. Kafka Topics:\"\ndocker-compose exec -T kafka kafka-topics \\\n  --bootstrap-server localhost:9092 --list 2&gt;/dev/null | grep crm\n\necho -e \"\\n3. ClickHouse CDC Tables:\"\ncurl -s \"http://localhost:8123/\" -d \"\nSELECT 'customers' as t, count() as c FROM reports.crm_customers FINAL WHERE _deleted=0\nUNION ALL SELECT 'prostheses', count() FROM reports.crm_prostheses FINAL WHERE _deleted=0\nUNION ALL SELECT 'models', count() FROM reports.crm_prosthesis_models FINAL WHERE _deleted=0\nFORMAT Pretty\n\"\n\necho -e \"\\n4. Reports Service CDC Health:\"\ncurl -s http://localhost:8001/health/cdc | jq .\n</code></pre>"},{"location":"api/cdc-health/#troubleshooting","title":"Troubleshooting","text":""},{"location":"api/cdc-health/#debezium","title":"Debezium \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043b\u043e\u0433\u0438\ndocker-compose logs debezium\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u0435 \u043a PostgreSQL\ndocker-compose exec debezium curl -s http://localhost:8083/connectors/crm-connector/status\n</code></pre>"},{"location":"api/cdc-health/#kafka-lag","title":"\u0412\u044b\u0441\u043e\u043a\u0438\u0439 Kafka lag","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c consumer groups\ndocker-compose exec kafka kafka-consumer-groups \\\n  --bootstrap-server localhost:9092 \\\n  --describe --all-groups\n\n# \u041f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c ClickHouse consumers\n# (\u043f\u0435\u0440\u0435\u0441\u043e\u0437\u0434\u0430\u0442\u044c KafkaEngine \u0442\u0430\u0431\u043b\u0438\u0446\u044b)\n</code></pre>"},{"location":"api/cdc-health/#_2","title":"\u0414\u0430\u043d\u043d\u044b\u0435 \u043d\u0435 \u043f\u043e\u044f\u0432\u043b\u044f\u044e\u0442\u0441\u044f","text":"<pre><code># 1. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c Kafka\ndocker-compose exec kafka kafka-console-consumer \\\n  --bootstrap-server localhost:9092 \\\n  --topic crm.crm.customers \\\n  --from-beginning --max-messages 1\n\n# 2. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c ClickHouse\ncurl \"http://localhost:8123/\" -d \"SELECT * FROM system.kafka_consumers\"\n\n# 3. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c materialized views\ncurl \"http://localhost:8123/\" -d \"\nSELECT\n    name,\n    total_rows,\n    bytes_on_disk\nFROM system.tables\nWHERE database = 'reports' AND engine LIKE '%View%'\n\"\n</code></pre>"},{"location":"api/cdc-health/#_3","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture: CDC Pipeline</li> <li>Reports API</li> <li>Troubleshooting</li> </ul>"},{"location":"api/reports/","title":"Reports API","text":""},{"location":"api/reports/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>Reports Service \u043f\u0440\u0435\u0434\u043e\u0441\u0442\u0430\u0432\u043b\u044f\u0435\u0442 REST API \u0434\u043b\u044f \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u043e \u0440\u0430\u0431\u043e\u0442\u0435 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432.</p> <p>Base URL: <code>http://localhost:8001</code></p>"},{"location":"api/reports/#_2","title":"\u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f","text":"<p>\u0412\u0441\u0435 endpoints (\u043a\u0440\u043e\u043c\u0435 health) \u0442\u0440\u0435\u0431\u0443\u044e\u0442 JWT \u0442\u043e\u043a\u0435\u043d \u0432 \u0437\u0430\u0433\u043e\u043b\u043e\u0432\u043a\u0435:</p> <pre><code>Authorization: Bearer &lt;access_token&gt;\n</code></pre> <p>\u0422\u043e\u043a\u0435\u043d \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043f\u0435\u0440\u0435\u0434\u0430\u0451\u0442\u0441\u044f \u0447\u0435\u0440\u0435\u0437 BFF \u043f\u0440\u0438 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 Frontend.</p>"},{"location":"api/reports/#endpoints","title":"Endpoints","text":""},{"location":"api/reports/#health-check","title":"Health Check","text":""},{"location":"api/reports/#get-health","title":"GET /health","text":"<p>\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0440\u0430\u0431\u043e\u0442\u043e\u0441\u043f\u043e\u0441\u043e\u0431\u043d\u043e\u0441\u0442\u0438 \u0441\u0435\u0440\u0432\u0438\u0441\u0430.</p> <p>Request: <pre><code>GET /health HTTP/1.1\nHost: localhost:8001\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"status\": \"healthy\",\n  \"version\": \"1.0.0\"\n}\n</code></pre></p>"},{"location":"api/reports/#get-healthlive","title":"GET /health/live","text":"<p>Liveness probe \u0434\u043b\u044f Kubernetes.</p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"status\": \"live\"\n}\n</code></pre></p>"},{"location":"api/reports/#get-healthcdc","title":"GET /health/cdc","text":"<p>\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 CDC pipeline.</p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"status\": \"healthy\",\n  \"cdc_tables\": {\n    \"crm_customers\": {\"rows\": 5, \"last_update\": \"2024-01-15T10:30:00Z\"},\n    \"crm_prostheses\": {\"rows\": 5},\n    \"crm_prosthesis_models\": {\"rows\": 5}\n  },\n  \"kafka_lag\": {\n    \"crm.crm.customers\": 0\n  }\n}\n</code></pre></p>"},{"location":"api/reports/#reports","title":"Reports","text":""},{"location":"api/reports/#get-apireports","title":"GET /api/reports","text":"<p>\u0421\u043f\u0438\u0441\u043e\u043a \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f.</p> <p>Request: <pre><code>GET /api/reports HTTP/1.1\nHost: localhost:8001\nAuthorization: Bearer &lt;token&gt;\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"reports\": [\n    {\"date\": \"2024-01-15\"},\n    {\"date\": \"2024-01-14\"},\n    {\"date\": \"2024-01-13\"}\n  ],\n  \"total\": 3,\n  \"user\": \"ivan.petrov\"\n}\n</code></pre></p>"},{"location":"api/reports/#get-apireportssummary","title":"GET /api/reports/summary","text":"<p>\u0421\u0432\u043e\u0434\u043d\u0430\u044f \u0441\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f.</p> <p>Request: <pre><code>GET /api/reports/summary HTTP/1.1\nHost: localhost:8001\nAuthorization: Bearer &lt;token&gt;\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"user\": \"ivan.petrov\",\n  \"prosthesis_model\": \"BionicHand Pro X1\",\n  \"total_days\": 30,\n  \"summary\": {\n    \"total_movements\": 45230,\n    \"avg_response_time_ms\": 44.5,\n    \"avg_battery_level\": 75.2,\n    \"total_errors\": 12,\n    \"avg_daily_usage_hours\": 12.5\n  }\n}\n</code></pre></p>"},{"location":"api/reports/#get-apireportsdate","title":"GET /api/reports/{date}","text":"<p>\u0414\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0451\u0442 \u0437\u0430 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u0443\u044e \u0434\u0430\u0442\u0443.</p> <p>Parameters: - <code>date</code> (path) - \u0434\u0430\u0442\u0430 \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 YYYY-MM-DD</p> <p>Request: <pre><code>GET /api/reports/2024-01-15 HTTP/1.1\nHost: localhost:8001\nAuthorization: Bearer &lt;token&gt;\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"date\": \"2024-01-15\",\n  \"user\": \"ivan.petrov\",\n  \"prosthesis_model\": \"BionicHand Pro X1\",\n  \"chip_id\": \"CHIP-001-2024\",\n  \"summary\": {\n    \"total_movements\": 1523,\n    \"avg_response_time_ms\": 45.2,\n    \"avg_battery_level\": 78.5,\n    \"total_errors\": 3,\n    \"uptime_hours\": 14\n  },\n  \"hourly_data\": [\n    {\n      \"hour\": \"2024-01-15T08:00:00Z\",\n      \"movements_count\": 145,\n      \"avg_response_time\": 42.1,\n      \"battery_level\": 95.0,\n      \"error_count\": 0\n    },\n    {\n      \"hour\": \"2024-01-15T09:00:00Z\",\n      \"movements_count\": 189,\n      \"avg_response_time\": 44.3,\n      \"battery_level\": 92.0,\n      \"error_count\": 1\n    }\n  ]\n}\n</code></pre></p> <p>Response <code>404 Not Found</code>: <pre><code>{\n  \"detail\": \"Report not found for date 2024-01-15\"\n}\n</code></pre></p>"},{"location":"api/reports/#cdn-endpoints","title":"CDN Endpoints","text":""},{"location":"api/reports/#get-apireportscdnlist","title":"GET /api/reports/cdn/list","text":"<p>\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c CDN URL \u0434\u043b\u044f \u0441\u043f\u0438\u0441\u043a\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432.</p> <p>Request: <pre><code>GET /api/reports/cdn/list HTTP/1.1\nHost: localhost:8001\nAuthorization: Bearer &lt;token&gt;\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"cdn_url\": \"http://localhost:8002/reports/550e8400.../list/reports.json\",\n  \"expires_in\": 300\n}\n</code></pre></p>"},{"location":"api/reports/#get-apireportscdnsummary","title":"GET /api/reports/cdn/summary","text":"<p>\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c CDN URL \u0434\u043b\u044f \u0441\u0432\u043e\u0434\u043a\u0438.</p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"cdn_url\": \"http://localhost:8002/reports/550e8400.../summary/summary.json\"\n}\n</code></pre></p>"},{"location":"api/reports/#get-apireportscdndate","title":"GET /api/reports/cdn/{date}","text":"<p>\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c CDN URL \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u0430 \u0437\u0430 \u0434\u0430\u0442\u0443.</p> <p>Parameters: - <code>date</code> (path) - \u0434\u0430\u0442\u0430 \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 YYYY-MM-DD</p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"cdn_url\": \"http://localhost:8002/reports/550e8400.../daily/2024-01-15/report.json\",\n  \"date\": \"2024-01-15\"\n}\n</code></pre></p>"},{"location":"api/reports/#cache-management","title":"Cache Management","text":""},{"location":"api/reports/#post-apireportsinvalidate","title":"POST /api/reports/invalidate","text":"<p>\u0418\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u043a\u044d\u0448\u0430 (\u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440\u043e\u0432).</p> <p>Request: <pre><code>POST /api/reports/invalidate HTTP/1.1\nHost: localhost:8001\nAuthorization: Bearer &lt;admin_token&gt;\nContent-Type: application/json\n\n{\n  \"user_id\": \"550e8400-e29b-41d4-a716-446655440000\"\n}\n</code></pre></p> <p>Response <code>200 OK</code>: <pre><code>{\n  \"status\": \"invalidated\",\n  \"user_id\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"cleared\": {\n    \"s3_objects\": 5,\n    \"redis_keys\": 3\n  }\n}\n</code></pre></p>"},{"location":"api/reports/#_3","title":"\u041a\u043e\u0434\u044b \u043e\u0442\u0432\u0435\u0442\u043e\u0432","text":"Code \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 200 \u0423\u0441\u043f\u0435\u0448\u043d\u044b\u0439 \u0437\u0430\u043f\u0440\u043e\u0441 401 \u041d\u0435 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u043e\u0432\u0430\u043d (\u043e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u0435\u0442 \u0438\u043b\u0438 \u043d\u0435\u0432\u0430\u043b\u0438\u0434\u043d\u044b\u0439 \u0442\u043e\u043a\u0435\u043d) 403 \u0414\u043e\u0441\u0442\u0443\u043f \u0437\u0430\u043f\u0440\u0435\u0449\u0451\u043d (\u043d\u0435\u0442 \u043f\u0440\u0430\u0432) 404 \u041e\u0442\u0447\u0451\u0442 \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d 500 \u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044f\u044f \u043e\u0448\u0438\u0431\u043a\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430"},{"location":"api/reports/#_4","title":"\u041f\u0440\u0438\u043c\u0435\u0440\u044b \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u044f","text":""},{"location":"api/reports/#curl","title":"cURL","text":"<pre><code># \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0442\u043e\u043a\u0435\u043d \u0447\u0435\u0440\u0435\u0437 BFF (cookie-based)\n# \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u0434\u043b\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438\n\n# \u041f\u0440\u044f\u043c\u043e\u0439 \u0437\u0430\u043f\u0440\u043e\u0441 \u0441 \u0442\u043e\u043a\u0435\u043d\u043e\u043c\ncurl -H \"Authorization: Bearer $TOKEN\" \\\n  http://localhost:8001/api/reports\n\n# \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u043e\u0442\u0447\u0451\u0442 \u0437\u0430 \u0434\u0430\u0442\u0443\ncurl -H \"Authorization: Bearer $TOKEN\" \\\n  http://localhost:8001/api/reports/2024-01-15\n</code></pre>"},{"location":"api/reports/#python","title":"Python","text":"<pre><code>import requests\n\nBASE_URL = \"http://localhost:8001\"\nTOKEN = \"your-jwt-token\"\n\nheaders = {\"Authorization\": f\"Bearer {TOKEN}\"}\n\n# \u0421\u043f\u0438\u0441\u043e\u043a \u043e\u0442\u0447\u0451\u0442\u043e\u0432\nresponse = requests.get(f\"{BASE_URL}/api/reports\", headers=headers)\nreports = response.json()\n\n# \u0414\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0451\u0442\ndate = reports[\"reports\"][0][\"date\"]\nresponse = requests.get(f\"{BASE_URL}/api/reports/{date}\", headers=headers)\nreport = response.json()\n</code></pre>"},{"location":"api/reports/#javascript","title":"JavaScript","text":"<pre><code>const BASE_URL = 'http://localhost:8001';\nconst token = 'your-jwt-token';\n\n// \u0421\u043f\u0438\u0441\u043e\u043a \u043e\u0442\u0447\u0451\u0442\u043e\u0432\nconst response = await fetch(`${BASE_URL}/api/reports`, {\n  headers: { 'Authorization': `Bearer ${token}` }\n});\nconst reports = await response.json();\n\n// \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 CDN URL\nconst cdnResponse = await fetch(`${BASE_URL}/api/reports/cdn/list`, {\n  headers: { 'Authorization': `Bearer ${token}` }\n});\nconst { cdn_url } = await cdnResponse.json();\n\n// \u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u043e\u0442\u0447\u0451\u0442\u0430 \u0447\u0435\u0440\u0435\u0437 CDN\nconst reportData = await fetch(cdn_url).then(r =&gt; r.json());\n</code></pre>"},{"location":"api/reports/#openapi-specification","title":"OpenAPI Specification","text":"<p>\u041f\u043e\u043b\u043d\u0430\u044f \u0441\u043f\u0435\u0446\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u0430 \u043f\u043e \u0430\u0434\u0440\u0435\u0441\u0443:</p> <ul> <li>Swagger UI: http://localhost:8001/docs</li> <li>ReDoc: http://localhost:8001/redoc</li> <li>OpenAPI JSON: http://localhost:8001/openapi.json</li> </ul>"},{"location":"api/reports/#_5","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture: Reports &amp; ETL</li> <li>Architecture: S3/CDN</li> <li>Auth API</li> </ul>"},{"location":"architecture/cdc/","title":"CDC Pipeline Architecture (Task 4)","text":""},{"location":"architecture/cdc/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u0417\u0430\u0434\u0430\u043d\u0438\u0435 4 \u0440\u0435\u0430\u043b\u0438\u0437\u0443\u0435\u0442 Change Data Capture (CDC) \u0434\u043b\u044f \u0440\u0430\u0437\u0434\u0435\u043b\u0435\u043d\u0438\u044f OLTP/OLAP \u043d\u0430\u0433\u0440\u0443\u0437\u043e\u043a \u0438 \u043f\u043e\u0432\u044b\u0448\u0435\u043d\u0438\u044f \u0441\u0442\u0430\u0431\u0438\u043b\u044c\u043d\u043e\u0441\u0442\u0438 \u0440\u0430\u0431\u043e\u0442\u044b CRM.</p>"},{"location":"architecture/cdc/#_2","title":"\u0420\u0435\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Debezium PostgreSQL CDC \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440 \u0434\u043b\u044f CRM \u0431\u0430\u0437\u044b \u0434\u0430\u043d\u043d\u044b\u0445 Kafka Message broker \u0434\u043b\u044f \u043f\u043e\u0442\u043e\u043a\u0430 CDC \u0441\u043e\u0431\u044b\u0442\u0438\u0439 ClickHouse KafkaEngine \u041f\u0440\u044f\u043c\u043e\u0439 \u043f\u0440\u0438\u0451\u043c \u0434\u0430\u043d\u043d\u044b\u0445 \u0438\u0437 Kafka \u0442\u043e\u043f\u0438\u043a\u043e\u0432 MaterializedViews \u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u0442\u0440\u0430\u043d\u0441\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445 CDC ETL DAG \u041c\u043e\u0434\u0438\u0444\u0438\u0446\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0439 pipeline, \u0447\u0438\u0442\u0430\u044e\u0449\u0438\u0439 \u0438\u0437 ClickHouse"},{"location":"architecture/cdc/#_3","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043d\u0430\u044f \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430","text":"<pre><code>graph TB\n    subgraph \"OLTP Layer\"\n        CRM_USER[\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 CRM]\n        CRM[(CRM PostgreSQL&lt;br/&gt;wal_level=logical)]\n    end\n\n    subgraph \"CDC Pipeline\"\n        DBZ[Debezium Connect&lt;br/&gt;:8083]\n        KFK[Apache Kafka&lt;br/&gt;:9092]\n        ZK[Zookeeper&lt;br/&gt;:2181]\n    end\n\n    subgraph \"OLAP Layer\"\n        CH[(ClickHouse&lt;br/&gt;KafkaEngine + MergeTree)]\n    end\n\n    subgraph \"Reports\"\n        RS[Reports Service]\n        U[\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c]\n    end\n\n    subgraph \"Telemetry ETL\"\n        AF[Airflow]\n        TEL[(Telemetry DB)]\n    end\n\n    CRM_USER --&gt;|OLTP \u043e\u043f\u0435\u0440\u0430\u0446\u0438\u0438| CRM\n    CRM --&gt;|1. WAL \u0441\u043e\u0431\u044b\u0442\u0438\u044f| DBZ\n    DBZ --&gt;|2. CDC events| KFK\n    ZK ---|\u041a\u043e\u043e\u0440\u0434\u0438\u043d\u0430\u0446\u0438\u044f| KFK\n    KFK --&gt;|3. Consume| CH\n    CH --&gt; RS\n    RS --&gt; U\n\n    AF --&gt;|ETL| TEL\n    AF --&gt;|JOIN| CH</code></pre>"},{"location":"architecture/cdc/#cdc-data-flow","title":"CDC Data Flow","text":"<pre><code>sequenceDiagram\n    participant CRM as CRM PostgreSQL\n    participant WAL as WAL (logical)\n    participant DBZ as Debezium\n    participant KFK as Kafka\n    participant KE as KafkaEngine\n    participant MV as MaterializedView\n    participant TT as Target Table\n\n    Note over CRM,TT: Real-time CDC Pipeline\n\n    CRM-&gt;&gt;WAL: 1. INSERT/UPDATE/DELETE\n    WAL-&gt;&gt;DBZ: 2. Logical replication\n    DBZ-&gt;&gt;DBZ: 3. Transform to Debezium format\n    DBZ-&gt;&gt;KFK: 4. Publish to topic&lt;br/&gt;crm.crm.customers\n    KFK-&gt;&gt;KE: 5. KafkaEngine pulls\n    KE-&gt;&gt;MV: 6. Trigger MaterializedView\n    MV-&gt;&gt;TT: 7. INSERT to target&lt;br/&gt;(ReplacingMergeTree)</code></pre>"},{"location":"architecture/cdc/#postgresql-cdc-setup","title":"PostgreSQL CDC Setup","text":""},{"location":"architecture/cdc/#wal-configuration","title":"WAL Configuration","text":"<pre><code># docker-compose.yaml\ncrm_db:\n  image: postgres:14\n  command:\n    - \"postgres\"\n    - \"-c\"\n    - \"wal_level=logical\"          # \u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c logical replication\n    - \"-c\"\n    - \"max_wal_senders=4\"          # \u041c\u0430\u043a\u0441. \u043f\u0430\u0440\u0430\u043b\u043b\u0435\u043b\u044c\u043d\u044b\u0445 \u043e\u0442\u043f\u0440\u0430\u0432\u0438\u0442\u0435\u043b\u0435\u0439\n    - \"-c\"\n    - \"max_replication_slots=4\"    # \u041c\u0430\u043a\u0441. \u0441\u043b\u043e\u0442\u043e\u0432 \u0440\u0435\u043f\u043b\u0438\u043a\u0430\u0446\u0438\u0438\n</code></pre>"},{"location":"architecture/cdc/#replication-user","title":"Replication User","text":"<pre><code>-- databases/crm_db_cdc_setup.sql\nCREATE USER debezium_user WITH REPLICATION PASSWORD 'debezium_password';\n\nGRANT SELECT ON ALL TABLES IN SCHEMA crm TO debezium_user;\nGRANT USAGE ON SCHEMA crm TO debezium_user;\n\n-- \u041f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u044f \u0434\u043b\u044f Debezium\nCREATE PUBLICATION crm_publication FOR TABLE\n    crm.customers,\n    crm.prostheses,\n    crm.prosthesis_models;\n</code></pre>"},{"location":"architecture/cdc/#debezium-configuration","title":"Debezium Configuration","text":""},{"location":"architecture/cdc/#connector-registration","title":"Connector Registration","text":"<pre><code>// debezium/crm-connector.json\n{\n  \"name\": \"crm-connector\",\n  \"config\": {\n    \"connector.class\": \"io.debezium.connector.postgresql.PostgresConnector\",\n    \"database.hostname\": \"crm_db\",\n    \"database.port\": \"5432\",\n    \"database.user\": \"debezium_user\",\n    \"database.password\": \"debezium_password\",\n    \"database.dbname\": \"crm_db\",\n    \"database.server.name\": \"crm\",\n    \"schema.include.list\": \"crm\",\n    \"table.include.list\": \"crm.customers,crm.prostheses,crm.prosthesis_models\",\n    \"plugin.name\": \"pgoutput\",\n    \"publication.name\": \"crm_publication\",\n    \"slot.name\": \"debezium_crm_slot\",\n    \"topic.prefix\": \"crm\",\n    \"key.converter\": \"org.apache.kafka.connect.json.JsonConverter\",\n    \"value.converter\": \"org.apache.kafka.connect.json.JsonConverter\",\n    \"key.converter.schemas.enable\": \"false\",\n    \"value.converter.schemas.enable\": \"false\",\n    \"transforms\": \"unwrap\",\n    \"transforms.unwrap.type\": \"io.debezium.transforms.ExtractNewRecordState\",\n    \"transforms.unwrap.drop.tombstones\": \"true\"\n  }\n}\n</code></pre>"},{"location":"architecture/cdc/#debezium-event-format","title":"Debezium Event Format","text":"<pre><code>{\n  \"before\": null,\n  \"after\": {\n    \"id\": \"550e8400-e29b-41d4-a716-446655440000\",\n    \"name\": \"Ivan Petrov\",\n    \"email\": \"ivan.petrov@bionicpro.com\",\n    \"ldap_username\": \"ivan.petrov\",\n    \"created_at\": 1704067200000,\n    \"updated_at\": 1704070800000\n  },\n  \"source\": {\n    \"version\": \"2.4.0.Final\",\n    \"connector\": \"postgresql\",\n    \"name\": \"crm\",\n    \"ts_ms\": 1704070800000,\n    \"db\": \"crm_db\",\n    \"schema\": \"crm\",\n    \"table\": \"customers\"\n  },\n  \"op\": \"c\",  // c=create, u=update, d=delete, r=read (snapshot)\n  \"ts_ms\": 1704070800000\n}\n</code></pre>"},{"location":"architecture/cdc/#kafka-configuration","title":"Kafka Configuration","text":""},{"location":"architecture/cdc/#topics","title":"Topics","text":"Topic \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Partitions Retention <code>crm.crm.customers</code> \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043a\u043b\u0438\u0435\u043d\u0442\u043e\u0432 3 7 days <code>crm.crm.prostheses</code> \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 3 7 days <code>crm.crm.prosthesis_models</code> \u0418\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u043c\u043e\u0434\u0435\u043b\u0435\u0439 1 7 days"},{"location":"architecture/cdc/#docker-configuration","title":"Docker Configuration","text":"<pre><code>kafka:\n  image: confluentinc/cp-kafka:7.5.0\n  environment:\n    KAFKA_BROKER_ID: 1\n    KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181\n    KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092\n    KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1\n    KAFKA_AUTO_CREATE_TOPICS_ENABLE: \"true\"\n</code></pre>"},{"location":"architecture/cdc/#clickhouse-cdc-tables","title":"ClickHouse CDC Tables","text":""},{"location":"architecture/cdc/#kafkaengine-tables","title":"KafkaEngine Tables","text":"<pre><code>-- clickhouse/init/02_cdc_kafka_tables.sql\n\n-- Kafka Engine table for customers\nCREATE TABLE IF NOT EXISTS reports.kafka_crm_customers (\n    id UUID,\n    name String,\n    email String,\n    ldap_username String,\n    created_at DateTime64(3),\n    updated_at DateTime64(3),\n    __op String,\n    __source_ts_ms Int64\n)\nENGINE = Kafka()\nSETTINGS\n    kafka_broker_list = 'kafka:29092',\n    kafka_topic_list = 'crm.crm.customers',\n    kafka_group_name = 'clickhouse_customers',\n    kafka_format = 'JSONEachRow',\n    kafka_num_consumers = 1,\n    kafka_skip_broken_messages = 100;\n</code></pre>"},{"location":"architecture/cdc/#target-tables-replacingmergetree","title":"Target Tables (ReplacingMergeTree)","text":"<pre><code>-- Target table with deduplication\nCREATE TABLE IF NOT EXISTS reports.crm_customers (\n    id UUID,\n    name String,\n    email String,\n    ldap_username String,\n    created_at DateTime64(3),\n    updated_at DateTime64(3),\n    _version UInt64,\n    _deleted UInt8 DEFAULT 0\n)\nENGINE = ReplacingMergeTree(_version)\nORDER BY id;\n</code></pre>"},{"location":"architecture/cdc/#materialized-views","title":"Materialized Views","text":"<pre><code>-- Auto-insert from Kafka to target table\nCREATE MATERIALIZED VIEW IF NOT EXISTS reports.mv_kafka_customers\nTO reports.crm_customers\nAS SELECT\n    id,\n    name,\n    email,\n    ldap_username,\n    created_at,\n    updated_at,\n    __source_ts_ms as _version,\n    CASE WHEN __op = 'd' THEN 1 ELSE 0 END as _deleted\nFROM reports.kafka_crm_customers;\n</code></pre>"},{"location":"architecture/cdc/#cdc-data-mart-view","title":"CDC Data Mart View","text":"<pre><code>-- Joined view for reports\nCREATE VIEW IF NOT EXISTS reports.cdc_customer_data AS\nSELECT\n    c.id as customer_id,\n    c.name as customer_name,\n    c.email as customer_email,\n    c.ldap_username,\n    p.id as prosthesis_id,\n    p.chip_id,\n    m.name as prosthesis_model\nFROM reports.crm_customers c FINAL\nJOIN reports.crm_prostheses p FINAL ON c.id = p.customer_id\nJOIN reports.crm_prosthesis_models m FINAL ON p.model_id = m.id\nWHERE c._deleted = 0 AND p._deleted = 0;\n</code></pre>"},{"location":"architecture/cdc/#hybrid-architecture","title":"Hybrid Architecture","text":""},{"location":"architecture/cdc/#crm-data-cdc-real-time","title":"CRM Data: CDC (Real-time)","text":"<pre><code>CRM PostgreSQL \u2192 Debezium \u2192 Kafka \u2192 ClickHouse (KafkaEngine)\nLatency: &lt; 1 second\n</code></pre>"},{"location":"architecture/cdc/#telemetry-data-etl-batch","title":"Telemetry Data: ETL (Batch)","text":"<pre><code>Telemetry PostgreSQL \u2192 Airflow ETL (\u043a\u0430\u0436\u0434\u044b\u0435 15 \u043c\u0438\u043d) \u2192 ClickHouse\nLatency: up to 15 minutes\n</code></pre>"},{"location":"architecture/cdc/#reports-mart-join","title":"Reports Mart: JOIN","text":"<pre><code>-- user_prosthesis_stats \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u0435\u0442\u0441\u044f \u0438\u0437:\n-- 1. CDC \u0434\u0430\u043d\u043d\u044b\u0445 (crm_customers, crm_prostheses, crm_prosthesis_models)\n-- 2. ETL \u0434\u0430\u043d\u043d\u044b\u0445 (telemetry aggregates)\n</code></pre>"},{"location":"architecture/cdc/#cdc-etl-dag","title":"CDC ETL DAG","text":"<pre><code># airflow/dags/bionicpro_reports_cdc_etl.py\n\nwith DAG(\n    dag_id='bionicpro_reports_cdc_etl',\n    schedule_interval='*/15 * * * *',\n) as dag:\n\n    # \u0427\u0438\u0442\u0430\u0435\u043c CRM \u0434\u0430\u043d\u043d\u044b\u0435 \u0438\u0437 ClickHouse (\u043d\u0435 \u0438\u0437 PostgreSQL!)\n    extract_crm_from_ch = PythonOperator(\n        task_id='extract_crm_from_clickhouse',\n        python_callable=extract_crm_from_clickhouse,\n    )\n\n    extract_telemetry = PythonOperator(\n        task_id='extract_telemetry_data',\n        python_callable=extract_telemetry_data,\n    )\n\n    transform_and_join = PythonOperator(\n        task_id='transform_and_join',\n        python_callable=transform_and_join,\n    )\n\n    load = PythonOperator(\n        task_id='load_to_clickhouse',\n        python_callable=load_to_clickhouse,\n    )\n\n    [extract_crm_from_ch, extract_telemetry] &gt;&gt; transform_and_join &gt;&gt; load\n</code></pre>"},{"location":"architecture/cdc/#benefits-of-cdc","title":"Benefits of CDC","text":""},{"location":"architecture/cdc/#for-crm-oltp","title":"For CRM (OLTP)","text":"\u0410\u0441\u043f\u0435\u043a\u0442 \u0414\u043e CDC \u041f\u043e\u0441\u043b\u0435 CDC ETL \u043d\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0422\u044f\u0436\u0451\u043b\u044b\u0435 SELECT \u043a\u0430\u0436\u0434\u044b\u0435 15 \u043c\u0438\u043d \u041d\u0435\u0442 \u043d\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u0411\u043b\u043e\u043a\u0438\u0440\u043e\u0432\u043a\u0438 \u0412\u043e\u0437\u043c\u043e\u0436\u043d\u044b \u043f\u0440\u0438 \u0431\u043e\u043b\u044c\u0448\u0438\u0445 \u0432\u044b\u0433\u0440\u0443\u0437\u043a\u0430\u0445 \u041e\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044e\u0442 \u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c \u0414\u0435\u0433\u0440\u0430\u0434\u0430\u0446\u0438\u044f \u043f\u0440\u0438 ETL \u0421\u0442\u0430\u0431\u0438\u043b\u044c\u043d\u0430\u044f"},{"location":"architecture/cdc/#for-reports-olap","title":"For Reports (OLAP)","text":"\u0410\u0441\u043f\u0435\u043a\u0442 \u0414\u043e CDC \u041f\u043e\u0441\u043b\u0435 CDC \u0417\u0430\u0434\u0435\u0440\u0436\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0414\u043e 15 \u043c\u0438\u043d\u0443\u0442 &lt; 1 \u0441\u0435\u043a\u0443\u043d\u0434\u044b \u0410\u043a\u0442\u0443\u0430\u043b\u044c\u043d\u043e\u0441\u0442\u044c Batch updates Near real-time \u041d\u0430\u0434\u0451\u0436\u043d\u043e\u0441\u0442\u044c \u0417\u0430\u0432\u0438\u0441\u0438\u0442 \u043e\u0442 CRM \u041d\u0435\u0437\u0430\u0432\u0438\u0441\u0438\u043c\u043e \u043e\u0442 CRM"},{"location":"architecture/cdc/#monitoring","title":"Monitoring","text":""},{"location":"architecture/cdc/#debezium-status","title":"Debezium Status","text":"<pre><code># List connectors\ncurl http://localhost:8083/connectors\n\n# Connector status\ncurl http://localhost:8083/connectors/crm-connector/status\n\n# Connector tasks\ncurl http://localhost:8083/connectors/crm-connector/tasks/0/status\n</code></pre>"},{"location":"architecture/cdc/#kafka-ui","title":"Kafka UI","text":"<ul> <li>URL: http://localhost:8084</li> <li>Topics: crm.crm.*</li> <li>Consumer groups: clickhouse_*</li> </ul>"},{"location":"architecture/cdc/#clickhouse-cdc-health","title":"ClickHouse CDC Health","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 CDC \u0442\u0430\u0431\u043b\u0438\u0446\ncurl http://localhost:8001/health/cdc\n</code></pre> <p>Response:</p> <pre><code>{\n  \"status\": \"healthy\",\n  \"cdc_tables\": {\n    \"crm_customers\": {\"rows\": 5, \"last_update\": \"2024-01-15T10:30:00Z\"},\n    \"crm_prostheses\": {\"rows\": 5, \"last_update\": \"2024-01-15T10:30:00Z\"},\n    \"crm_prosthesis_models\": {\"rows\": 5, \"last_update\": \"2024-01-15T10:30:00Z\"}\n  },\n  \"kafka_lag\": {\n    \"crm.crm.customers\": 0,\n    \"crm.crm.prostheses\": 0\n  }\n}\n</code></pre>"},{"location":"architecture/cdc/#troubleshooting","title":"Troubleshooting","text":""},{"location":"architecture/cdc/#debezium","title":"Debezium \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043b\u043e\u0433\u0438\ndocker-compose logs debezium\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c WAL level\ndocker-compose exec crm_db psql -U crm_user -d crm_db \\\n  -c \"SHOW wal_level;\"  # \u0414\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c 'logical'\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c replication slot\ndocker-compose exec crm_db psql -U crm_user -d crm_db \\\n  -c \"SELECT * FROM pg_replication_slots;\"\n</code></pre>"},{"location":"architecture/cdc/#clickhouse","title":"\u0414\u0430\u043d\u043d\u044b\u0435 \u043d\u0435 \u043f\u043e\u044f\u0432\u043b\u044f\u044e\u0442\u0441\u044f \u0432 ClickHouse","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c Kafka \u0442\u043e\u043f\u0438\u043a\u0438\ndocker-compose exec kafka kafka-console-consumer \\\n  --bootstrap-server localhost:9092 \\\n  --topic crm.crm.customers \\\n  --from-beginning --max-messages 1\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c KafkaEngine\ncurl \"http://localhost:8123/\" -d \"SELECT * FROM system.kafka_consumers\"\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c CDC \u0442\u0430\u0431\u043b\u0438\u0446\u044b\ncurl \"http://localhost:8123/\" -d \"SELECT count() FROM reports.crm_customers\"\n</code></pre>"},{"location":"architecture/cdc/#connector-failed","title":"Connector failed","text":"<pre><code># \u041f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u043a \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440\u0430\ncurl -X POST http://localhost:8083/connectors/crm-connector/restart\n\n# \u0423\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0438 \u043f\u043e\u0432\u0442\u043e\u0440\u043d\u0430\u044f \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f\ncurl -X DELETE http://localhost:8083/connectors/crm-connector\ncurl -X POST -H \"Content-Type: application/json\" \\\n  --data @debezium/crm-connector.json \\\n  http://localhost:8083/connectors\n</code></pre>"},{"location":"architecture/cdc/#debezium-admin-api","title":"Debezium Admin API","text":"Method Endpoint \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 GET <code>/connectors</code> \u0421\u043f\u0438\u0441\u043e\u043a \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440\u043e\u0432 GET <code>/connectors/{name}/status</code> \u0421\u0442\u0430\u0442\u0443\u0441 \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440\u0430 PUT <code>/connectors/{name}/pause</code> \u041f\u0440\u0438\u043e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c PUT <code>/connectors/{name}/resume</code> \u0412\u043e\u0437\u043e\u0431\u043d\u043e\u0432\u0438\u0442\u044c POST <code>/connectors/{name}/restart</code> \u041f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c DELETE <code>/connectors/{name}</code> \u0423\u0434\u0430\u043b\u0438\u0442\u044c"},{"location":"architecture/cdc/#_4","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture Overview</li> <li>Reports &amp; ETL</li> <li>CDC Health API</li> </ul>"},{"location":"architecture/data-model/","title":"Data Model","text":""},{"location":"architecture/data-model/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u0421\u0438\u0441\u0442\u0435\u043c\u0430 BionicPRO \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 \u0433\u0438\u0431\u0440\u0438\u0434\u043d\u0443\u044e \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0443 \u0434\u0430\u043d\u043d\u044b\u0445:</p> <ul> <li>OLTP (PostgreSQL): CRM \u0434\u0430\u043d\u043d\u044b\u0435, \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u044f</li> <li>OLAP (ClickHouse): \u0412\u0438\u0442\u0440\u0438\u043d\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432, CDC \u0434\u0430\u043d\u043d\u044b\u0435</li> <li>Object Storage (MinIO S3): \u041a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u043e\u0442\u0447\u0451\u0442\u044b</li> </ul>"},{"location":"architecture/data-model/#oltp-layer-postgresql","title":"OLTP Layer (PostgreSQL)","text":""},{"location":"architecture/data-model/#crm-database","title":"CRM Database","text":"<pre><code>erDiagram\n    customers ||--o{ prostheses : has\n    prosthesis_models ||--o{ prostheses : defines\n\n    customers {\n        uuid id PK\n        string name\n        string email\n        string ldap_username UK\n        string phone\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    prostheses {\n        uuid id PK\n        uuid customer_id FK\n        uuid model_id FK\n        string chip_id UK\n        string serial_number\n        date manufacture_date\n        timestamp created_at\n        timestamp updated_at\n    }\n\n    prosthesis_models {\n        uuid id PK\n        string name\n        string description\n        int warranty_years\n        timestamp created_at\n    }</code></pre>"},{"location":"architecture/data-model/#sql-schema","title":"SQL Schema","text":"<pre><code>-- databases/crm_db_init.sql\n\nCREATE SCHEMA IF NOT EXISTS crm;\n\nCREATE TABLE crm.customers (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name VARCHAR(255) NOT NULL,\n    email VARCHAR(255) NOT NULL UNIQUE,\n    ldap_username VARCHAR(100) UNIQUE,\n    phone VARCHAR(50),\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE TABLE crm.prosthesis_models (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    name VARCHAR(255) NOT NULL,\n    description TEXT,\n    warranty_years INTEGER DEFAULT 2,\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE TABLE crm.prostheses (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    customer_id UUID REFERENCES crm.customers(id),\n    model_id UUID REFERENCES crm.prosthesis_models(id),\n    chip_id VARCHAR(100) NOT NULL UNIQUE,\n    serial_number VARCHAR(100) NOT NULL,\n    manufacture_date DATE,\n    created_at TIMESTAMP DEFAULT NOW(),\n    updated_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Indexes\nCREATE INDEX idx_customers_ldap ON crm.customers(ldap_username);\nCREATE INDEX idx_prostheses_chip ON crm.prostheses(chip_id);\nCREATE INDEX idx_prostheses_customer ON crm.prostheses(customer_id);\n</code></pre>"},{"location":"architecture/data-model/#telemetry-database","title":"Telemetry Database","text":"<pre><code>erDiagram\n    raw_telemetry {\n        bigint id PK\n        string chip_id FK\n        timestamp event_time\n        int movement_type\n        float response_time_ms\n        float battery_level\n        int error_code\n        jsonb raw_data\n    }</code></pre>"},{"location":"architecture/data-model/#sql-schema_1","title":"SQL Schema","text":"<pre><code>-- databases/telemetry_db_init.sql\n\nCREATE SCHEMA IF NOT EXISTS telemetry;\n\nCREATE TABLE telemetry.raw_telemetry (\n    id BIGSERIAL PRIMARY KEY,\n    chip_id VARCHAR(100) NOT NULL,\n    event_time TIMESTAMP NOT NULL DEFAULT NOW(),\n    movement_type INTEGER,\n    response_time_ms FLOAT,\n    battery_level FLOAT,\n    error_code INTEGER DEFAULT 0,\n    raw_data JSONB,\n    created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Partitioning by month for performance\nCREATE INDEX idx_telemetry_chip_time\n    ON telemetry.raw_telemetry(chip_id, event_time);\nCREATE INDEX idx_telemetry_time\n    ON telemetry.raw_telemetry(event_time);\n</code></pre>"},{"location":"architecture/data-model/#olap-layer-clickhouse","title":"OLAP Layer (ClickHouse)","text":""},{"location":"architecture/data-model/#reports-database-schema","title":"Reports Database Schema","text":"<pre><code>erDiagram\n    user_prosthesis_stats {\n        uuid user_id PK\n        string ldap_username\n        uuid prosthesis_id\n        string chip_id\n        date date PK\n        datetime hour\n        uint32 movements_count\n        float32 avg_response_time\n        float32 avg_battery_level\n        uint32 error_count\n        string customer_name\n        string prosthesis_model\n    }\n\n    crm_customers {\n        uuid id PK\n        string name\n        string email\n        string ldap_username\n        uint64 _version\n        uint8 _deleted\n    }\n\n    crm_prostheses {\n        uuid id PK\n        uuid customer_id FK\n        uuid model_id FK\n        string chip_id\n        uint64 _version\n        uint8 _deleted\n    }</code></pre>"},{"location":"architecture/data-model/#clickhouse-schema","title":"ClickHouse Schema","text":"<pre><code>-- clickhouse/init/01_init_schema.sql\n\nCREATE DATABASE IF NOT EXISTS reports;\n\n-- Main reports table (ETL target)\nCREATE TABLE IF NOT EXISTS reports.user_prosthesis_stats (\n    user_id UUID,\n    ldap_username String,\n    prosthesis_id UUID,\n    chip_id String,\n    date Date,\n    hour DateTime,\n    movements_count UInt32,\n    avg_response_time Float32,\n    avg_battery_level Float32,\n    error_count UInt32,\n    error_rate Float32,\n    customer_name String,\n    customer_email String,\n    prosthesis_model String,\n    created_at DateTime DEFAULT now()\n)\nENGINE = MergeTree()\nPARTITION BY toYYYYMM(date)\nORDER BY (ldap_username, date, hour)\nTTL date + INTERVAL 365 DAY;\n</code></pre>"},{"location":"architecture/data-model/#cdc-tables","title":"CDC Tables","text":"<pre><code>-- clickhouse/init/02_cdc_kafka_tables.sql\n\n-- CDC target tables (ReplacingMergeTree for deduplication)\nCREATE TABLE IF NOT EXISTS reports.crm_customers (\n    id UUID,\n    name String,\n    email String,\n    ldap_username String,\n    created_at DateTime64(3),\n    updated_at DateTime64(3),\n    _version UInt64,\n    _deleted UInt8 DEFAULT 0\n)\nENGINE = ReplacingMergeTree(_version)\nORDER BY id;\n\nCREATE TABLE IF NOT EXISTS reports.crm_prostheses (\n    id UUID,\n    customer_id UUID,\n    model_id UUID,\n    chip_id String,\n    serial_number String,\n    created_at DateTime64(3),\n    updated_at DateTime64(3),\n    _version UInt64,\n    _deleted UInt8 DEFAULT 0\n)\nENGINE = ReplacingMergeTree(_version)\nORDER BY id;\n\nCREATE TABLE IF NOT EXISTS reports.crm_prosthesis_models (\n    id UUID,\n    name String,\n    description String,\n    warranty_years UInt8,\n    created_at DateTime64(3),\n    _version UInt64,\n    _deleted UInt8 DEFAULT 0\n)\nENGINE = ReplacingMergeTree(_version)\nORDER BY id;\n</code></pre>"},{"location":"architecture/data-model/#materialized-views-for-cdc","title":"Materialized Views for CDC","text":"<pre><code>-- Auto-insert from Kafka to target tables\nCREATE MATERIALIZED VIEW IF NOT EXISTS reports.mv_kafka_customers\nTO reports.crm_customers\nAS SELECT\n    JSONExtractString(_raw, 'id') as id,\n    JSONExtractString(_raw, 'name') as name,\n    JSONExtractString(_raw, 'email') as email,\n    JSONExtractString(_raw, 'ldap_username') as ldap_username,\n    fromUnixTimestamp64Milli(JSONExtractInt(_raw, '__source_ts_ms')) as created_at,\n    fromUnixTimestamp64Milli(JSONExtractInt(_raw, '__source_ts_ms')) as updated_at,\n    JSONExtractInt(_raw, '__source_ts_ms') as _version,\n    if(JSONExtractString(_raw, '__op') = 'd', 1, 0) as _deleted\nFROM reports.kafka_crm_customers;\n</code></pre>"},{"location":"architecture/data-model/#cdc-data-mart-view","title":"CDC Data Mart View","text":"<pre><code>-- Joined view combining CDC data\nCREATE VIEW IF NOT EXISTS reports.cdc_customer_data AS\nSELECT\n    c.id as customer_id,\n    c.name as customer_name,\n    c.email as customer_email,\n    c.ldap_username,\n    p.id as prosthesis_id,\n    p.chip_id,\n    m.name as prosthesis_model\nFROM reports.crm_customers c FINAL\nJOIN reports.crm_prostheses p FINAL ON c.id = p.customer_id\nJOIN reports.crm_prosthesis_models m FINAL ON p.model_id = m.id\nWHERE c._deleted = 0 AND p._deleted = 0;\n</code></pre>"},{"location":"architecture/data-model/#data-flow","title":"Data Flow","text":""},{"location":"architecture/data-model/#etl-pipeline","title":"ETL Pipeline","text":"<pre><code>flowchart LR\n    subgraph OLTP\n        CRM[(CRM DB)]\n        TEL[(Telemetry DB)]\n    end\n\n    subgraph ETL\n        E1[Extract CRM]\n        E2[Extract Telemetry]\n        T[Transform &amp; Join]\n        L[Load]\n    end\n\n    subgraph OLAP\n        CH[(ClickHouse)]\n    end\n\n    CRM --&gt; E1\n    TEL --&gt; E2\n    E1 --&gt; T\n    E2 --&gt; T\n    T --&gt; L\n    L --&gt; CH</code></pre>"},{"location":"architecture/data-model/#cdc-pipeline","title":"CDC Pipeline","text":"<pre><code>flowchart LR\n    subgraph OLTP\n        CRM[(CRM PostgreSQL)]\n    end\n\n    subgraph CDC\n        WAL[WAL]\n        DBZ[Debezium]\n        KFK[Kafka]\n    end\n\n    subgraph OLAP\n        KE[KafkaEngine]\n        MV[MaterializedView]\n        TT[Target Tables]\n    end\n\n    CRM --&gt; WAL\n    WAL --&gt; DBZ\n    DBZ --&gt; KFK\n    KFK --&gt; KE\n    KE --&gt; MV\n    MV --&gt; TT</code></pre>"},{"location":"architecture/data-model/#partitioning-ttl","title":"Partitioning &amp; TTL","text":""},{"location":"architecture/data-model/#clickhouse-partitioning","title":"ClickHouse Partitioning","text":"Table Partition Key Order Key TTL user_prosthesis_stats toYYYYMM(date) (ldap_username, date, hour) 365 days crm_customers - id - crm_prostheses - id -"},{"location":"architecture/data-model/#postgresql-considerations","title":"PostgreSQL Considerations","text":"<p>\u0414\u043b\u044f \u0431\u043e\u043b\u044c\u0448\u0438\u0445 \u043e\u0431\u044a\u0451\u043c\u043e\u0432 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u0435\u0442\u0441\u044f:</p> <pre><code>-- \u041f\u0430\u0440\u0442\u0438\u0446\u0438\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043f\u043e \u043c\u0435\u0441\u044f\u0446\u0430\u043c\nCREATE TABLE telemetry.raw_telemetry_2024_01\n    PARTITION OF telemetry.raw_telemetry\n    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');\n</code></pre>"},{"location":"architecture/data-model/#sample-queries","title":"Sample Queries","text":""},{"location":"architecture/data-model/#_2","title":"\u041e\u0442\u0447\u0451\u0442\u044b \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f","text":"<pre><code>-- \u0421\u043f\u0438\u0441\u043e\u043a \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u043e\u0442\u0447\u0451\u0442\u043e\u0432\nSELECT DISTINCT date\nFROM reports.user_prosthesis_stats\nWHERE ldap_username = 'ivan.petrov'\nORDER BY date DESC\nLIMIT 30;\n\n-- \u0414\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0451\u0442 \u0437\u0430 \u0434\u0430\u0442\u0443\nSELECT\n    hour,\n    movements_count,\n    avg_response_time,\n    avg_battery_level,\n    error_count,\n    prosthesis_model\nFROM reports.user_prosthesis_stats\nWHERE ldap_username = 'ivan.petrov'\n  AND date = '2024-01-15'\nORDER BY hour;\n</code></pre>"},{"location":"architecture/data-model/#cdc","title":"CDC \u0434\u0430\u043d\u043d\u044b\u0435","text":"<pre><code>-- \u0422\u0435\u043a\u0443\u0449\u0435\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435 \u043a\u043b\u0438\u0435\u043d\u0442\u043e\u0432 (\u0441 \u0434\u0435\u0434\u0443\u043f\u043b\u0438\u043a\u0430\u0446\u0438\u0435\u0439)\nSELECT * FROM reports.crm_customers FINAL\nWHERE _deleted = 0;\n\n-- \u041e\u0431\u044a\u0435\u0434\u0438\u043d\u0451\u043d\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432\nSELECT * FROM reports.cdc_customer_data\nWHERE ldap_username = 'ivan.petrov';\n</code></pre>"},{"location":"architecture/data-model/#_3","title":"\u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430 \u0441\u0438\u0441\u0442\u0435\u043c\u044b","text":"<pre><code>-- \u0420\u0430\u0437\u043c\u0435\u0440 \u0442\u0430\u0431\u043b\u0438\u0446\nSELECT\n    table,\n    formatReadableSize(sum(bytes)) as size,\n    sum(rows) as rows\nFROM system.parts\nWHERE database = 'reports' AND active\nGROUP BY table;\n\n-- Kafka consumer lag\nSELECT * FROM system.kafka_consumers;\n</code></pre>"},{"location":"architecture/data-model/#data-retention","title":"Data Retention","text":"Data Type Storage Retention Reports (OLAP) ClickHouse 365 days (TTL) CDC data ClickHouse Indefinite Telemetry (OLTP) PostgreSQL 90 days Cached reports MinIO S3 Until invalidation Session data Redis 24 hours"},{"location":"architecture/data-model/#_4","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Reports &amp; ETL Architecture</li> <li>CDC Pipeline</li> <li>Architecture Overview</li> </ul>"},{"location":"architecture/overview/","title":"Architecture Overview","text":""},{"location":"architecture/overview/#bionicpro","title":"\u041e\u0431\u0437\u043e\u0440 \u0441\u0438\u0441\u0442\u0435\u043c\u044b BionicPRO","text":"<p>BionicPRO \u2014 \u043f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u0430 \u0434\u043b\u044f \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0431\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u043c\u0438 \u043f\u0440\u043e\u0442\u0435\u0437\u0430\u043c\u0438, \u0432\u043a\u043b\u044e\u0447\u0430\u044e\u0449\u0430\u044f:</p> <ul> <li>\u0421\u0431\u043e\u0440 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 \u0441 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 \u0432 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u043c \u0432\u0440\u0435\u043c\u0435\u043d\u0438</li> <li>\u0424\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439</li> <li>\u0423\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438 \u0447\u0435\u0440\u0435\u0437 CRM</li> <li>\u0411\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u0443\u044e \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044e \u0441 MFA</li> </ul>"},{"location":"architecture/overview/#_1","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043d\u044b\u0435 \u0440\u0435\u0448\u0435\u043d\u0438\u044f","text":"<p>\u0421\u0438\u0441\u0442\u0435\u043c\u0430 \u043f\u043e\u0441\u0442\u0440\u043e\u0435\u043d\u0430 \u043f\u043e \u043f\u0440\u0438\u043d\u0446\u0438\u043f\u0430\u043c:</p> <ol> <li>\u0420\u0430\u0437\u0434\u0435\u043b\u0435\u043d\u0438\u0435 OLTP/OLAP \u043d\u0430\u0433\u0440\u0443\u0437\u043e\u043a \u2014 CRM \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0441 PostgreSQL, \u043e\u0442\u0447\u0451\u0442\u044b \u0444\u043e\u0440\u043c\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0438\u0437 ClickHouse</li> <li>BFF Pattern \u2014 \u0442\u043e\u043a\u0435\u043d\u044b \u0445\u0440\u0430\u043d\u044f\u0442\u0441\u044f \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435, \u0444\u0440\u043e\u043d\u0442\u0435\u043d\u0434 \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u0441 session cookies</li> <li>CDC \u0434\u043b\u044f real-time \u0434\u0430\u043d\u043d\u044b\u0445 \u2014 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f \u0432 CRM \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u0440\u0435\u043f\u043b\u0438\u0446\u0438\u0440\u0443\u044e\u0442\u0441\u044f \u0432 OLAP</li> <li>\u041c\u043d\u043e\u0433\u043e\u0443\u0440\u043e\u0432\u043d\u0435\u0432\u043e\u0435 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u2014 Redis + S3 + Nginx CDN</li> </ol>"},{"location":"architecture/overview/#_2","title":"\u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u043e\u0432","text":"<pre><code>graph TB\n    subgraph \"Users\"\n        U1[\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430]\n        U2[\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 CRM]\n        U3[ML-\u0438\u043d\u0436\u0435\u043d\u0435\u0440]\n    end\n\n    subgraph \"Frontend Layer\"\n        FE[React Frontend&lt;br/&gt;:3000]\n    end\n\n    subgraph \"Security Layer\"\n        KC[Keycloak&lt;br/&gt;:8080]\n        LDAP[OpenLDAP&lt;br/&gt;:389]\n        BFF[BFF Auth&lt;br/&gt;:8000]\n        REDIS[(Redis&lt;br/&gt;:6379)]\n    end\n\n    subgraph \"Application Layer\"\n        RS[Reports Service&lt;br/&gt;:8001]\n        AF[Airflow&lt;br/&gt;:8081]\n    end\n\n    subgraph \"Data Layer\"\n        CRM[(CRM DB&lt;br/&gt;PostgreSQL)]\n        TEL[(Telemetry DB&lt;br/&gt;PostgreSQL)]\n        CH[(ClickHouse&lt;br/&gt;OLAP)]\n    end\n\n    subgraph \"CDC Pipeline\"\n        DBZ[Debezium&lt;br/&gt;:8083]\n        KFK[Kafka&lt;br/&gt;:9092]\n    end\n\n    subgraph \"Caching Layer\"\n        S3[(MinIO S3&lt;br/&gt;:9002)]\n        CDN[Nginx CDN&lt;br/&gt;:8002]\n    end\n\n    U1 --&gt; FE\n    U2 --&gt; CRM\n    U3 --&gt; CH\n\n    FE --&gt; BFF\n    BFF --&gt; KC\n    KC --&gt; LDAP\n    BFF --&gt; REDIS\n    BFF --&gt; RS\n\n    RS --&gt; CH\n    RS --&gt; S3\n    CDN --&gt; S3\n\n    AF --&gt; CRM\n    AF --&gt; TEL\n    AF --&gt; CH\n\n    CRM --&gt; DBZ\n    DBZ --&gt; KFK\n    KFK --&gt; CH</code></pre>"},{"location":"architecture/overview/#_3","title":"\u0421\u043b\u043e\u0438 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u044b","text":""},{"location":"architecture/overview/#1-presentation-layer-frontend","title":"1. Presentation Layer (Frontend)","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Frontend React 18 + TypeScript 3000 SPA \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 Nginx CDN Nginx 1.25 8002 Reverse proxy \u0441 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c"},{"location":"architecture/overview/#2-security-layer","title":"2. Security Layer","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Keycloak Keycloak 26.5.2 8080 Identity Provider, MFA, Identity Brokering OpenLDAP OpenLDAP 1.5.0 389 Directory Service \u0434\u043b\u044f User Federation BFF Auth Python/Flask 8000 Backend-for-Frontend, \u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0442\u043e\u043a\u0435\u043d\u043e\u0432 Redis Redis 7 6379 Session Storage"},{"location":"architecture/overview/#3-application-layer","title":"3. Application Layer","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Reports Service Python/FastAPI 8001 REST API \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432 Apache Airflow Airflow 2.8.1 8081 ETL \u043e\u0440\u043a\u0435\u0441\u0442\u0440\u0430\u0442\u043e\u0440"},{"location":"architecture/overview/#4-data-layer","title":"4. Data Layer","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 CRM DB PostgreSQL 14 5435 OLTP \u0431\u0430\u0437\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u043e\u0432 \u0438 \u0437\u0430\u043a\u0430\u0437\u043e\u0432 Telemetry DB PostgreSQL 14 5436 OLTP \u0431\u0430\u0437\u0430 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 ClickHouse ClickHouse 24.1 8123/9000 OLAP \u0432\u0438\u0442\u0440\u0438\u043d\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 MinIO MinIO S3 9002 Object Storage \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432"},{"location":"architecture/overview/#5-cdc-pipeline","title":"5. CDC Pipeline","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Debezium Debezium Connect 8083 CDC \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440 \u0434\u043b\u044f PostgreSQL Kafka Apache Kafka 3.6 9092 Message Broker Zookeeper Apache Zookeeper 2181 \u041a\u043e\u043e\u0440\u0434\u0438\u043d\u0430\u0442\u043e\u0440 Kafka"},{"location":"architecture/overview/#_4","title":"\u041f\u043e\u0442\u043e\u043a\u0438 \u0434\u0430\u043d\u043d\u044b\u0445","text":""},{"location":"architecture/overview/#_5","title":"\u041f\u043e\u0442\u043e\u043a \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438","text":"<pre><code>sequenceDiagram\n    participant U as User\n    participant FE as Frontend\n    participant BFF as BFF Auth\n    participant KC as Keycloak\n    participant LDAP as LDAP\n    participant R as Redis\n\n    U-&gt;&gt;FE: 1. Login click\n    FE-&gt;&gt;BFF: 2. GET /auth/login\n    BFF-&gt;&gt;BFF: 3. Generate PKCE (code_verifier, code_challenge)\n    BFF-&gt;&gt;R: 4. Store code_verifier\n    BFF-&gt;&gt;FE: 5. Redirect to Keycloak\n    FE-&gt;&gt;KC: 6. Authorization request + code_challenge\n    KC-&gt;&gt;LDAP: 7. Authenticate user\n    LDAP-&gt;&gt;KC: 8. User credentials\n    KC-&gt;&gt;FE: 9. Authorization code\n    FE-&gt;&gt;BFF: 10. Callback with code\n    BFF-&gt;&gt;R: 11. Get code_verifier\n    BFF-&gt;&gt;KC: 12. Exchange code + code_verifier\n    KC-&gt;&gt;BFF: 13. Access + Refresh tokens\n    BFF-&gt;&gt;R: 14. Store encrypted tokens\n    BFF-&gt;&gt;FE: 15. Set session cookie (HTTP-only)</code></pre>"},{"location":"architecture/overview/#_6","title":"\u041f\u043e\u0442\u043e\u043a \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432","text":"<pre><code>sequenceDiagram\n    participant U as User\n    participant FE as Frontend\n    participant BFF as BFF Auth\n    participant RS as Reports Service\n    participant CH as ClickHouse\n    participant S3 as MinIO S3\n    participant CDN as Nginx CDN\n\n    U-&gt;&gt;FE: 1. Request reports\n    FE-&gt;&gt;BFF: 2. GET /api/reports (+ session cookie)\n    BFF-&gt;&gt;RS: 3. GET /api/reports (+ JWT)\n    RS-&gt;&gt;S3: 4. HEAD (check cache)\n    alt Cache HIT\n        S3-&gt;&gt;RS: 5a. Report exists\n        RS-&gt;&gt;BFF: 6a. Return CDN URL\n        BFF-&gt;&gt;FE: 7a. CDN URL\n        FE-&gt;&gt;CDN: 8a. GET report\n        CDN-&gt;&gt;S3: 9a. Proxy (if not cached)\n        CDN-&gt;&gt;FE: 10a. Report JSON\n    else Cache MISS\n        RS-&gt;&gt;CH: 5b. SELECT from OLAP\n        CH-&gt;&gt;RS: 6b. Report data\n        RS-&gt;&gt;S3: 7b. PUT report\n        RS-&gt;&gt;BFF: 8b. CDN URL\n    end</code></pre>"},{"location":"architecture/overview/#cdc","title":"\u041f\u043e\u0442\u043e\u043a CDC","text":"<pre><code>sequenceDiagram\n    participant CRM as CRM PostgreSQL\n    participant DBZ as Debezium\n    participant KFK as Kafka\n    participant CH as ClickHouse\n\n    CRM-&gt;&gt;CRM: 1. INSERT/UPDATE/DELETE\n    CRM-&gt;&gt;DBZ: 2. WAL event (logical replication)\n    DBZ-&gt;&gt;DBZ: 3. Transform to Debezium format\n    DBZ-&gt;&gt;KFK: 4. Publish to topic crm.crm.*\n    KFK-&gt;&gt;CH: 5. KafkaEngine consumes\n    CH-&gt;&gt;CH: 6. MaterializedView transforms\n    CH-&gt;&gt;CH: 7. Insert to target table (ReplacingMergeTree)</code></pre>"},{"location":"architecture/overview/#_7","title":"\u041f\u0440\u0438\u043d\u0446\u0438\u043f\u044b \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438","text":""},{"location":"architecture/overview/#bff-pattern","title":"\u0417\u0430\u0449\u0438\u0442\u0430 \u0442\u043e\u043a\u0435\u043d\u043e\u0432 (BFF Pattern)","text":"<ul> <li>Access/Refresh \u0442\u043e\u043a\u0435\u043d\u044b \u043d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043f\u0435\u0440\u0435\u0434\u0430\u044e\u0442\u0441\u044f \u043d\u0430 \u0444\u0440\u043e\u043d\u0442\u0435\u043d\u0434</li> <li>\u0422\u043e\u043a\u0435\u043d\u044b \u0445\u0440\u0430\u043d\u044f\u0442\u0441\u044f \u0432 Redis \u0432 \u0437\u0430\u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u043d\u043e\u043c \u0432\u0438\u0434\u0435 (Fernet)</li> <li>\u0424\u0440\u043e\u043d\u0442\u0435\u043d\u0434 \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u0441 HTTP-only, Secure session cookies</li> <li>\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u0440\u043e\u0442\u0430\u0446\u0438\u044f session ID \u0434\u043b\u044f \u0437\u0430\u0449\u0438\u0442\u044b \u043e\u0442 session fixation</li> </ul>"},{"location":"architecture/overview/#_8","title":"\u041c\u043d\u043e\u0433\u043e\u0444\u0430\u043a\u0442\u043e\u0440\u043d\u0430\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f","text":"<ul> <li>\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u044b\u0439 TOTP \u0434\u043b\u044f \u0432\u0441\u0435\u0445 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439</li> <li>\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u0447\u0435\u0440\u0435\u0437 Keycloak Admin Console</li> <li>\u041f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0430 Google Authenticator, Authy \u0438 \u0434\u0440.</li> </ul>"},{"location":"architecture/overview/#_9","title":"\u041b\u043e\u043a\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445","text":"<ul> <li>\u041f\u0435\u0440\u0441\u043e\u043d\u0430\u043b\u044c\u043d\u044b\u0435 \u0434\u0430\u043d\u043d\u044b\u0435 \u043e\u0441\u0442\u0430\u044e\u0442\u0441\u044f \u0432 \u043b\u043e\u043a\u0430\u043b\u044c\u043d\u044b\u0445 \u0411\u0414 \u043f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u0438\u0442\u0435\u043b\u044c\u0441\u0442\u0432</li> <li>Keycloak \u0441\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u0442\u043e\u043b\u044c\u043a\u043e \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u043e\u043d\u043d\u044b\u0435 \u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044b</li> <li>User Federation \u0441 \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u044b\u043c\u0438 LDAP \u0441\u0435\u0440\u0432\u0435\u0440\u0430\u043c\u0438 \u0434\u043b\u044f \u0420\u0424 \u0438 \u0415\u0432\u0440\u043e\u043f\u044b</li> </ul>"},{"location":"architecture/overview/#_10","title":"\u0421\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0435 \u0448\u0430\u0433\u0438","text":"<ul> <li>Security Architecture \u2014 \u0434\u0435\u0442\u0430\u043b\u044c\u043d\u043e\u0435 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438</li> <li>Reports &amp; ETL \u2014 ETL pipeline \u0438 Reports Service</li> <li>S3/CDN Caching \u2014 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f</li> <li>CDC Pipeline \u2014 Change Data Capture</li> </ul>"},{"location":"architecture/reports-etl/","title":"Reports &amp; ETL Architecture (Task 2)","text":""},{"location":"architecture/reports-etl/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u0417\u0430\u0434\u0430\u043d\u0438\u0435 2 \u0440\u0435\u0430\u043b\u0438\u0437\u0443\u0435\u0442 ETL pipeline \u0438 Reports API \u0434\u043b\u044f \u0434\u0430\u043d\u043d\u044b\u0445 \u043e\u0431 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0438 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432.</p>"},{"location":"architecture/reports-etl/#_2","title":"\u0420\u0435\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Apache Airflow \u041e\u0440\u043a\u0435\u0441\u0442\u0440\u0430\u0442\u043e\u0440 ETL-\u043f\u0440\u043e\u0446\u0435\u0441\u0441\u043e\u0432 \u0441 \u0440\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u0435\u043c ClickHouse OLAP \u0410\u043d\u0430\u043b\u0438\u0442\u0438\u0447\u0435\u0441\u043a\u0430\u044f \u0431\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0441 \u043f\u0430\u0440\u0442\u0438\u0446\u0438\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u043e\u0439 \u0432\u0438\u0442\u0440\u0438\u043d\u043e\u0439 Reports Service FastAPI REST API \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432 JWT Authentication \u0417\u0430\u0449\u0438\u0442\u0430 API \u0447\u0435\u0440\u0435\u0437 \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044e \u0442\u043e\u043a\u0435\u043d\u043e\u0432 Keycloak"},{"location":"architecture/reports-etl/#_3","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043d\u0430\u044f \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430","text":"<pre><code>graph TB\n    subgraph \"Users\"\n        U[\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430]\n        ML[ML-\u0438\u043d\u0436\u0435\u043d\u0435\u0440]\n    end\n\n    subgraph \"Frontend\"\n        FE[Mobile App / Web]\n    end\n\n    subgraph \"Security\"\n        BFF[BFF Auth]\n        KC[Keycloak]\n    end\n\n    subgraph \"Reports Service\"\n        RS[Reports Service&lt;br/&gt;FastAPI :8001]\n    end\n\n    subgraph \"ETL Pipeline\"\n        AF[Apache Airflow&lt;br/&gt;:8081]\n        ETL[ETL Jobs&lt;br/&gt;Python]\n    end\n\n    subgraph \"OLTP Sources\"\n        CRM[(CRM DB&lt;br/&gt;PostgreSQL)]\n        TEL[(Telemetry DB&lt;br/&gt;PostgreSQL)]\n    end\n\n    subgraph \"OLAP Target\"\n        CH[(ClickHouse&lt;br/&gt;:8123/:9000)]\n    end\n\n    U --&gt; FE\n    ML --&gt; CH\n\n    FE --&gt; BFF\n    BFF --&gt; RS\n    RS --&gt; CH\n\n    AF --&gt; ETL\n    ETL --&gt;|Extract| CRM\n    ETL --&gt;|Extract| TEL\n    ETL --&gt;|Load| CH</code></pre>"},{"location":"architecture/reports-etl/#etl-pipeline","title":"ETL Pipeline","text":""},{"location":"architecture/reports-etl/#dag-bionicpro_reports_etl","title":"DAG: bionicpro_reports_etl","text":"<pre><code># airflow/dags/bionicpro_reports_etl.py\nfrom airflow import DAG\nfrom airflow.operators.python import PythonOperator\nfrom datetime import datetime, timedelta\n\ndefault_args = {\n    'owner': 'bionicpro',\n    'depends_on_past': False,\n    'retries': 3,\n    'retry_delay': timedelta(minutes=5),\n}\n\nwith DAG(\n    dag_id='bionicpro_reports_etl',\n    default_args=default_args,\n    description='ETL pipeline for prosthesis usage reports',\n    schedule_interval='*/15 * * * *',  # \u041a\u0430\u0436\u0434\u044b\u0435 15 \u043c\u0438\u043d\u0443\u0442\n    start_date=datetime(2024, 1, 1),\n    catchup=False,\n) as dag:\n\n    extract_crm = PythonOperator(\n        task_id='extract_crm_data',\n        python_callable=extract_crm_data,\n    )\n\n    extract_telemetry = PythonOperator(\n        task_id='extract_telemetry_data',\n        python_callable=extract_telemetry_data,\n    )\n\n    transform = PythonOperator(\n        task_id='transform_and_join',\n        python_callable=transform_and_join,\n    )\n\n    load = PythonOperator(\n        task_id='load_to_clickhouse',\n        python_callable=load_to_clickhouse,\n    )\n\n    [extract_crm, extract_telemetry] &gt;&gt; transform &gt;&gt; load\n</code></pre>"},{"location":"architecture/reports-etl/#dag","title":"\u0412\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f DAG","text":"<pre><code>graph LR\n    A[extract_crm_data] --&gt; C[transform_and_join]\n    B[extract_telemetry_data] --&gt; C\n    C --&gt; D[load_to_clickhouse]</code></pre>"},{"location":"architecture/reports-etl/#etl-tasks","title":"ETL Tasks","text":""},{"location":"architecture/reports-etl/#1-extract-crm-data","title":"1. Extract CRM Data","text":"<pre><code>def extract_crm_data(**context):\n    \"\"\"\u0418\u0437\u0432\u043b\u0435\u0447\u0435\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u043a\u043b\u0438\u0435\u043d\u0442\u043e\u0432 \u0438 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 \u0438\u0437 CRM\"\"\"\n    query = \"\"\"\n    SELECT\n        c.id as customer_id,\n        c.name as customer_name,\n        c.email,\n        c.ldap_username,\n        p.id as prosthesis_id,\n        p.chip_id,\n        pm.name as prosthesis_model\n    FROM crm.customers c\n    JOIN crm.prostheses p ON c.id = p.customer_id\n    JOIN crm.prosthesis_models pm ON p.model_id = pm.id\n    WHERE c.updated_at &gt;= NOW() - INTERVAL '7 days'\n    \"\"\"\n    # Execute and return DataFrame\n</code></pre>"},{"location":"architecture/reports-etl/#2-extract-telemetry-data","title":"2. Extract Telemetry Data","text":"<pre><code>def extract_telemetry_data(**context):\n    \"\"\"\u0418\u0437\u0432\u043b\u0435\u0447\u0435\u043d\u0438\u0435 \u0430\u0433\u0440\u0435\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0445 \u0434\u0430\u043d\u043d\u044b\u0445 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438\"\"\"\n    query = \"\"\"\n    SELECT\n        chip_id,\n        DATE_TRUNC('hour', event_time) as hour,\n        COUNT(*) as movements_count,\n        AVG(response_time_ms) as avg_response_time,\n        AVG(battery_level) as avg_battery_level,\n        SUM(CASE WHEN error_code &gt; 0 THEN 1 ELSE 0 END) as error_count\n    FROM telemetry.raw_telemetry\n    WHERE event_time &gt;= NOW() - INTERVAL '7 days'\n    GROUP BY chip_id, DATE_TRUNC('hour', event_time)\n    \"\"\"\n</code></pre>"},{"location":"architecture/reports-etl/#3-transform-and-join","title":"3. Transform and Join","text":"<pre><code>def transform_and_join(**context):\n    \"\"\"\u041e\u0431\u044a\u0435\u0434\u0438\u043d\u0435\u043d\u0438\u0435 \u0438 \u0442\u0440\u0430\u043d\u0441\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f \u0434\u0430\u043d\u043d\u044b\u0445\"\"\"\n    ti = context['ti']\n    crm_data = ti.xcom_pull(task_ids='extract_crm_data')\n    telemetry_data = ti.xcom_pull(task_ids='extract_telemetry_data')\n\n    # JOIN \u043f\u043e chip_id\n    merged = pd.merge(\n        telemetry_data,\n        crm_data,\n        on='chip_id',\n        how='inner'\n    )\n\n    # \u0420\u0430\u0441\u0447\u0451\u0442 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0445 \u043c\u0435\u0442\u0440\u0438\u043a\n    merged['error_rate'] = merged['error_count'] / merged['movements_count']\n    merged['date'] = merged['hour'].dt.date\n\n    return merged\n</code></pre>"},{"location":"architecture/reports-etl/#4-load-to-clickhouse","title":"4. Load to ClickHouse","text":"<pre><code>def load_to_clickhouse(**context):\n    \"\"\"\u0417\u0430\u0433\u0440\u0443\u0437\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0432 ClickHouse\"\"\"\n    ti = context['ti']\n    data = ti.xcom_pull(task_ids='transform_and_join')\n\n    client = clickhouse_connect.get_client(\n        host='clickhouse',\n        port=9000,\n        database='reports'\n    )\n\n    client.insert(\n        'user_prosthesis_stats',\n        data.values.tolist(),\n        column_names=list(data.columns)\n    )\n</code></pre>"},{"location":"architecture/reports-etl/#clickhouse-schema","title":"ClickHouse Schema","text":""},{"location":"architecture/reports-etl/#_4","title":"\u0412\u0438\u0442\u0440\u0438\u043d\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432","text":"<pre><code>-- clickhouse/init/01_init_schema.sql\n\nCREATE DATABASE IF NOT EXISTS reports;\n\nCREATE TABLE IF NOT EXISTS reports.user_prosthesis_stats (\n    -- \u0418\u0434\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440\u044b\n    user_id UUID,\n    ldap_username String,\n    prosthesis_id UUID,\n    chip_id String,\n\n    -- \u0412\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435 \u043c\u0435\u0442\u043a\u0438\n    date Date,\n    hour DateTime,\n\n    -- \u041c\u0435\u0442\u0440\u0438\u043a\u0438 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438\n    movements_count UInt32,\n    avg_response_time Float32,\n    avg_battery_level Float32,\n    error_count UInt32,\n    error_rate Float32,\n\n    -- \u0414\u0430\u043d\u043d\u044b\u0435 \u043a\u043b\u0438\u0435\u043d\u0442\u0430\n    customer_name String,\n    customer_email String,\n    prosthesis_model String,\n\n    -- \u041c\u0435\u0442\u0430\u0434\u0430\u043d\u043d\u044b\u0435\n    created_at DateTime DEFAULT now()\n)\nENGINE = MergeTree()\nPARTITION BY toYYYYMM(date)\nORDER BY (user_id, date, hour)\nTTL date + INTERVAL 365 DAY;\n</code></pre>"},{"location":"architecture/reports-etl/#_5","title":"\u0418\u043d\u0434\u0435\u043a\u0441\u044b \u0438 \u043e\u043f\u0442\u0438\u043c\u0438\u0437\u0430\u0446\u0438\u044f","text":"<pre><code>-- \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u043f\u0440\u043e\u0435\u043a\u0446\u0438\u0439 \u0434\u043b\u044f \u0431\u044b\u0441\u0442\u0440\u044b\u0445 \u0430\u0433\u0440\u0435\u0433\u0430\u0446\u0438\u0439\nALTER TABLE reports.user_prosthesis_stats\nADD PROJECTION daily_stats (\n    SELECT\n        user_id,\n        date,\n        sum(movements_count) as total_movements,\n        avg(avg_response_time) as avg_response_time,\n        avg(avg_battery_level) as avg_battery_level\n    GROUP BY user_id, date\n);\n</code></pre>"},{"location":"architecture/reports-etl/#reports-service","title":"Reports Service","text":""},{"location":"architecture/reports-etl/#api-endpoints","title":"API Endpoints","text":"Method Endpoint \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 GET <code>/api/reports</code> \u0421\u043f\u0438\u0441\u043e\u043a \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f GET <code>/api/reports/summary</code> \u0421\u0432\u043e\u0434\u043d\u0430\u044f \u0441\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430 GET <code>/api/reports/{date}</code> \u0414\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0451\u0442 \u0437\u0430 \u0434\u0430\u0442\u0443 GET <code>/health</code> Health check GET <code>/health/live</code> Liveness probe"},{"location":"architecture/reports-etl/#_6","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 \u0441\u0435\u0440\u0432\u0438\u0441\u0430","text":"<pre><code># reports-service/app/main.py\nfrom fastapi import FastAPI, Depends, HTTPException\nfrom app.auth.jwt_handler import get_current_user\nfrom app.services.clickhouse_service import ClickHouseService\n\napp = FastAPI(title=\"BionicPRO Reports Service\")\n\n@app.get(\"/api/reports\")\nasync def get_reports(\n    user: dict = Depends(get_current_user),\n    ch: ClickHouseService = Depends()\n):\n    \"\"\"\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u0442\u0435\u043a\u0443\u0449\u0435\u0433\u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\"\"\"\n    username = user.get(\"preferred_username\")\n    return await ch.get_user_reports(username)\n\n@app.get(\"/api/reports/{date}\")\nasync def get_report_by_date(\n    date: str,\n    user: dict = Depends(get_current_user),\n    ch: ClickHouseService = Depends()\n):\n    \"\"\"\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0434\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0451\u0442 \u0437\u0430 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u0443\u044e \u0434\u0430\u0442\u0443\"\"\"\n    username = user.get(\"preferred_username\")\n    return await ch.get_report_by_date(username, date)\n</code></pre>"},{"location":"architecture/reports-etl/#jwt-validation","title":"JWT Validation","text":"<pre><code># reports-service/app/auth/jwt_handler.py\nfrom jose import jwt, JWTError\nfrom fastapi import HTTPException, Security\nfrom fastapi.security import HTTPBearer\n\nsecurity = HTTPBearer()\n\nasync def get_current_user(credentials = Security(security)):\n    token = credentials.credentials\n    try:\n        # \u0412\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f JWT \u0447\u0435\u0440\u0435\u0437 Keycloak public key\n        payload = jwt.decode(\n            token,\n            key=KEYCLOAK_PUBLIC_KEY,\n            algorithms=[\"RS256\"],\n            audience=\"bionicpro-auth\"\n        )\n        return payload\n    except JWTError:\n        raise HTTPException(status_code=401, detail=\"Invalid token\")\n</code></pre>"},{"location":"architecture/reports-etl/#clickhouse-service","title":"ClickHouse Service","text":"<pre><code># reports-service/app/services/clickhouse_service.py\nimport clickhouse_connect\n\nclass ClickHouseService:\n    def __init__(self):\n        self.client = clickhouse_connect.get_client(\n            host=os.getenv(\"CLICKHOUSE_HOST\", \"clickhouse\"),\n            port=int(os.getenv(\"CLICKHOUSE_PORT\", 9000)),\n            database=os.getenv(\"CLICKHOUSE_DATABASE\", \"reports\")\n        )\n\n    async def get_user_reports(self, username: str):\n        query = \"\"\"\n        SELECT DISTINCT date\n        FROM reports.user_prosthesis_stats\n        WHERE ldap_username = %(username)s\n        ORDER BY date DESC\n        LIMIT 30\n        \"\"\"\n        return self.client.query(query, parameters={\"username\": username})\n\n    async def get_report_by_date(self, username: str, date: str):\n        query = \"\"\"\n        SELECT\n            hour,\n            movements_count,\n            avg_response_time,\n            avg_battery_level,\n            error_count,\n            prosthesis_model\n        FROM reports.user_prosthesis_stats\n        WHERE ldap_username = %(username)s\n          AND date = %(date)s\n        ORDER BY hour\n        \"\"\"\n        return self.client.query(\n            query,\n            parameters={\"username\": username, \"date\": date}\n        )\n</code></pre>"},{"location":"architecture/reports-etl/#response-examples","title":"Response Examples","text":""},{"location":"architecture/reports-etl/#get-apireports","title":"GET /api/reports","text":"<pre><code>{\n  \"reports\": [\n    {\"date\": \"2024-01-15\"},\n    {\"date\": \"2024-01-14\"},\n    {\"date\": \"2024-01-13\"}\n  ],\n  \"total\": 3,\n  \"user\": \"ivan.petrov\"\n}\n</code></pre>"},{"location":"architecture/reports-etl/#get-apireports2024-01-15","title":"GET /api/reports/2024-01-15","text":"<pre><code>{\n  \"date\": \"2024-01-15\",\n  \"user\": \"ivan.petrov\",\n  \"prosthesis_model\": \"BionicHand Pro X1\",\n  \"summary\": {\n    \"total_movements\": 1523,\n    \"avg_response_time_ms\": 45.2,\n    \"avg_battery_level\": 78.5,\n    \"total_errors\": 3,\n    \"uptime_hours\": 14\n  },\n  \"hourly_data\": [\n    {\n      \"hour\": \"2024-01-15T08:00:00\",\n      \"movements_count\": 145,\n      \"avg_response_time\": 42.1,\n      \"battery_level\": 95.0,\n      \"error_count\": 0\n    },\n    {\n      \"hour\": \"2024-01-15T09:00:00\",\n      \"movements_count\": 189,\n      \"avg_response_time\": 44.3,\n      \"battery_level\": 92.0,\n      \"error_count\": 1\n    }\n  ]\n}\n</code></pre>"},{"location":"architecture/reports-etl/#airflow-connections","title":"Airflow Connections","text":"<p>ETL \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0435 Airflow Connections:</p> Connection ID Type Host Database bionicpro_crm_db PostgreSQL crm_db crm_db bionicpro_telemetry_db PostgreSQL telemetry_db telemetry_db bionicpro_clickhouse Generic clickhouse reports <pre><code># \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 connections\nairflow connections add 'bionicpro_crm_db' \\\n  --conn-type 'postgres' \\\n  --conn-host 'crm_db' \\\n  --conn-schema 'crm_db' \\\n  --conn-login 'crm_user' \\\n  --conn-password 'crm_password' \\\n  --conn-port '5432'\n</code></pre>"},{"location":"architecture/reports-etl/#monitoring","title":"Monitoring","text":""},{"location":"architecture/reports-etl/#airflow-ui","title":"Airflow UI","text":"<ul> <li>URL: http://localhost:8081</li> <li>Credentials: admin / admin</li> </ul>"},{"location":"architecture/reports-etl/#dag-metrics","title":"DAG Metrics","text":"<pre><code># \u0421\u0442\u0430\u0442\u0443\u0441 DAG\ndocker-compose exec airflow-webserver airflow dags list\n\n# \u0418\u0441\u0442\u043e\u0440\u0438\u044f \u0437\u0430\u043f\u0443\u0441\u043a\u043e\u0432\ndocker-compose exec airflow-webserver airflow dags list-runs -d bionicpro_reports_etl\n\n# \u0420\u0443\u0447\u043d\u043e\u0439 \u0437\u0430\u043f\u0443\u0441\u043a\ndocker-compose exec airflow-webserver airflow dags trigger bionicpro_reports_etl\n</code></pre>"},{"location":"architecture/reports-etl/#clickhouse-queries","title":"ClickHouse Queries","text":"<pre><code>-- \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u0432 \u0432\u0438\u0442\u0440\u0438\u043d\u0435\nSELECT count() FROM reports.user_prosthesis_stats;\n\n-- \u0414\u0430\u043d\u043d\u044b\u0435 \u043f\u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044e\nSELECT *\nFROM reports.user_prosthesis_stats\nWHERE ldap_username = 'ivan.petrov'\nORDER BY date DESC, hour DESC\nLIMIT 10;\n</code></pre>"},{"location":"architecture/reports-etl/#_7","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture Overview</li> <li>S3/CDN Caching</li> <li>CDC Pipeline</li> <li>Reports API Reference</li> </ul>"},{"location":"architecture/s3-cdn/","title":"S3/CDN Caching Architecture (Task 3)","text":""},{"location":"architecture/s3-cdn/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u0417\u0430\u0434\u0430\u043d\u0438\u0435 3 \u0440\u0435\u0430\u043b\u0438\u0437\u0443\u0435\u0442 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u0441 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435\u043c S3 \u0445\u0440\u0430\u043d\u0438\u043b\u0438\u0449\u0430 \u0438 CDN \u0434\u043b\u044f \u0441\u043d\u0438\u0436\u0435\u043d\u0438\u044f \u043d\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u043d\u0430 \u0431\u0430\u0437\u0443 \u0434\u0430\u043d\u043d\u044b\u0445.</p>"},{"location":"architecture/s3-cdn/#_2","title":"\u0420\u0435\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 MinIO S3-\u0441\u043e\u0432\u043c\u0435\u0441\u0442\u0438\u043c\u043e\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u043d\u043e\u0435 \u0445\u0440\u0430\u043d\u0438\u043b\u0438\u0449\u0435 \u0434\u043b\u044f JSON \u043e\u0442\u0447\u0451\u0442\u043e\u0432 Nginx CDN Reverse proxy \u0441 HTTP \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c Cache Invalidation TTL-based \u0438 ETL-triggered \u0438\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u043a\u044d\u0448\u0430 CDN URLs \u041f\u0440\u044f\u043c\u044b\u0435 \u0441\u0441\u044b\u043b\u043a\u0438 \u043d\u0430 \u0437\u0430\u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u043e\u0442\u0447\u0451\u0442\u044b"},{"location":"architecture/s3-cdn/#_3","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043d\u0430\u044f \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430","text":"<pre><code>graph TB\n    subgraph \"Users\"\n        U[\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c]\n        A[\u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440]\n    end\n\n    subgraph \"Frontend\"\n        FE[React Frontend]\n    end\n\n    subgraph \"BFF &amp; Auth\"\n        BFF[bionicpro-auth]\n    end\n\n    subgraph \"Reports Service\"\n        RS[Reports Service&lt;br/&gt;FastAPI]\n    end\n\n    subgraph \"Caching Layer\"\n        CDN[Nginx CDN&lt;br/&gt;:8002]\n        S3[(MinIO S3&lt;br/&gt;:9002)]\n        REDIS[(Redis&lt;br/&gt;:6379)]\n    end\n\n    subgraph \"Data\"\n        CH[(ClickHouse)]\n    end\n\n    subgraph \"ETL\"\n        AF[Airflow]\n    end\n\n    U --&gt; FE\n    FE --&gt; BFF\n    BFF --&gt; RS\n\n    RS --&gt;|1. Check S3| S3\n    RS --&gt;|2. Query if miss| CH\n    RS --&gt;|3. Store report| S3\n\n    FE --&gt;|6. Fetch via CDN| CDN\n    CDN --&gt;|7. Proxy| S3\n\n    AF --&gt;|Invalidate| RS\n    RS --&gt;|Delete| S3\n    RS --&gt;|Clear| REDIS\n\n    A --&gt;|Manual invalidate| RS</code></pre>"},{"location":"architecture/s3-cdn/#request-flow","title":"Request Flow","text":""},{"location":"architecture/s3-cdn/#cache-hit-fast-path","title":"Cache HIT (Fast Path)","text":"<pre><code>sequenceDiagram\n    participant U as User\n    participant FE as Frontend\n    participant BFF as BFF Auth\n    participant RS as Reports Service\n    participant S3 as MinIO S3\n    participant CDN as Nginx CDN\n\n    U-&gt;&gt;FE: 1. \u0417\u0430\u043f\u0440\u043e\u0441 \u043e\u0442\u0447\u0451\u0442\u0430\n    FE-&gt;&gt;BFF: 2. GET /api/reports/cdn/list\n    BFF-&gt;&gt;RS: 3. Proxy + JWT\n    RS-&gt;&gt;S3: 4. HEAD (\u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043d\u0430\u043b\u0438\u0447\u0438\u044f)\n    S3-&gt;&gt;RS: 5. 200 OK (\u0444\u0430\u0439\u043b \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442)\n    RS-&gt;&gt;BFF: 6. CDN URL\n    BFF-&gt;&gt;FE: 7. CDN URL\n    FE-&gt;&gt;CDN: 8. GET report.json\n    CDN-&gt;&gt;CDN: 9. Check cache\n    CDN-&gt;&gt;FE: 10. Report JSON (from cache)</code></pre>"},{"location":"architecture/s3-cdn/#cache-miss","title":"Cache MISS","text":"<pre><code>sequenceDiagram\n    participant RS as Reports Service\n    participant S3 as MinIO S3\n    participant CH as ClickHouse\n    participant CDN as Nginx CDN\n\n    RS-&gt;&gt;S3: 1. HEAD (\u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430)\n    S3-&gt;&gt;RS: 2. 404 Not Found\n    RS-&gt;&gt;CH: 3. SELECT from OLAP\n    CH-&gt;&gt;RS: 4. Report data\n    RS-&gt;&gt;RS: 5. Generate JSON\n    RS-&gt;&gt;S3: 6. PUT report.json\n    RS-&gt;&gt;RS: 7. Return CDN URL</code></pre>"},{"location":"architecture/s3-cdn/#s3-storage-structure","title":"S3 Storage Structure","text":"<pre><code>reports-bucket/\n\u251c\u2500\u2500 {user_id}/\n\u2502   \u251c\u2500\u2500 list/\n\u2502   \u2502   \u2514\u2500\u2500 reports.json          # \u0421\u043f\u0438\u0441\u043e\u043a \u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b\u0445 \u043e\u0442\u0447\u0451\u0442\u043e\u0432\n\u2502   \u251c\u2500\u2500 summary/\n\u2502   \u2502   \u2514\u2500\u2500 summary.json          # \u0421\u0432\u043e\u0434\u043d\u0430\u044f \u0441\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430\n\u2502   \u2514\u2500\u2500 daily/\n\u2502       \u251c\u2500\u2500 2024-01-15/\n\u2502       \u2502   \u2514\u2500\u2500 report.json       # \u0414\u0435\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u043e\u0442\u0447\u0451\u0442 \u0437\u0430 \u0434\u0430\u0442\u0443\n\u2502       \u251c\u2500\u2500 2024-01-14/\n\u2502       \u2502   \u2514\u2500\u2500 report.json\n\u2502       \u2514\u2500\u2500 ...\n</code></pre>"},{"location":"architecture/s3-cdn/#reportsjson","title":"\u041f\u0440\u0438\u043c\u0435\u0440 reports.json","text":"<pre><code>{\n  \"user_id\": \"550e8400-e29b-41d4-a716-446655440000\",\n  \"username\": \"ivan.petrov\",\n  \"generated_at\": \"2024-01-15T10:30:00Z\",\n  \"reports\": [\n    {\n      \"date\": \"2024-01-15\",\n      \"cdn_url\": \"http://localhost:8002/reports/550e8400.../daily/2024-01-15/report.json\"\n    },\n    {\n      \"date\": \"2024-01-14\",\n      \"cdn_url\": \"http://localhost:8002/reports/550e8400.../daily/2024-01-14/report.json\"\n    }\n  ]\n}\n</code></pre>"},{"location":"architecture/s3-cdn/#minio-configuration","title":"MinIO Configuration","text":""},{"location":"architecture/s3-cdn/#docker-compose","title":"Docker Compose","text":"<pre><code>minio:\n  image: minio/minio:RELEASE.2024-01-18T22-51-28Z\n  environment:\n    MINIO_ROOT_USER: minioadmin\n    MINIO_ROOT_PASSWORD: minioadmin123\n  volumes:\n    - ./minio-data:/data\n  ports:\n    - \"9001:9001\"   # Console UI\n    - \"9002:9000\"   # S3 API\n  command: server /data --console-address \":9001\"\n</code></pre>"},{"location":"architecture/s3-cdn/#bucket-initialization","title":"Bucket Initialization","text":"<pre><code># minio-init service\nmc alias set myminio http://minio:9000 minioadmin minioadmin123\nmc mb myminio/reports-bucket --ignore-existing\nmc anonymous set download myminio/reports-bucket\n</code></pre>"},{"location":"architecture/s3-cdn/#nginx-cdn-configuration","title":"Nginx CDN Configuration","text":"<pre><code># nginx-cdn/nginx.conf\nworker_processes auto;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    # Cache configuration\n    proxy_cache_path /var/cache/nginx\n        levels=1:2\n        keys_zone=reports_cache:10m\n        max_size=1g\n        inactive=5m\n        use_temp_path=off;\n\n    server {\n        listen 80;\n\n        # Health check\n        location /health {\n            return 200 'OK';\n            add_header Content-Type text/plain;\n        }\n\n        # Reports proxy with caching\n        location /reports/ {\n            proxy_pass http://minio:9000/reports-bucket/;\n\n            # Cache settings\n            proxy_cache reports_cache;\n            proxy_cache_valid 200 5m;\n            proxy_cache_valid 404 1m;\n            proxy_cache_use_stale error timeout updating;\n            proxy_cache_lock on;\n\n            # Cache status header\n            add_header X-Cache-Status $upstream_cache_status;\n\n            # CORS headers\n            add_header Access-Control-Allow-Origin *;\n            add_header Access-Control-Allow-Methods 'GET, OPTIONS';\n            add_header Access-Control-Allow-Headers 'Content-Type';\n\n            # Compression\n            gzip on;\n            gzip_types application/json;\n        }\n    }\n}\n</code></pre>"},{"location":"architecture/s3-cdn/#cache-headers","title":"Cache Headers","text":"Header \u0417\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 <code>X-Cache-Status</code> HIT/MISS/EXPIRED \u0421\u0442\u0430\u0442\u0443\u0441 \u043a\u044d\u0448\u0430 <code>Cache-Control</code> max-age=300 TTL 5 \u043c\u0438\u043d\u0443\u0442 <code>ETag</code> hash \u0414\u043b\u044f conditional requests"},{"location":"architecture/s3-cdn/#reports-service-implementation","title":"Reports Service Implementation","text":""},{"location":"architecture/s3-cdn/#s3-client","title":"S3 Client","text":"<pre><code># reports-service/app/services/s3_service.py\nimport boto3\nfrom botocore.config import Config\n\nclass S3Service:\n    def __init__(self):\n        self.client = boto3.client(\n            's3',\n            endpoint_url=os.getenv('S3_ENDPOINT_URL', 'http://minio:9000'),\n            aws_access_key_id=os.getenv('S3_ACCESS_KEY', 'minioadmin'),\n            aws_secret_access_key=os.getenv('S3_SECRET_KEY', 'minioadmin123'),\n            config=Config(signature_version='s3v4'),\n            region_name=os.getenv('S3_REGION', 'us-east-1')\n        )\n        self.bucket = os.getenv('S3_BUCKET_NAME', 'reports-bucket')\n\n    def check_exists(self, key: str) -&gt; bool:\n        \"\"\"\u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u043e\u0432\u0430\u043d\u0438\u0435 \u043e\u0431\u044a\u0435\u043a\u0442\u0430\"\"\"\n        try:\n            self.client.head_object(Bucket=self.bucket, Key=key)\n            return True\n        except:\n            return False\n\n    def put_report(self, key: str, data: dict) -&gt; str:\n        \"\"\"\u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u043e\u0442\u0447\u0451\u0442 \u0432 S3\"\"\"\n        self.client.put_object(\n            Bucket=self.bucket,\n            Key=key,\n            Body=json.dumps(data, ensure_ascii=False),\n            ContentType='application/json'\n        )\n        return self.get_cdn_url(key)\n\n    def delete_report(self, key: str):\n        \"\"\"\u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043e\u0442\u0447\u0451\u0442 \u0438\u0437 S3\"\"\"\n        self.client.delete_object(Bucket=self.bucket, Key=key)\n\n    def get_cdn_url(self, key: str) -&gt; str:\n        \"\"\"\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c CDN URL \u0434\u043b\u044f \u043e\u0431\u044a\u0435\u043a\u0442\u0430\"\"\"\n        cdn_base = os.getenv('CDN_BASE_URL', 'http://localhost:8002')\n        return f\"{cdn_base}/reports/{key}\"\n</code></pre>"},{"location":"architecture/s3-cdn/#cdn-endpoints","title":"CDN Endpoints","text":"<pre><code># reports-service/app/main.py\n\n@app.get(\"/api/reports/cdn/list\")\nasync def get_reports_cdn(\n    user: dict = Depends(get_current_user),\n    s3: S3Service = Depends(),\n    ch: ClickHouseService = Depends()\n):\n    \"\"\"\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c CDN URL \u0434\u043b\u044f \u0441\u043f\u0438\u0441\u043a\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432\"\"\"\n    user_id = user.get(\"sub\")\n    key = f\"{user_id}/list/reports.json\"\n\n    if not s3.check_exists(key):\n        # Cache miss - \u0433\u0435\u043d\u0435\u0440\u0438\u0440\u0443\u0435\u043c \u043e\u0442\u0447\u0451\u0442\n        reports = await ch.get_user_reports(user.get(\"preferred_username\"))\n        cdn_url = s3.put_report(key, reports)\n    else:\n        cdn_url = s3.get_cdn_url(key)\n\n    return {\"cdn_url\": cdn_url}\n\n@app.get(\"/api/reports/cdn/{date}\")\nasync def get_report_cdn(\n    date: str,\n    user: dict = Depends(get_current_user),\n    s3: S3Service = Depends(),\n    ch: ClickHouseService = Depends()\n):\n    \"\"\"\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c CDN URL \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u0430 \u0437\u0430 \u0434\u0430\u0442\u0443\"\"\"\n    user_id = user.get(\"sub\")\n    key = f\"{user_id}/daily/{date}/report.json\"\n\n    if not s3.check_exists(key):\n        report = await ch.get_report_by_date(\n            user.get(\"preferred_username\"), date\n        )\n        cdn_url = s3.put_report(key, report)\n    else:\n        cdn_url = s3.get_cdn_url(key)\n\n    return {\"cdn_url\": cdn_url, \"date\": date}\n</code></pre>"},{"location":"architecture/s3-cdn/#cache-invalidation","title":"Cache Invalidation","text":""},{"location":"architecture/s3-cdn/#after-etl","title":"After ETL","text":"<pre><code># airflow/dags/bionicpro_reports_etl.py\n\ndef invalidate_cache(**context):\n    \"\"\"\u0418\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u043a\u044d\u0448\u0430 \u043f\u043e\u0441\u043b\u0435 ETL\"\"\"\n    import requests\n\n    # \u041f\u043e\u043b\u0443\u0447\u0438\u0442\u044c \u0441\u043f\u0438\u0441\u043e\u043a user_ids, \u0434\u043b\u044f \u043a\u043e\u0442\u043e\u0440\u044b\u0445 \u043e\u0431\u043d\u043e\u0432\u0438\u043b\u0438\u0441\u044c \u0434\u0430\u043d\u043d\u044b\u0435\n    user_ids = context['ti'].xcom_pull(task_ids='load_to_clickhouse')\n\n    # \u0412\u044b\u0437\u0432\u0430\u0442\u044c \u0438\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044e \u0434\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0433\u043e \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\n    for user_id in user_ids:\n        requests.post(\n            'http://reports-service:8001/api/reports/invalidate',\n            json={'user_id': user_id}\n        )\n</code></pre>"},{"location":"architecture/s3-cdn/#invalidation-endpoint","title":"Invalidation Endpoint","text":"<pre><code>@app.post(\"/api/reports/invalidate\")\nasync def invalidate_cache(\n    request: InvalidateRequest,\n    s3: S3Service = Depends(),\n    redis: Redis = Depends()\n):\n    \"\"\"\u0418\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u043a\u044d\u0448\u0430 \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\"\"\"\n    user_id = request.user_id\n\n    # \u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043e\u0431\u044a\u0435\u043a\u0442\u044b \u0438\u0437 S3\n    s3.delete_prefix(f\"{user_id}/\")\n\n    # \u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c Redis \u043a\u044d\u0448\n    pattern = f\"report:{user_id}:*\"\n    keys = redis.keys(pattern)\n    if keys:\n        redis.delete(*keys)\n\n    # CDN \u043a\u044d\u0448 \u0438\u0441\u0442\u0435\u0447\u0451\u0442 \u043f\u043e TTL (5 \u043c\u0438\u043d\u0443\u0442)\n\n    return {\"status\": \"invalidated\", \"user_id\": user_id}\n</code></pre>"},{"location":"architecture/s3-cdn/#cdn-api-endpoints","title":"CDN API Endpoints","text":"Method Endpoint \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 GET <code>/api/reports/cdn/list</code> CDN URL \u0434\u043b\u044f \u0441\u043f\u0438\u0441\u043a\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 GET <code>/api/reports/cdn/summary</code> CDN URL \u0434\u043b\u044f \u0441\u0432\u043e\u0434\u043a\u0438 GET <code>/api/reports/cdn/{date}</code> CDN URL \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u0430 \u0437\u0430 \u0434\u0430\u0442\u0443 POST <code>/api/reports/invalidate</code> \u0418\u043d\u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f \u043a\u044d\u0448\u0430 (admin)"},{"location":"architecture/s3-cdn/#performance-benefits","title":"Performance Benefits","text":""},{"location":"architecture/s3-cdn/#_4","title":"\u0411\u0435\u0437 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f","text":"<pre><code>User Request \u2192 BFF \u2192 Reports Service \u2192 ClickHouse \u2192 Response\nLatency: 200-500ms per request\nClickHouse load: High (every request)\n</code></pre>"},{"location":"architecture/s3-cdn/#_5","title":"\u0421 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c","text":"<pre><code>User Request \u2192 BFF \u2192 Reports Service \u2192 S3 (HEAD) \u2192 CDN URL\nUser Request \u2192 CDN \u2192 S3 (or cache) \u2192 Response\nLatency: 20-50ms (cache hit)\nClickHouse load: Low (only on cache miss)\n</code></pre>"},{"location":"architecture/s3-cdn/#metrics","title":"Metrics","text":"\u041c\u0435\u0442\u0440\u0438\u043a\u0430 \u0411\u0435\u0437 \u043a\u044d\u0448\u0430 \u0421 \u043a\u044d\u0448\u0435\u043c Latency (p50) 200ms 30ms Latency (p99) 500ms 100ms ClickHouse queries/min 100+ 5-10 S3 storage - ~10MB/1000 users"},{"location":"architecture/s3-cdn/#troubleshooting","title":"Troubleshooting","text":""},{"location":"architecture/s3-cdn/#minio","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 MinIO","text":"<pre><code># Health check\ncurl -s http://localhost:9002/minio/health/live\n\n# \u0421\u043f\u0438\u0441\u043e\u043a \u043e\u0431\u044a\u0435\u043a\u0442\u043e\u0432 \u0432 bucket\ndocker-compose exec minio mc ls local/reports-bucket --recursive\n</code></pre>"},{"location":"architecture/s3-cdn/#cdn","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 CDN","text":"<pre><code># Health check\ncurl -I http://localhost:8002/health\n\n# \u0417\u0430\u043f\u0440\u043e\u0441 \u0441 \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u043e\u0439 cache status\ncurl -I http://localhost:8002/reports/user-id/list/reports.json\n# X-Cache-Status: HIT \u0438\u043b\u0438 MISS\n</code></pre>"},{"location":"architecture/s3-cdn/#_6","title":"\u041e\u0447\u0438\u0441\u0442\u043a\u0430 \u043a\u044d\u0448\u0430","text":"<pre><code># \u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c Nginx cache\ndocker-compose exec nginx-cdn rm -rf /var/cache/nginx/*\n\n# \u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c S3 bucket\ndocker-compose exec minio mc rm --recursive --force local/reports-bucket/\n\n# \u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c Redis\ndocker-compose exec redis redis-cli FLUSHDB\n</code></pre>"},{"location":"architecture/s3-cdn/#_7","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture Overview</li> <li>Reports &amp; ETL</li> <li>CDC Pipeline</li> </ul>"},{"location":"architecture/security/","title":"Security Architecture (Task 1)","text":""},{"location":"architecture/security/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u0417\u0430\u0434\u0430\u043d\u0438\u0435 1 \u0440\u0435\u0430\u043b\u0438\u0437\u0443\u0435\u0442 \u0443\u0441\u0438\u043b\u0435\u043d\u043d\u0443\u044e \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0443 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438 \u0441 \u0435\u0434\u0438\u043d\u044b\u043c \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435\u043c \u0434\u043e\u0441\u0442\u0443\u043f\u043e\u043c \u0438 \u043f\u0430\u0442\u0442\u0435\u0440\u043d\u043e\u043c BFF (Backend-for-Frontend).</p>"},{"location":"architecture/security/#_2","title":"\u0420\u0435\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u044b\u0435 \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e\u0441\u0442\u0438","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 LDAP User Federation \u0426\u0435\u043d\u0442\u0440\u0430\u043b\u0438\u0437\u043e\u0432\u0430\u043d\u043d\u043e\u0435 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c\u0438 \u0447\u0435\u0440\u0435\u0437 OpenLDAP BFF Pattern \u0421\u0435\u0440\u0432\u0435\u0440\u043d\u043e\u0435 \u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435 \u0442\u043e\u043a\u0435\u043d\u043e\u0432, HTTP-only session cookies OAuth2 PKCE \u0411\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u044b\u0439 authorization code flow \u0441 S256 challenge Identity Brokering \u041f\u043e\u0434\u0434\u0435\u0440\u0436\u043a\u0430 \u0432\u043d\u0435\u0448\u043d\u0438\u0445 IdP (\u042f\u043d\u0434\u0435\u043a\u0441 ID, Google, Apple) MFA/TOTP \u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u0434\u0432\u0443\u0445\u0444\u0430\u043a\u0442\u043e\u0440\u043d\u0430\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f"},{"location":"architecture/security/#_3","title":"\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043d\u0430\u044f \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430","text":"<pre><code>graph TB\n    subgraph \"External Users\"\n        U1[\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430]\n        U2[\u041f\u043e\u043a\u0443\u043f\u0430\u0442\u0435\u043b\u044c]\n        U3[\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440]\n        U4[ML-\u0438\u043d\u0436\u0435\u043d\u0435\u0440]\n    end\n\n    subgraph \"External IdPs\"\n        LDAP_RU[LDAP Russia]\n        LDAP_EU[LDAP Europe]\n        YA[\u042f\u043d\u0434\u0435\u043a\u0441 ID]\n        OTHER[Other IdP]\n    end\n\n    subgraph \"BionicPRO Security\"\n        FE[Mobile App / Web]\n        KC[Keycloak&lt;br/&gt;Identity Broker]\n        BFF[bionicpro-auth&lt;br/&gt;BFF Service]\n        REDIS[(Redis&lt;br/&gt;Session Store)]\n        API[API Gateway]\n    end\n\n    subgraph \"Data\"\n        CRM[(CRM DB)]\n        TEL[(Telemetry DB)]\n    end\n\n    U1 --&gt; FE\n    U2 --&gt; FE\n    U3 --&gt; API\n    U4 --&gt; TEL\n\n    FE --&gt;|Session Cookie| BFF\n    BFF --&gt;|OAuth2 PKCE| KC\n    BFF --&gt;|Encrypted tokens| REDIS\n    API --&gt;|Validate session| BFF\n\n    KC --&gt;|User Federation| LDAP_RU\n    KC --&gt;|User Federation| LDAP_EU\n    KC --&gt;|Identity Brokering| YA\n    KC --&gt;|Identity Brokering| OTHER\n\n    API --&gt; CRM\n    API --&gt; TEL</code></pre>"},{"location":"architecture/security/#bff-pattern-backend-for-frontend","title":"BFF Pattern (Backend-for-Frontend)","text":""},{"location":"architecture/security/#_4","title":"\u041f\u0440\u0438\u043d\u0446\u0438\u043f \u0440\u0430\u0431\u043e\u0442\u044b","text":"<pre><code>sequenceDiagram\n    participant FE as Frontend\n    participant BFF as BFF Auth\n    participant KC as Keycloak\n    participant R as Redis\n\n    Note over FE,R: Login Flow\n    FE-&gt;&gt;BFF: GET /auth/login\n    BFF-&gt;&gt;BFF: Generate PKCE&lt;br/&gt;(code_verifier, code_challenge)\n    BFF-&gt;&gt;R: Store code_verifier (state key)\n    BFF-&gt;&gt;FE: Redirect to Keycloak&lt;br/&gt;+ code_challenge (S256)\n\n    FE-&gt;&gt;KC: Authorization Request\n    KC-&gt;&gt;FE: Auth Code\n\n    FE-&gt;&gt;BFF: GET /auth/callback?code=xxx\n    BFF-&gt;&gt;R: Get code_verifier\n    BFF-&gt;&gt;KC: Token Exchange&lt;br/&gt;+ code_verifier\n    KC-&gt;&gt;BFF: Access + Refresh tokens\n    BFF-&gt;&gt;R: Store encrypted tokens\n    BFF-&gt;&gt;FE: Set-Cookie: session_id&lt;br/&gt;(HTTP-only, Secure)\n\n    Note over FE,R: API Request\n    FE-&gt;&gt;BFF: GET /api/reports&lt;br/&gt;Cookie: session_id\n    BFF-&gt;&gt;R: Get tokens by session\n    BFF-&gt;&gt;BFF: Decrypt tokens\n    BFF-&gt;&gt;API: Request + Bearer token</code></pre>"},{"location":"architecture/security/#bff","title":"\u041f\u0440\u0435\u0438\u043c\u0443\u0449\u0435\u0441\u0442\u0432\u0430 BFF","text":"\u0410\u0441\u043f\u0435\u043a\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0411\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u044c \u0442\u043e\u043a\u0435\u043d\u043e\u0432 Access/Refresh \u0442\u043e\u043a\u0435\u043d\u044b \u043d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043f\u043e\u043f\u0430\u0434\u0430\u044e\u0442 \u043d\u0430 \u043a\u043b\u0438\u0435\u043d\u0442 \u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u043e\u0435 \u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0435 BFF \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043e\u0431\u043d\u043e\u0432\u043b\u044f\u0435\u0442 access_token \u043f\u043e refresh_token Session Fixation Protection \u0420\u043e\u0442\u0430\u0446\u0438\u044f session ID \u043f\u043e\u0441\u043b\u0435 \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438 XSS Protection HTTP-only cookies \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b \u0438\u0437 JavaScript CSRF Protection SameSite cookie attribute"},{"location":"architecture/security/#bff_1","title":"\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f BFF","text":"<pre><code># bionicpro-auth/app.py\nSECURE_COOKIES = os.getenv(\"SECURE_COOKIES\", \"true\").lower() == \"true\"\nSESSION_COOKIE_HTTPONLY = True\nSESSION_COOKIE_SECURE = SECURE_COOKIES\nSESSION_COOKIE_SAMESITE = \"Lax\"\n</code></pre>"},{"location":"architecture/security/#keycloak-configuration","title":"Keycloak Configuration","text":""},{"location":"architecture/security/#user-federation-ldap","title":"User Federation (LDAP)","text":"<p>Keycloak \u0441\u0438\u043d\u0445\u0440\u043e\u043d\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0441 LDAP \u0441\u0435\u0440\u0432\u0435\u0440\u0430\u043c\u0438 \u043f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u0438\u0442\u0435\u043b\u044c\u0441\u0442\u0432:</p> <pre><code># \u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f \u0432 realm-export.json\nuserFederation:\n  - name: ldap-russia\n    providerId: ldap\n    config:\n      connectionUrl: ldap://ldap:389\n      usersDn: ou=People,dc=bionicpro,dc=com\n      bindDn: cn=admin,dc=bionicpro,dc=com\n      userObjectClasses: inetOrgPerson\n      usernameAttribute: uid\n      syncRegistrations: true\n</code></pre>"},{"location":"architecture/security/#identity-brokering-id","title":"Identity Brokering (\u042f\u043d\u0434\u0435\u043a\u0441 ID)","text":"<pre><code># \u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f \u0432\u043d\u0435\u0448\u043d\u0435\u0433\u043e IdP\nidentityProviders:\n  - alias: yandex\n    providerId: oidc\n    config:\n      authorizationUrl: https://oauth.yandex.ru/authorize\n      tokenUrl: https://oauth.yandex.ru/token\n      userInfoUrl: https://login.yandex.ru/info\n      clientId: ${YANDEX_CLIENT_ID}\n      clientSecret: ${YANDEX_CLIENT_SECRET}\n</code></pre>"},{"location":"architecture/security/#mfatotp-configuration","title":"MFA/TOTP Configuration","text":"<pre><code># \u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u0430\u044f \u0434\u0432\u0443\u0445\u0444\u0430\u043a\u0442\u043e\u0440\u043d\u0430\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f\nrequiredActions:\n  - CONFIGURE_TOTP\n\nauthenticationFlows:\n  - alias: browser-with-otp\n    authenticationExecutions:\n      - authenticator: auth-username-password-form\n        requirement: REQUIRED\n      - authenticator: auth-otp-form\n        requirement: REQUIRED\n</code></pre>"},{"location":"architecture/security/#ldap-structure","title":"LDAP Structure","text":"<pre><code>dc=bionicpro,dc=com\n\u251c\u2500\u2500 ou=People\n\u2502   \u251c\u2500\u2500 uid=ivan.petrov\n\u2502   \u2502   \u251c\u2500\u2500 cn: Ivan Petrov\n\u2502   \u2502   \u251c\u2500\u2500 mail: ivan.petrov@bionicpro.com\n\u2502   \u2502   \u2514\u2500\u2500 employeeType: prothetic_user\n\u2502   \u251c\u2500\u2500 uid=maria.sidorova\n\u2502   \u251c\u2500\u2500 uid=alexey.kozlov\n\u2502   \u251c\u2500\u2500 uid=john.mueller\n\u2502   \u2514\u2500\u2500 uid=anna.schmidt\n\u251c\u2500\u2500 ou=Groups\n\u2502   \u251c\u2500\u2500 cn=prothetic_users\n\u2502   \u251c\u2500\u2500 cn=users\n\u2502   \u2514\u2500\u2500 cn=administrators\n\u2514\u2500\u2500 ou=Roles\n    \u251c\u2500\u2500 cn=prothetic_user\n    \u251c\u2500\u2500 cn=user\n    \u2514\u2500\u2500 cn=administrator\n</code></pre>"},{"location":"architecture/security/#_5","title":"\u0422\u0435\u0441\u0442\u043e\u0432\u044b\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438","text":"Username Password \u0420\u043e\u043b\u044c \u0420\u0435\u0433\u0438\u043e\u043d ivan.petrov password123 prothetic_user \u0420\u043e\u0441\u0441\u0438\u044f maria.sidorova password123 user \u0420\u043e\u0441\u0441\u0438\u044f alexey.kozlov password123 administrator \u0420\u043e\u0441\u0441\u0438\u044f john.mueller password123 prothetic_user \u0415\u0432\u0440\u043e\u043f\u0430 anna.schmidt password123 user \u0415\u0432\u0440\u043e\u043f\u0430"},{"location":"architecture/security/#oauth2-pkce-flow","title":"OAuth2 PKCE Flow","text":""},{"location":"architecture/security/#pkce","title":"\u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f PKCE","text":"<pre><code>import secrets\nimport hashlib\nimport base64\n\ndef generate_pkce():\n    # code_verifier: 43-128 \u0441\u0438\u043c\u0432\u043e\u043b\u043e\u0432\n    code_verifier = secrets.token_urlsafe(32)\n\n    # code_challenge: SHA256(code_verifier), base64url encoded\n    digest = hashlib.sha256(code_verifier.encode()).digest()\n    code_challenge = base64.urlsafe_b64encode(digest).rstrip(b'=').decode()\n\n    return code_verifier, code_challenge\n</code></pre>"},{"location":"architecture/security/#authorization-request","title":"Authorization Request","text":"<pre><code>GET /realms/reports-realm/protocol/openid-connect/auth\n    ?client_id=bionicpro-auth\n    &amp;response_type=code\n    &amp;scope=openid profile email\n    &amp;redirect_uri=http://localhost:8000/auth/callback\n    &amp;state=abc123\n    &amp;code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM\n    &amp;code_challenge_method=S256\n</code></pre>"},{"location":"architecture/security/#token-exchange","title":"Token Exchange","text":"<pre><code>POST /realms/reports-realm/protocol/openid-connect/token\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code\n&amp;code=xxx\n&amp;redirect_uri=http://localhost:8000/auth/callback\n&amp;client_id=bionicpro-auth\n&amp;code_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk\n</code></pre>"},{"location":"architecture/security/#session-management","title":"Session Management","text":""},{"location":"architecture/security/#redis-storage-structure","title":"Redis Storage Structure","text":"<pre><code>session:{session_id}:\n  access_token: &lt;encrypted&gt;\n  refresh_token: &lt;encrypted&gt;\n  user_info: {\n    sub: \"user-uuid\",\n    preferred_username: \"ivan.petrov\",\n    email: \"ivan.petrov@bionicpro.com\",\n    roles: [\"prothetic_user\"]\n  }\n  created_at: 1704067200\n  expires_at: 1704070800\n</code></pre>"},{"location":"architecture/security/#token-encryption","title":"Token Encryption","text":"<pre><code>from cryptography.fernet import Fernet\n\n# ENCRYPTION_KEY \u0438\u0437 .env\nfernet = Fernet(os.getenv(\"ENCRYPTION_KEY\"))\n\ndef encrypt_token(token: str) -&gt; str:\n    return fernet.encrypt(token.encode()).decode()\n\ndef decrypt_token(encrypted: str) -&gt; str:\n    return fernet.decrypt(encrypted.encode()).decode()\n</code></pre>"},{"location":"architecture/security/#security-headers","title":"Security Headers","text":"<pre><code># Response headers\n@app.after_request\ndef security_headers(response):\n    response.headers['X-Content-Type-Options'] = 'nosniff'\n    response.headers['X-Frame-Options'] = 'DENY'\n    response.headers['X-XSS-Protection'] = '1; mode=block'\n    response.headers['Strict-Transport-Security'] = 'max-age=31536000'\n    return response\n</code></pre>"},{"location":"architecture/security/#endpoints","title":"Endpoints","text":"Method Endpoint \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 GET <code>/auth/login</code> \u0418\u043d\u0438\u0446\u0438\u0430\u0446\u0438\u044f OAuth2 PKCE flow GET <code>/auth/callback</code> OAuth2 callback, \u043e\u0431\u043c\u0435\u043d \u043a\u043e\u0434\u0430 \u043d\u0430 \u0442\u043e\u043a\u0435\u043d\u044b POST <code>/auth/logout</code> \u0417\u0430\u0432\u0435\u0440\u0448\u0435\u043d\u0438\u0435 \u0441\u0435\u0441\u0441\u0438\u0438 GET <code>/auth/me</code> \u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f \u043e \u0442\u0435\u043a\u0443\u0449\u0435\u043c \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435 GET <code>/health</code> Health check"},{"location":"architecture/security/#yandex-id","title":"\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f (Yandex ID)","text":"<p>\u0414\u043b\u044f \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0432\u0445\u043e\u0434\u0430 \u0447\u0435\u0440\u0435\u0437 \u042f\u043d\u0434\u0435\u043a\u0441 ID:</p> <ol> <li>\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0439\u0442\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u043d\u0430 https://oauth.yandex.ru/</li> <li>\u0423\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0435 Callback URL: <code>http://localhost:8080/realms/reports-realm/broker/yandex/endpoint</code></li> <li>\u0414\u043e\u0431\u0430\u0432\u044c\u0442\u0435 \u0432 <code>.env</code>:</li> </ol> <pre><code>YANDEX_CLIENT_ID=your-client-id\nYANDEX_CLIENT_SECRET=your-client-secret\n</code></pre>"},{"location":"architecture/security/#troubleshooting","title":"Troubleshooting","text":""},{"location":"architecture/security/#invalid-token-error","title":"Invalid token error","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 Keycloak\ncurl -s http://localhost:8080/health/ready\n\n# \u041e\u0447\u0438\u0441\u0442\u0438\u0442\u0435 Redis \u043a\u044d\u0448\ndocker-compose exec redis redis-cli FLUSHALL\n</code></pre>"},{"location":"architecture/security/#ldap-connection-failed","title":"LDAP connection failed","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u044c\u0442\u0435 LDAP\nldapsearch -x -H ldap://localhost:389 \\\n  -D \"cn=admin,dc=bionicpro,dc=com\" \\\n  -w admin \\\n  -b \"ou=People,dc=bionicpro,dc=com\"\n</code></pre>"},{"location":"architecture/security/#_6","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture Overview</li> <li>Deployment Guide</li> <li>Auth API Reference</li> </ul>"},{"location":"deployment/environment/","title":"Environment Setup","text":""},{"location":"deployment/environment/#_1","title":"\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435 \u043e\u043a\u0440\u0443\u0436\u0435\u043d\u0438\u044f","text":""},{"location":"deployment/environment/#_2","title":"\u041e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435","text":"\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u0430\u044f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f <code>AIRFLOW_FERNET_KEY</code> \u0428\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u0432 Airflow Fernet key <code>ENCRYPTION_KEY</code> \u0428\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0442\u043e\u043a\u0435\u043d\u043e\u0432 \u0432 Redis Fernet key <code>JWT_SECRET_KEY</code> \u041f\u043e\u0434\u043f\u0438\u0441\u044c JWT \u0442\u043e\u043a\u0435\u043d\u043e\u0432 Random string"},{"location":"deployment/environment/#_3","title":"\u041e\u043f\u0446\u0438\u043e\u043d\u0430\u043b\u044c\u043d\u044b\u0435 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435","text":"\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u0430\u044f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u041f\u043e \u0443\u043c\u043e\u043b\u0447\u0430\u043d\u0438\u044e <code>YANDEX_CLIENT_ID</code> ID \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f \u042f\u043d\u0434\u0435\u043a\u0441 - <code>YANDEX_CLIENT_SECRET</code> \u0421\u0435\u043a\u0440\u0435\u0442 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f \u042f\u043d\u0434\u0435\u043a\u0441 -"},{"location":"deployment/environment/#_4","title":"\u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f \u043a\u043b\u044e\u0447\u0435\u0439","text":""},{"location":"deployment/environment/#fernet-key-airflow_fernet_key-encryption_key","title":"Fernet Key (\u0434\u043b\u044f AIRFLOW_FERNET_KEY \u0438 ENCRYPTION_KEY)","text":"<pre><code>python3 -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"\n</code></pre> <p>\u0420\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442: 44 \u0441\u0438\u043c\u0432\u043e\u043b\u0430, base64-encoded, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440: <pre><code>Wv1Qp3R5t7Y9uBdEfGhJkLmNoP2sUwXz4a6C8i0qR1s=\n</code></pre></p>"},{"location":"deployment/environment/#jwt-secret-key","title":"JWT Secret Key","text":"<pre><code># \u0412\u0430\u0440\u0438\u0430\u043d\u0442 1: Python\npython3 -c \"import secrets; print(secrets.token_urlsafe(32))\"\n\n# \u0412\u0430\u0440\u0438\u0430\u043d\u0442 2: OpenSSL\nopenssl rand -base64 32\n</code></pre> <p>\u0420\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442: 43 \u0441\u0438\u043c\u0432\u043e\u043b\u0430, \u043d\u0430\u043f\u0440\u0438\u043c\u0435\u0440: <pre><code>kL3mN5pQ7rS9tV1xZ3bD5fH7jL9nP1sU3wY5a7c9e1g\n</code></pre></p>"},{"location":"deployment/environment/#env","title":"\u0424\u0430\u0439\u043b .env","text":""},{"location":"deployment/environment/#_5","title":"\u041c\u0438\u043d\u0438\u043c\u0430\u043b\u044c\u043d\u0430\u044f \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f","text":"<pre><code># .env\n\n# Airflow Fernet Key\nAIRFLOW_FERNET_KEY=Wv1Qp3R5t7Y9uBdEfGhJkLmNoP2sUwXz4a6C8i0qR1s=\n\n# BFF Encryption Key\nENCRYPTION_KEY=kL3mN5pQ7rS9tV1xZ3bD5fH7jL9nP1sU3wY5a7c9e1g=\n\n# JWT Secret Key\nJWT_SECRET_KEY=your-secure-jwt-secret-key-here-32chars\n</code></pre>"},{"location":"deployment/environment/#_6","title":"\u041f\u043e\u043b\u043d\u0430\u044f \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f","text":"<pre><code># .env\n\n# ============================================================================\n# REQUIRED\n# ============================================================================\n\nAIRFLOW_FERNET_KEY=Wv1Qp3R5t7Y9uBdEfGhJkLmNoP2sUwXz4a6C8i0qR1s=\nENCRYPTION_KEY=kL3mN5pQ7rS9tV1xZ3bD5fH7jL9nP1sU3wY5a7c9e1g=\nJWT_SECRET_KEY=your-secure-jwt-secret-key-here-32chars\n\n# ============================================================================\n# OPTIONAL - Yandex ID Integration\n# ============================================================================\n\n# Register at https://oauth.yandex.ru/\n# Callback URL: http://localhost:8080/realms/reports-realm/broker/yandex/endpoint\nYANDEX_CLIENT_ID=your-yandex-client-id\nYANDEX_CLIENT_SECRET=your-yandex-client-secret\n</code></pre>"},{"location":"deployment/environment/#yandex-id","title":"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 Yandex ID","text":""},{"location":"deployment/environment/#1","title":"\u0428\u0430\u0433 1: \u0420\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f","text":"<ol> <li>\u041f\u0435\u0440\u0435\u0439\u0434\u0438\u0442\u0435 \u043d\u0430 https://oauth.yandex.ru/</li> <li>\u041d\u0430\u0436\u043c\u0438\u0442\u0435 \"\u0417\u0430\u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043d\u043e\u0432\u043e\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435\"</li> <li>\u0417\u0430\u043f\u043e\u043b\u043d\u0438\u0442\u0435 \u0444\u043e\u0440\u043c\u0443:</li> <li>\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435: BionicPRO</li> <li>\u041f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u044b: \u0412\u0435\u0431-\u0441\u0435\u0440\u0432\u0438\u0441\u044b</li> <li>Callback URL: <code>http://localhost:8080/realms/reports-realm/broker/yandex/endpoint</code></li> </ol>"},{"location":"deployment/environment/#2","title":"\u0428\u0430\u0433 2: \u041f\u0440\u0430\u0432\u0430 \u0434\u043e\u0441\u0442\u0443\u043f\u0430","text":"<p>\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u043f\u0440\u0430\u0432\u0430: - <code>login:info</code> \u2014 \u0431\u0430\u0437\u043e\u0432\u0430\u044f \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f - <code>login:email</code> \u2014 email \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f</p>"},{"location":"deployment/environment/#3-credentials","title":"\u0428\u0430\u0433 3: \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 credentials","text":"<p>\u041f\u043e\u0441\u043b\u0435 \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f: - ClientID \u2192 <code>YANDEX_CLIENT_ID</code> - Client secret \u2192 <code>YANDEX_CLIENT_SECRET</code></p>"},{"location":"deployment/environment/#_7","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u043a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u0438","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043d\u0430\u043b\u0438\u0447\u0438\u0435 .env \u0444\u0430\u0439\u043b\u0430\nls -la .env\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0443 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0445 Docker Compose\ndocker-compose config | grep -E \"AIRFLOW_FERNET_KEY|ENCRYPTION_KEY|JWT_SECRET_KEY\"\n</code></pre>"},{"location":"deployment/environment/#_8","title":"\u0411\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u044c","text":"<p>\u0412\u0430\u0436\u043d\u043e</p> <ul> <li>\u041d\u0438\u043a\u043e\u0433\u0434\u0430 \u043d\u0435 \u043a\u043e\u043c\u043c\u0438\u0442\u044c\u0442\u0435 <code>.env</code> \u0432 \u0440\u0435\u043f\u043e\u0437\u0438\u0442\u043e\u0440\u0438\u0439</li> <li>\u0418\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435 \u0440\u0430\u0437\u043d\u044b\u0435 \u043a\u043b\u044e\u0447\u0438 \u0434\u043b\u044f \u0440\u0430\u0437\u043d\u044b\u0445 \u0441\u0440\u0435\u0434 (dev/staging/prod)</li> <li>\u041f\u0435\u0440\u0438\u043e\u0434\u0438\u0447\u0435\u0441\u043a\u0438 \u0440\u043e\u0442\u0438\u0440\u0443\u0439\u0442\u0435 \u043a\u043b\u044e\u0447\u0438 \u0432 production</li> </ul>"},{"location":"deployment/environment/#gitignore","title":"\u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 .gitignore","text":"<pre><code># .env \u0434\u043e\u043b\u0436\u0435\u043d \u0431\u044b\u0442\u044c \u0432 .gitignore\ngrep \".env\" .gitignore\n</code></pre>"},{"location":"deployment/environment/#production","title":"Production \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0430\u0446\u0438\u0438","text":"<p>\u0414\u043b\u044f production \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0439\u0442\u0435:</p> <ul> <li>HashiCorp Vault</li> <li>AWS Secrets Manager</li> <li>Azure Key Vault</li> <li>Google Secret Manager</li> </ul> <p>\u041f\u0440\u0438\u043c\u0435\u0440 \u0441 Docker Secrets:</p> <pre><code># docker-compose.prod.yaml\nservices:\n  airflow-webserver:\n    secrets:\n      - airflow_fernet_key\n    environment:\n      AIRFLOW__CORE__FERNET_KEY_FILE: /run/secrets/airflow_fernet_key\n\nsecrets:\n  airflow_fernet_key:\n    external: true\n</code></pre>"},{"location":"deployment/environment/#_9","title":"\u041f\u0435\u0440\u0435\u043e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043d\u0430\u0441\u0442\u0440\u043e\u0435\u043a","text":""},{"location":"deployment/environment/#_10","title":"\u0414\u043b\u044f \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u043a\u0438","text":"<pre><code># \u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c debug mode\nexport DEBUG=true\ndocker-compose up -d\n</code></pre>"},{"location":"deployment/environment/#_11","title":"\u0414\u043b\u044f \u0442\u0435\u0441\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f","text":"<pre><code># \u0418\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u044c \u043e\u0442\u0434\u0435\u043b\u044c\u043d\u044b\u0439 .env \u0444\u0430\u0439\u043b\ndocker-compose --env-file .env.test up -d\n</code></pre>"},{"location":"deployment/environment/#_12","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Quick Start</li> <li>Service Reference</li> <li>Security Architecture</li> </ul>"},{"location":"deployment/quickstart/","title":"Quick Start Guide","text":""},{"location":"deployment/quickstart/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u042d\u0442\u043e \u0440\u0443\u043a\u043e\u0432\u043e\u0434\u0441\u0442\u0432\u043e \u043f\u043e\u043c\u043e\u0436\u0435\u0442 \u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c BionicPRO \u0437\u0430 \u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043c\u0438\u043d\u0443\u0442.</p>"},{"location":"deployment/quickstart/#_2","title":"\u0422\u0440\u0435\u0431\u043e\u0432\u0430\u043d\u0438\u044f","text":"<ul> <li>Docker Engine 20.10+</li> <li>Docker Compose 2.0+</li> <li>8GB RAM \u043c\u0438\u043d\u0438\u043c\u0443\u043c (16GB \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u0435\u0442\u0441\u044f)</li> <li>20GB \u0441\u0432\u043e\u0431\u043e\u0434\u043d\u043e\u0433\u043e \u043c\u0435\u0441\u0442\u0430 \u043d\u0430 \u0434\u0438\u0441\u043a\u0435</li> <li>Python 3.8+ (\u0442\u043e\u043b\u044c\u043a\u043e \u0434\u043b\u044f \u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u0438 \u043a\u043b\u044e\u0447\u0435\u0439)</li> </ul>"},{"location":"deployment/quickstart/#1","title":"\u0428\u0430\u0433 1: \u041a\u043b\u043e\u043d\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0440\u0435\u043f\u043e\u0437\u0438\u0442\u043e\u0440\u0438\u044f","text":"<pre><code>git clone &lt;repository-url&gt;\ncd architecture-bionicpro\n</code></pre>"},{"location":"deployment/quickstart/#2","title":"\u0428\u0430\u0433 2: \u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0445 \u043e\u043a\u0440\u0443\u0436\u0435\u043d\u0438\u044f","text":""},{"location":"deployment/quickstart/#env","title":"\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u0444\u0430\u0439\u043b\u0430 .env","text":"<pre><code>cp .env.example .env\n</code></pre>"},{"location":"deployment/quickstart/#_3","title":"\u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f \u043a\u043b\u044e\u0447\u0435\u0439","text":"<p>\u0421\u0438\u0441\u0442\u0435\u043c\u0430 \u0442\u0440\u0435\u0431\u0443\u0435\u0442 \u0442\u0440\u0438 \u0441\u0435\u043a\u0440\u0435\u0442\u043d\u044b\u0445 \u043a\u043b\u044e\u0447\u0430:</p> <pre><code># 1. Airflow Fernet Key\npython3 -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"\n\n# 2. BFF Encryption Key\npython3 -c \"from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())\"\n\n# 3. JWT Secret Key\npython3 -c \"import secrets; print(secrets.token_urlsafe(32))\"\n</code></pre>"},{"location":"deployment/quickstart/#env_1","title":"\u0417\u0430\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u0435 .env","text":"<pre><code># Required\nAIRFLOW_FERNET_KEY=&lt;\u0432\u0430\u0448-\u043a\u043b\u044e\u0447-1&gt;\nENCRYPTION_KEY=&lt;\u0432\u0430\u0448-\u043a\u043b\u044e\u0447-2&gt;\nJWT_SECRET_KEY=&lt;\u0432\u0430\u0448-\u043a\u043b\u044e\u0447-3&gt;\n\n# Optional (\u0434\u043b\u044f Yandex ID)\nYANDEX_CLIENT_ID=\nYANDEX_CLIENT_SECRET=\n</code></pre>"},{"location":"deployment/quickstart/#3","title":"\u0428\u0430\u0433 3: \u0417\u0430\u043f\u0443\u0441\u043a \u0441\u0438\u0441\u0442\u0435\u043c\u044b","text":"<pre><code># \u0417\u0430\u043f\u0443\u0441\u043a \u0432\u0441\u0435\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432\ndocker-compose up -d\n\n# \u041c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433 \u0438\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u0438\ndocker-compose logs -f airflow-etl-trigger\n</code></pre> <p>\u0414\u043e\u0436\u0434\u0438\u0442\u0435\u0441\u044c \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f \"ETL completed successfully\" (2-3 \u043c\u0438\u043d\u0443\u0442\u044b).</p>"},{"location":"deployment/quickstart/#4","title":"\u0428\u0430\u0433 4: \u041f\u0440\u043e\u0432\u0435\u0440\u043a\u0430 \u0440\u0430\u0431\u043e\u0442\u043e\u0441\u043f\u043e\u0441\u043e\u0431\u043d\u043e\u0441\u0442\u0438","text":"<pre><code># \u0412\u0441\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b \u0434\u043e\u043b\u0436\u043d\u044b \u0431\u044b\u0442\u044c \u0432 \u0441\u0442\u0430\u0442\u0443\u0441\u0435 \"Up\"\ndocker-compose ps\n\n# Health checks\ncurl -s http://localhost:8080/health/ready  # Keycloak\ncurl -s http://localhost:8001/health/live   # Reports Service\ncurl -s http://localhost:8123/?query=SELECT%201  # ClickHouse\n</code></pre>"},{"location":"deployment/quickstart/#5","title":"\u0428\u0430\u0433 5: \u0414\u043e\u0441\u0442\u0443\u043f \u043a \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044e","text":""},{"location":"deployment/quickstart/#frontend","title":"Frontend","text":"<p>\u041e\u0442\u043a\u0440\u043e\u0439\u0442\u0435 http://localhost:3000 \u0438 \u0432\u043e\u0439\u0434\u0438\u0442\u0435:</p> Username Password \u0420\u043e\u043b\u044c ivan.petrov password123 \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430 john.mueller password123 \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430 alexey.kozlov password123 \u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440"},{"location":"deployment/quickstart/#admin-interfaces","title":"Admin Interfaces","text":"\u0421\u0435\u0440\u0432\u0438\u0441 URL Credentials Keycloak Admin http://localhost:8080/admin admin / admin Airflow UI http://localhost:8081 admin / admin MinIO Console http://localhost:9001 minioadmin / minioadmin123 Kafka UI http://localhost:8084 -"},{"location":"deployment/quickstart/#_4","title":"\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 \u0441\u0438\u0441\u0442\u0435\u043c\u044b","text":"<pre><code># \u041e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 \u0441 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u0435\u043c \u0434\u0430\u043d\u043d\u044b\u0445\ndocker-compose down\n\n# \u041f\u043e\u043b\u043d\u0430\u044f \u043e\u0447\u0438\u0441\u0442\u043a\u0430 (\u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435 \u0432\u0441\u0435\u0445 \u0434\u0430\u043d\u043d\u044b\u0445)\n./scripts/clean.sh\n</code></pre>"},{"location":"deployment/quickstart/#_5","title":"\u0427\u0442\u043e \u0434\u0430\u043b\u044c\u0448\u0435?","text":"<ul> <li>Environment Setup \u2014 \u0434\u0435\u0442\u0430\u043b\u044c\u043d\u0430\u044f \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430</li> <li>Service Reference \u2014 \u043e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0432\u0441\u0435\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432</li> <li>Architecture Overview \u2014 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 \u0441\u0438\u0441\u0442\u0435\u043c\u044b</li> <li>Troubleshooting \u2014 \u0440\u0435\u0448\u0435\u043d\u0438\u0435 \u043f\u0440\u043e\u0431\u043b\u0435\u043c</li> </ul>"},{"location":"deployment/services/","title":"Service Reference","text":""},{"location":"deployment/services/#_1","title":"\u041e\u0431\u0437\u043e\u0440 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432","text":""},{"location":"deployment/services/#application-services","title":"Application Services","text":"Service Port Technology \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 frontend 3000 React 18 SPA \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 bionicpro-auth 8000 Flask BFF \u0434\u043b\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438 reports-service 8001 FastAPI REST API \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432"},{"location":"deployment/services/#security-services","title":"Security Services","text":"Service Port Technology \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 keycloak 8080 Keycloak 26.5.2 Identity Provider ldap 389 OpenLDAP 1.5.0 Directory Service redis 6379 Redis 7 Session Storage"},{"location":"deployment/services/#data-services","title":"Data Services","text":"Service Port Technology \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 crm_db 5435 PostgreSQL 14 CRM \u0431\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 telemetry_db 5436 PostgreSQL 14 \u0411\u0430\u0437\u0430 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 clickhouse 8123/9000 ClickHouse 24.1 OLAP \u0431\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445"},{"location":"deployment/services/#cdc-pipeline","title":"CDC Pipeline","text":"Service Port Technology \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 kafka 9092 Kafka 3.6 Message Broker zookeeper 2181 Zookeeper Kafka \u043a\u043e\u043e\u0440\u0434\u0438\u043d\u0430\u0442\u043e\u0440 debezium 8083 Debezium CDC \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440 kafka-ui 8084 Kafka UI \u041c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433 Kafka"},{"location":"deployment/services/#etl-caching","title":"ETL &amp; Caching","text":"Service Port Technology \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 airflow-webserver 8081 Airflow 2.8.1 ETL UI airflow-scheduler - Airflow 2.8.1 ETL \u043f\u043b\u0430\u043d\u0438\u0440\u043e\u0432\u0449\u0438\u043a minio 9001/9002 MinIO S3 \u0445\u0440\u0430\u043d\u0438\u043b\u0438\u0449\u0435 nginx-cdn 8002 Nginx 1.25 CDN proxy"},{"location":"deployment/services/#health-checks","title":"Health Checks","text":""},{"location":"deployment/services/#_2","title":"\u0412\u0441\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b","text":"<pre><code># Frontend\ncurl -s http://localhost:3000 | head -1\n\n# BFF Auth\ncurl -s http://localhost:8000/health\n\n# Reports Service\ncurl -s http://localhost:8001/health/live\n\n# Keycloak\ncurl -s http://localhost:8080/health/ready\n\n# Airflow\ncurl -s http://localhost:8081/health\n\n# ClickHouse\ncurl -s \"http://localhost:8123/?query=SELECT%201\"\n\n# Debezium\ncurl -s http://localhost:8083/connectors\n\n# MinIO\ncurl -s http://localhost:9002/minio/health/live\n\n# Nginx CDN\ncurl -s http://localhost:8002/health\n</code></pre>"},{"location":"deployment/services/#_3","title":"\u0410\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u0430\u044f \u043f\u0440\u043e\u0432\u0435\u0440\u043a\u0430","text":"<pre><code>#!/bin/bash\n# scripts/healthcheck.sh\n\nservices=(\n    \"http://localhost:3000|Frontend\"\n    \"http://localhost:8000/health|BFF Auth\"\n    \"http://localhost:8001/health/live|Reports Service\"\n    \"http://localhost:8080/health/ready|Keycloak\"\n    \"http://localhost:8123/?query=SELECT%201|ClickHouse\"\n)\n\nfor service in \"${services[@]}\"; do\n    url=\"${service%%|*}\"\n    name=\"${service##*|}\"\n    if curl -sf \"$url\" &gt; /dev/null 2&gt;&amp;1; then\n        echo \"\u2713 $name\"\n    else\n        echo \"\u2717 $name\"\n    fi\ndone\n</code></pre>"},{"location":"deployment/services/#_4","title":"\u0423\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u043c\u0438","text":""},{"location":"deployment/services/#_5","title":"\u0417\u0430\u043f\u0443\u0441\u043a","text":"<pre><code># \u0412\u0441\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b\ndocker-compose up -d\n\n# \u041a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0441\u0435\u0440\u0432\u0438\u0441\ndocker-compose up -d reports-service\n\n# \u0413\u0440\u0443\u043f\u043f\u0430 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432 (Security)\ndocker-compose up -d ldap keycloak keycloak-db redis bionicpro-auth\n</code></pre>"},{"location":"deployment/services/#_6","title":"\u041e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430","text":"<pre><code># \u0412\u0441\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b\ndocker-compose down\n\n# \u041a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0441\u0435\u0440\u0432\u0438\u0441\ndocker-compose stop reports-service\n\n# \u0421 \u0443\u0434\u0430\u043b\u0435\u043d\u0438\u0435\u043c volumes\ndocker-compose down -v\n</code></pre>"},{"location":"deployment/services/#_7","title":"\u041f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u043a","text":"<pre><code># \u041a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0441\u0435\u0440\u0432\u0438\u0441\ndocker-compose restart reports-service\n\n# \u041f\u0435\u0440\u0435\u0441\u0431\u043e\u0440\u043a\u0430 \u0438 \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u043a\ndocker-compose up -d --build reports-service\n</code></pre>"},{"location":"deployment/services/#_8","title":"\u041f\u0440\u043e\u0441\u043c\u043e\u0442\u0440 \u043b\u043e\u0433\u043e\u0432","text":"<pre><code># \u0412\u0441\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b\ndocker-compose logs -f\n\n# \u041a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0441\u0435\u0440\u0432\u0438\u0441\ndocker-compose logs -f reports-service\n\n# \u041f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0435 100 \u0441\u0442\u0440\u043e\u043a\ndocker-compose logs --tail=100 airflow-scheduler\n\n# \u0421 timestamps\ndocker-compose logs -f --timestamps reports-service\n</code></pre>"},{"location":"deployment/services/#_9","title":"\u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432","text":""},{"location":"deployment/services/#frontend","title":"Frontend","text":"<pre><code>frontend:\n  build: ./frontend\n  ports:\n    - \"3000:3000\"\n  environment:\n    REACT_APP_AUTH_URL: http://localhost:8000\n</code></pre>"},{"location":"deployment/services/#bff-auth","title":"BFF Auth","text":"<pre><code>bionicpro-auth:\n  build: ./bionicpro-auth\n  ports:\n    - \"8000:8000\"\n  environment:\n    KEYCLOAK_URL: http://keycloak:8080\n    KEYCLOAK_PUBLIC_URL: http://localhost:8080\n    KEYCLOAK_REALM: reports-realm\n    CLIENT_ID: bionicpro-auth\n    REDIS_HOST: redis\n    ENCRYPTION_KEY: ${ENCRYPTION_KEY}\n</code></pre>"},{"location":"deployment/services/#reports-service","title":"Reports Service","text":"<pre><code>reports-service:\n  build: ./reports-service\n  ports:\n    - \"8001:8001\"\n  environment:\n    CLICKHOUSE_HOST: clickhouse\n    CLICKHOUSE_PORT: 9000\n    CLICKHOUSE_DATABASE: reports\n    REDIS_HOST: redis\n    S3_ENDPOINT_URL: http://minio:9000\n    CDN_BASE_URL: http://localhost:8002\n    KAFKA_BOOTSTRAP_SERVERS: kafka:29092\n</code></pre>"},{"location":"deployment/services/#keycloak","title":"Keycloak","text":"<pre><code>keycloak:\n  image: quay.io/keycloak/keycloak:26.5.2\n  ports:\n    - \"8080:8080\"\n  environment:\n    KEYCLOAK_ADMIN: admin\n    KEYCLOAK_ADMIN_PASSWORD: admin\n    KC_DB: postgres\n    KC_DB_URL: jdbc:postgresql://keycloak_db:5432/keycloak_db\n  command:\n    - start-dev\n    - --import-realm\n</code></pre>"},{"location":"deployment/services/#clickhouse","title":"ClickHouse","text":"<pre><code>clickhouse:\n  image: clickhouse/clickhouse-server:24.1\n  ports:\n    - \"8123:8123\"  # HTTP\n    - \"9000:9000\"  # Native\n  environment:\n    CLICKHOUSE_DB: reports\n    CLICKHOUSE_USER: default\n</code></pre>"},{"location":"deployment/services/#kafka","title":"Kafka","text":"<pre><code>kafka:\n  image: confluentinc/cp-kafka:7.5.0\n  ports:\n    - \"9092:9092\"\n  environment:\n    KAFKA_BROKER_ID: 1\n    KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181\n    KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092\n</code></pre>"},{"location":"deployment/services/#database-connections","title":"Database Connections","text":""},{"location":"deployment/services/#postgresql","title":"PostgreSQL","text":"Database Host Port User Password DB Keycloak localhost 5433 keycloak_user keycloak_password keycloak_db BionicPRO localhost 5434 bionicpro_user bionicpro_password bionicpro_db CRM localhost 5435 crm_user crm_password crm_db Telemetry localhost 5436 telemetry_user telemetry_password telemetry_db Airflow - - airflow airflow airflow"},{"location":"deployment/services/#connection-strings","title":"Connection Strings","text":"<pre><code># CRM DB\npostgresql://crm_user:crm_password@localhost:5435/crm_db\n\n# Telemetry DB\npostgresql://telemetry_user:telemetry_password@localhost:5436/telemetry_db\n\n# ClickHouse HTTP\nhttp://localhost:8123?database=reports\n\n# ClickHouse Native\nclickhouse://default@localhost:9000/reports\n</code></pre>"},{"location":"deployment/services/#volumes","title":"Volumes","text":""},{"location":"deployment/services/#persistent-data","title":"Persistent Data","text":"Volume Path \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 postgres-keycloak-data ./postgres-keycloak-data Keycloak DB postgres-bionicpro-data ./postgres-bionicpro-data BionicPRO DB postgres-crm-data ./postgres-crm-data CRM DB postgres-telemetry-data ./postgres-telemetry-data Telemetry DB postgres-airflow-data ./postgres-airflow-data Airflow DB clickhouse-data ./clickhouse-data ClickHouse minio-data ./minio-data S3 Storage redis-data ./redis-data Redis ldap-data ./ldap-data LDAP"},{"location":"deployment/services/#volumes_1","title":"\u041e\u0447\u0438\u0441\u0442\u043a\u0430 volumes","text":"<pre><code># \u041f\u043e\u043b\u043d\u0430\u044f \u043e\u0447\u0438\u0441\u0442\u043a\u0430\n./scripts/clean.sh\n\n# \u0420\u0443\u0447\u043d\u0430\u044f \u043e\u0447\u0438\u0441\u0442\u043a\u0430\ndocker-compose down -v\nrm -rf ./postgres-*-data ./clickhouse-data ./minio-data ./redis-data ./ldap-*\n</code></pre>"},{"location":"deployment/services/#resource-requirements","title":"Resource Requirements","text":""},{"location":"deployment/services/#minimum","title":"Minimum","text":"Resource Value CPU 4 cores RAM 8 GB Disk 20 GB"},{"location":"deployment/services/#recommended","title":"Recommended","text":"Resource Value CPU 8 cores RAM 16 GB Disk 50 GB"},{"location":"deployment/services/#per-service-memory","title":"Per-Service Memory","text":"Service Memory Keycloak 512MB - 1GB ClickHouse 1GB - 4GB Kafka 512MB - 1GB Airflow (total) 1GB - 2GB Reports Service 256MB - 512MB"},{"location":"deployment/services/#_10","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Quick Start</li> <li>Environment Setup</li> <li>Troubleshooting</li> </ul>"},{"location":"deployment/troubleshooting/","title":"Troubleshooting","text":""},{"location":"deployment/troubleshooting/#_1","title":"\u041e\u0431\u0449\u0438\u0435 \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b","text":""},{"location":"deployment/troubleshooting/#_2","title":"\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435 \u043e\u043a\u0440\u0443\u0436\u0435\u043d\u0438\u044f \u043d\u0435 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u044b","text":"<p>\u0421\u0438\u043c\u043f\u0442\u043e\u043c: \u0421\u0435\u0440\u0432\u0438\u0441\u044b \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u044e\u0442\u0441\u044f, \u043e\u0448\u0438\u0431\u043a\u0438 \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u044f.</p> <pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043d\u0430\u043b\u0438\u0447\u0438\u0435 .env\nls -la .env\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0443 \u043f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0445\ndocker-compose config | grep -E \"AIRFLOW_FERNET_KEY|ENCRYPTION_KEY|JWT_SECRET_KEY\"\n</code></pre> <p>\u0420\u0435\u0448\u0435\u043d\u0438\u0435: \u0421\u043e\u0437\u0434\u0430\u0439\u0442\u0435 <code>.env</code> \u0444\u0430\u0439\u043b \u0441\u043e\u0433\u043b\u0430\u0441\u043d\u043e Environment Setup.</p>"},{"location":"deployment/troubleshooting/#_3","title":"\u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u044b \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u044e\u0442\u0441\u044f","text":"<p>\u0421\u0438\u043c\u043f\u0442\u043e\u043c: <code>docker-compose ps</code> \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u0441\u0442\u0430\u0442\u0443\u0441 \"Restarting\" \u0438\u043b\u0438 \"Exit\".</p> <pre><code># \u041f\u043e\u0441\u043c\u043e\u0442\u0440\u0435\u0442\u044c \u043b\u043e\u0433\u0438\ndocker-compose logs &lt;service-name&gt;\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435 \u0440\u0435\u0441\u0443\u0440\u0441\u043e\u0432\ndocker stats --no-stream\n</code></pre> <p>\u0420\u0435\u0448\u0435\u043d\u0438\u0435: \u0423\u0432\u0435\u043b\u0438\u0447\u044c\u0442\u0435 \u043f\u0430\u043c\u044f\u0442\u044c Docker (\u043c\u0438\u043d\u0438\u043c\u0443\u043c 8GB).</p>"},{"location":"deployment/troubleshooting/#keycloak","title":"Keycloak","text":""},{"location":"deployment/troubleshooting/#keycloak_1","title":"Keycloak \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043b\u043e\u0433\u0438\ndocker-compose logs keycloak\n\n# \u0422\u0438\u043f\u0438\u0447\u043d\u044b\u0435 \u043f\u0440\u043e\u0431\u043b\u0435\u043c\u044b:\n# 1. \u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445 \u043d\u0435 \u0433\u043e\u0442\u043e\u0432\u0430\ndocker-compose up -d keycloak_db\nsleep 30\ndocker-compose up -d keycloak\n\n# 2. \u041f\u043e\u0440\u0442 8080 \u0437\u0430\u043d\u044f\u0442\nlsof -i :8080\n</code></pre>"},{"location":"deployment/troubleshooting/#realm","title":"\u041e\u0448\u0438\u0431\u043a\u0430 \u0438\u043c\u043f\u043e\u0440\u0442\u0430 realm","text":"<pre><code># \u041f\u0435\u0440\u0435\u0441\u043e\u0437\u0434\u0430\u0442\u044c Keycloak\ndocker-compose stop keycloak\ndocker-compose rm keycloak\nrm -rf ./postgres-keycloak-data\ndocker-compose up -d keycloak_db keycloak\n</code></pre>"},{"location":"deployment/troubleshooting/#_4","title":"\u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f","text":""},{"location":"deployment/troubleshooting/#invalid-token","title":"Invalid token","text":"<p>\u0421\u0438\u043c\u043f\u0442\u043e\u043c: \u041e\u0448\u0438\u0431\u043a\u0430 401 \"Invalid token\" \u0438\u043b\u0438 \"Token validation failed\".</p> <pre><code># 1. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c Keycloak\ncurl -s http://localhost:8080/health/ready\n\n# 2. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c BFF \u043b\u043e\u0433\u0438\ndocker-compose logs bionicpro-auth | grep -i error\n\n# 3. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c realm\ncurl -s http://localhost:8080/realms/reports-realm/.well-known/openid-configuration | jq .\n\n# 4. \u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c \u0441\u0435\u0441\u0441\u0438\u0438\ndocker-compose exec redis redis-cli FLUSHALL\n</code></pre>"},{"location":"deployment/troubleshooting/#ldap-authentication-failed","title":"LDAP authentication failed","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c LDAP\nldapsearch -x -H ldap://localhost:389 \\\n  -D \"cn=admin,dc=bionicpro,dc=com\" \\\n  -w admin \\\n  -b \"ou=People,dc=bionicpro,dc=com\"\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c User Federation \u0432 Keycloak\n# http://localhost:8080/admin \u2192 reports-realm \u2192 User Federation \u2192 ldap\n</code></pre>"},{"location":"deployment/troubleshooting/#cdc-pipeline","title":"CDC Pipeline","text":""},{"location":"deployment/troubleshooting/#debezium","title":"Debezium \u043d\u0435 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0430\u0435\u0442\u0441\u044f","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043b\u043e\u0433\u0438 Debezium\ndocker-compose logs debezium\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c WAL level \u0432 PostgreSQL\ndocker-compose exec crm_db psql -U crm_user -d crm_db -c \"SHOW wal_level;\"\n# \u0414\u043e\u043b\u0436\u043d\u043e \u0431\u044b\u0442\u044c 'logical'\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c replication slot\ndocker-compose exec crm_db psql -U crm_user -d crm_db \\\n  -c \"SELECT * FROM pg_replication_slots;\"\n</code></pre>"},{"location":"deployment/troubleshooting/#connector","title":"Connector \u043d\u0435 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0435\u0442\u0441\u044f","text":"<pre><code># \u041f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c init\ndocker-compose restart debezium-init\n\n# \u0420\u0443\u0447\u043d\u0430\u044f \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u044f\ncurl -X POST -H \"Content-Type: application/json\" \\\n  --data @debezium/crm-connector.json \\\n  http://localhost:8083/connectors\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0441\u0442\u0430\u0442\u0443\u0441\ncurl -s http://localhost:8083/connectors/crm-connector/status | jq .\n</code></pre>"},{"location":"deployment/troubleshooting/#clickhouse","title":"\u0414\u0430\u043d\u043d\u044b\u0435 \u043d\u0435 \u043f\u043e\u044f\u0432\u043b\u044f\u044e\u0442\u0441\u044f \u0432 ClickHouse","text":"<pre><code># 1. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c Kafka \u0442\u043e\u043f\u0438\u043a\u0438\ndocker-compose exec kafka kafka-console-consumer \\\n  --bootstrap-server localhost:9092 \\\n  --topic crm.crm.customers \\\n  --from-beginning --max-messages 1\n\n# 2. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c KafkaEngine\ncurl \"http://localhost:8123/\" -d \"SELECT * FROM system.kafka_consumers\"\n\n# 3. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c CDC \u0442\u0430\u0431\u043b\u0438\u0446\u044b\ncurl \"http://localhost:8123/\" -d \"SELECT count() FROM reports.crm_customers\"\n</code></pre>"},{"location":"deployment/troubleshooting/#airflow-etl","title":"Airflow &amp; ETL","text":""},{"location":"deployment/troubleshooting/#dag","title":"DAG \u043d\u0435 \u0437\u0430\u043f\u0443\u0441\u043a\u0430\u0435\u0442\u0441\u044f","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0441\u0442\u0430\u0442\u0443\u0441 DAG\ndocker-compose exec airflow-webserver airflow dags list\n\n# \u0412\u043a\u043b\u044e\u0447\u0438\u0442\u044c DAG\ndocker-compose exec airflow-webserver airflow dags unpause bionicpro_reports_etl\n\n# \u0420\u0443\u0447\u043d\u043e\u0439 \u0437\u0430\u043f\u0443\u0441\u043a\ndocker-compose exec airflow-webserver airflow dags trigger bionicpro_reports_etl\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043b\u043e\u0433\u0438\ndocker-compose logs airflow-scheduler\n</code></pre>"},{"location":"deployment/troubleshooting/#_5","title":"\u041e\u0448\u0438\u0431\u043a\u0438 \u043f\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d\u0438\u044f \u043a \u0431\u0430\u0437\u0430\u043c","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c connections\ndocker-compose exec airflow-webserver airflow connections list\n\n# \u041f\u0435\u0440\u0435\u0441\u043e\u0437\u0434\u0430\u0442\u044c connections\ndocker-compose restart airflow-connections\n</code></pre>"},{"location":"deployment/troubleshooting/#reports-service","title":"Reports Service","text":""},{"location":"deployment/troubleshooting/#frontend","title":"\u041d\u0435\u0442 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u0432\u043e Frontend","text":"<pre><code># 1. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u0434\u0430\u043d\u043d\u044b\u0435 \u0432 ClickHouse\ncurl \"http://localhost:8123/\" -d \"SELECT count() FROM reports.user_prosthesis_stats\"\n\n# 2. \u0415\u0441\u043b\u0438 \u043f\u0443\u0441\u0442\u043e - \u0440\u0435\u0433\u0435\u043d\u0435\u0440\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u0434\u0435\u043c\u043e \u0434\u0430\u043d\u043d\u044b\u0435\ndocker-compose exec clickhouse clickhouse-client \\\n  --queries-file /docker-entrypoint-initdb.d/03_regenerate_demo_data.sql\n\n# 3. \u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c ETL\ndocker-compose exec airflow-webserver airflow dags trigger bionicpro_reports_etl\n\n# 4. \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043b\u043e\u0433\u0438 Reports Service\ndocker-compose logs reports-service | tail -50\n</code></pre>"},{"location":"deployment/troubleshooting/#s3cdn","title":"S3/CDN \u043d\u0435 \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c MinIO\ncurl -s http://localhost:9002/minio/health/live\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c bucket\ndocker-compose exec minio mc ls local/reports-bucket\n\n# \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c CDN\ncurl -I http://localhost:8002/health\n</code></pre>"},{"location":"deployment/troubleshooting/#_6","title":"\u041f\u0440\u043e\u0431\u043b\u0435\u043c\u044b \u0441 \u043f\u0430\u043c\u044f\u0442\u044c\u044e","text":""},{"location":"deployment/troubleshooting/#out-of-memory-oom","title":"Out of Memory (OOM)","text":"<pre><code># \u041f\u0440\u043e\u0432\u0435\u0440\u0438\u0442\u044c \u043f\u0430\u043c\u044f\u0442\u044c\ndocker stats --no-stream\n\n# \u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u043f\u0430\u043c\u044f\u0442\u044c Docker Desktop:\n# Preferences \u2192 Resources \u2192 Memory \u2192 8GB+\n\n# \u0418\u043b\u0438 \u043e\u0442\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u043d\u0435\u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u0441\u0435\u0440\u0432\u0438\u0441\u044b\ndocker-compose stop kafka-ui\n</code></pre>"},{"location":"deployment/troubleshooting/#_7","title":"\u041f\u043e\u043b\u043d\u0430\u044f \u043e\u0447\u0438\u0441\u0442\u043a\u0430","text":"<p>\u0415\u0441\u043b\u0438 \u043d\u0438\u0447\u0435\u0433\u043e \u043d\u0435 \u043f\u043e\u043c\u043e\u0433\u0430\u0435\u0442 \u2014 \u0441\u0431\u0440\u043e\u0441 \u043a \u043d\u0430\u0447\u0430\u043b\u044c\u043d\u043e\u043c\u0443 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u044e:</p> <pre><code># \u041e\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u044c \u0438 \u0443\u0434\u0430\u043b\u0438\u0442\u044c \u0432\u0441\u0451\n./scripts/clean.sh\n\n# \u0418\u043b\u0438 \u0432\u0440\u0443\u0447\u043d\u0443\u044e:\ndocker-compose down -v\nrm -rf ./postgres-*-data ./clickhouse-data ./minio-data ./redis-data ./ldap-*\n\n# \u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c \u0437\u0430\u043d\u043e\u0432\u043e\ndocker-compose up -d\n</code></pre>"},{"location":"deployment/troubleshooting/#_8","title":"\u0421\u0431\u043e\u0440 \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u0438 \u0434\u043b\u044f \u043e\u0442\u043b\u0430\u0434\u043a\u0438","text":"<pre><code># \u0421\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0432\u0441\u0435 \u043b\u043e\u0433\u0438\ndocker-compose logs &gt; logs.txt 2&gt;&amp;1\n\n# \u0421\u0442\u0430\u0442\u0443\u0441 \u0432\u0441\u0435\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432\ndocker-compose ps &gt; status.txt\n\n# \u0412\u0435\u0440\u0441\u0438\u0438\ndocker version &gt;&gt; status.txt\ndocker-compose version &gt;&gt; status.txt\n\n# \u041a\u043e\u043d\u0444\u0438\u0433\u0443\u0440\u0430\u0446\u0438\u044f\ndocker-compose config &gt; config.txt 2&gt;&amp;1\n</code></pre>"},{"location":"deployment/troubleshooting/#_9","title":"\u041f\u043e\u043b\u0435\u0437\u043d\u044b\u0435 \u043a\u043e\u043c\u0430\u043d\u0434\u044b","text":"<pre><code># \u0412\u043e\u0439\u0442\u0438 \u0432 \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\ndocker-compose exec &lt;service&gt; /bin/bash\n\n# \u041f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u044c \u0432\u0441\u0435\ndocker-compose restart\n\n# \u041f\u0435\u0440\u0435\u0441\u043e\u0431\u0440\u0430\u0442\u044c \u043e\u0431\u0440\u0430\u0437\u044b\ndocker-compose build --no-cache\n\n# \u0423\u0434\u0430\u043b\u0438\u0442\u044c \u043d\u0435\u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u043c\u044b\u0435 \u043e\u0431\u0440\u0430\u0437\u044b\ndocker image prune -a\n</code></pre>"},{"location":"deployment/troubleshooting/#_10","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Quick Start</li> <li>Service Reference</li> <li>Environment Setup</li> </ul>"},{"location":"diagrams/","title":"Architecture Diagrams","text":""},{"location":"diagrams/#_1","title":"\u041e\u0431\u0437\u043e\u0440","text":"<p>\u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 BionicPRO \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0430 \u0441 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435\u043c \u043d\u043e\u0442\u0430\u0446\u0438\u0438 C4 Model \u0438 \u0434\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0445 \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c.</p>"},{"location":"diagrams/#c4-model-levels","title":"C4 Model Levels","text":"Level \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Level 1 Context \u0421\u0438\u0441\u0442\u0435\u043c\u0430 \u0432 \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0438 \u0432\u043d\u0435\u0448\u043d\u0438\u0445 \u0441\u0438\u0441\u0442\u0435\u043c Level 2 Container \u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u044b (\u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f, \u0431\u0430\u0437\u044b \u0434\u0430\u043d\u043d\u044b\u0445, \u0441\u0435\u0440\u0432\u0438\u0441\u044b) Level 3 Component \u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b \u0432\u043d\u0443\u0442\u0440\u0438 \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u043e\u0432 Level 4 Code \u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u044b \u043a\u043b\u0430\u0441\u0441\u043e\u0432 \u0438 \u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430 \u043a\u043e\u0434\u0430"},{"location":"diagrams/#_2","title":"\u0414\u043e\u043f\u043e\u043b\u043d\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0435 \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u044b","text":"\u0422\u0438\u043f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Sequence Diagrams \u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u044b \u043f\u043e\u0441\u043b\u0435\u0434\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u0438 \u0434\u043b\u044f \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0445 \u043f\u043e\u0442\u043e\u043a\u043e\u0432 Deployment Diagram \u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430 \u0440\u0430\u0437\u0432\u0451\u0440\u0442\u044b\u0432\u0430\u043d\u0438\u044f (Docker containers)"},{"location":"diagrams/#_3","title":"\u0424\u043e\u0440\u043c\u0430\u0442 \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c","text":"<p>\u0412\u0441\u0435 \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u044b \u0441\u043e\u0437\u0434\u0430\u043d\u044b \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 PlantUML \u0438 \u043d\u0430\u0445\u043e\u0434\u044f\u0442\u0441\u044f \u0432 \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0435 <code>docs/diagrams/</code>.</p>"},{"location":"diagrams/#_4","title":"\u041f\u0440\u043e\u0441\u043c\u043e\u0442\u0440 \u0434\u0438\u0430\u0433\u0440\u0430\u043c\u043c","text":""},{"location":"diagrams/#online-plantuml-server","title":"Online (PlantUML Server)","text":"<ol> <li>\u041e\u0442\u043a\u0440\u043e\u0439\u0442\u0435 http://www.plantuml.com/plantuml/uml/</li> <li>\u0412\u0441\u0442\u0430\u0432\u044c\u0442\u0435 \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u043c\u043e\u0435 <code>.puml</code> \u0444\u0430\u0439\u043b\u0430</li> <li>\u041d\u0430\u0436\u043c\u0438\u0442\u0435 \"Submit\"</li> </ol>"},{"location":"diagrams/#vs-code","title":"VS Code","text":"<ol> <li>\u0423\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0435 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u0435 \"PlantUML\"</li> <li>\u041e\u0442\u043a\u0440\u043e\u0439\u0442\u0435 <code>.puml</code> \u0444\u0430\u0439\u043b</li> <li><code>Cmd/Ctrl + Shift + P</code> \u2192 \"PlantUML: Preview Current Diagram\"</li> </ol>"},{"location":"diagrams/#cli","title":"CLI","text":"<pre><code># \u0423\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430\nbrew install plantuml\n\n# \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f PNG\nplantuml docs/diagrams/*.puml\n\n# \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f SVG\nplantuml -tsvg docs/diagrams/*.puml\n</code></pre>"},{"location":"diagrams/#_5","title":"\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430 \u0444\u0430\u0439\u043b\u043e\u0432","text":"<pre><code>docs/diagrams/\n\u251c\u2500\u2500 c4-level1-context.puml          # C4 Level 1: System Context\n\u251c\u2500\u2500 c4-level2-container.puml        # C4 Level 2: Container Diagram\n\u251c\u2500\u2500 c4-level3-bff-component.puml    # C4 Level 3: BFF Components\n\u251c\u2500\u2500 c4-level3-reports-component.puml # C4 Level 3: Reports Service\n\u251c\u2500\u2500 c4-level3-etl-component.puml    # C4 Level 3: ETL Pipeline\n\u251c\u2500\u2500 c4-level3-cdc-component.puml    # C4 Level 3: CDC Pipeline\n\u251c\u2500\u2500 c4-level4-bff-classes.puml      # C4 Level 4: BFF Class Diagram\n\u251c\u2500\u2500 c4-level4-reports-classes.puml  # C4 Level 4: Reports Classes\n\u251c\u2500\u2500 c4-level4-etl-classes.puml      # C4 Level 4: ETL Classes\n\u251c\u2500\u2500 c4-level4-data-model.puml       # Data Model Class Diagram\n\u251c\u2500\u2500 sequence-auth-flow.puml         # Auth Flow Sequence\n\u251c\u2500\u2500 sequence-cdc-flow.puml          # CDC Flow Sequence\n\u251c\u2500\u2500 sequence-reports-flow.puml      # Reports Flow Sequence\n\u251c\u2500\u2500 sequence-etl-flow.puml          # ETL Flow Sequence\n\u2514\u2500\u2500 deployment-diagram.puml         # Deployment Diagram\n</code></pre>"},{"location":"diagrams/archimate/","title":"ArchiMate Model (Archi)","text":""},{"location":"diagrams/archimate/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>\u041f\u043e\u043b\u043d\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u044b BionicPRO \u0432 \u0444\u043e\u0440\u043c\u0430\u0442\u0435 ArchiMate, \u0441\u043e\u0437\u0434\u0430\u043d\u043d\u0430\u044f \u0434\u043b\u044f \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442\u0430 Archi.</p>"},{"location":"diagrams/archimate/#_2","title":"\u0424\u0430\u0439\u043b \u043c\u043e\u0434\u0435\u043b\u0438","text":"<p>\u0420\u0430\u0441\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435: <code>docs/architecture/bionicpro.archimate</code></p>"},{"location":"diagrams/archimate/#_3","title":"\u041e\u0442\u043a\u0440\u044b\u0442\u0438\u0435 \u043c\u043e\u0434\u0435\u043b\u0438","text":""},{"location":"diagrams/archimate/#archi","title":"\u0423\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430 Archi","text":"<ol> <li>\u0421\u043a\u0430\u0447\u0430\u0439\u0442\u0435 Archi \u0441 https://www.archimatetool.com/download/</li> <li>\u0423\u0441\u0442\u0430\u043d\u043e\u0432\u0438\u0442\u0435 \u0434\u043b\u044f \u0432\u0430\u0448\u0435\u0439 \u041e\u0421 (Windows, macOS, Linux)</li> </ol>"},{"location":"diagrams/archimate/#_4","title":"\u041e\u0442\u043a\u0440\u044b\u0442\u0438\u0435 \u0444\u0430\u0439\u043b\u0430","text":"<ol> <li>\u0417\u0430\u043f\u0443\u0441\u0442\u0438\u0442\u0435 Archi</li> <li>File \u2192 Open \u2192 \u0432\u044b\u0431\u0435\u0440\u0438\u0442\u0435 <code>bionicpro.archimate</code></li> </ol>"},{"location":"diagrams/archimate/#_5","title":"\u0421\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430 \u043c\u043e\u0434\u0435\u043b\u0438","text":""},{"location":"diagrams/archimate/#archimate","title":"\u0421\u043b\u043e\u0438 ArchiMate","text":"\u0421\u043b\u043e\u0439 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u042d\u043b\u0435\u043c\u0435\u043d\u0442\u044b Strategy \u0421\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u0447\u0435\u0441\u043a\u0438\u0435 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b - Business \u0411\u0438\u0437\u043d\u0435\u0441-\u0430\u043a\u0442\u043e\u0440\u044b, \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u044b, \u0441\u0435\u0440\u0432\u0438\u0441\u044b \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0438, \u0431\u0438\u0437\u043d\u0435\u0441-\u043f\u0440\u043e\u0446\u0435\u0441\u0441\u044b Application \u041f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f, \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b, \u0441\u0435\u0440\u0432\u0438\u0441\u044b \u0421\u0435\u0440\u0432\u0438\u0441\u044b, API, \u0444\u0443\u043d\u043a\u0446\u0438\u0438 Technology \u0418\u043d\u0444\u0440\u0430\u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0430, \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u044b Docker containers, \u0431\u0430\u0437\u044b \u0434\u0430\u043d\u043d\u044b\u0445 Motivation \u0426\u0435\u043b\u0438, \u043f\u0440\u0438\u043d\u0446\u0438\u043f\u044b, \u0442\u0440\u0435\u0431\u043e\u0432\u0430\u043d\u0438\u044f \u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u043d\u044b\u0435 \u0440\u0435\u0448\u0435\u043d\u0438\u044f Implementation \u0420\u0430\u0431\u043e\u0447\u0438\u0435 \u043f\u0430\u043a\u0435\u0442\u044b, deliverables Tasks 1-4"},{"location":"diagrams/archimate/#views","title":"\u041f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u043b\u0435\u043d\u0438\u044f (Views)","text":"# \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 1 Business Layer \u0411\u0438\u0437\u043d\u0435\u0441-\u0430\u043a\u0442\u043e\u0440\u044b \u0438 \u043f\u0440\u043e\u0446\u0435\u0441\u0441\u044b 2 Application Layer \u041f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f \u0438 \u0438\u0445 \u0432\u0437\u0430\u0438\u043c\u043e\u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435 3 Technology Layer - Deployment Docker \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u044b 4 Motivation \u0426\u0435\u043b\u0438, \u043f\u0440\u0438\u043d\u0446\u0438\u043f\u044b, \u0442\u0440\u0435\u0431\u043e\u0432\u0430\u043d\u0438\u044f 5 Implementation - Work Packages Tasks 1-4 \u0438 deliverables 6 Data Flow - CDC Pipeline \u041f\u043e\u0442\u043e\u043a \u0434\u0430\u043d\u043d\u044b\u0445 CDC 7 Security Architecture \u0410\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0430 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438"},{"location":"diagrams/archimate/#_6","title":"\u042d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u043c\u043e\u0434\u0435\u043b\u0438","text":""},{"location":"diagrams/archimate/#business-layer","title":"Business Layer","text":""},{"location":"diagrams/archimate/#business-actors","title":"\u0410\u043a\u0442\u043e\u0440\u044b (Business Actors)","text":"\u042d\u043b\u0435\u043c\u0435\u043d\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430 \u0412\u043b\u0430\u0434\u0435\u043b\u0435\u0446 \u0431\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u043f\u0440\u043e\u0442\u0435\u0437\u0430 \u041f\u043e\u043a\u0443\u043f\u0430\u0442\u0435\u043b\u044c \u0417\u0430\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u043f\u0440\u043e\u0442\u0435\u0437\u044b \u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 CRM \u0423\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438 ML-\u0438\u043d\u0436\u0435\u043d\u0435\u0440 \u0410\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0435 \u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440 \u0423\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0441\u0438\u0441\u0442\u0435\u043c\u043e\u0439"},{"location":"diagrams/archimate/#-","title":"\u0411\u0438\u0437\u043d\u0435\u0441-\u043f\u0440\u043e\u0446\u0435\u0441\u0441\u044b","text":"\u041f\u0440\u043e\u0446\u0435\u0441\u0441 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u041f\u0440\u043e\u0441\u043c\u043e\u0442\u0440 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0441\u043c\u0430\u0442\u0440\u0438\u0432\u0430\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0435 \u043e \u043f\u0440\u043e\u0442\u0435\u0437\u0435 \u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f \u0412\u0445\u043e\u0434 \u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u0443 \u0423\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438 \u0420\u0430\u0431\u043e\u0442\u0430 \u0441 CRM \u0421\u0431\u043e\u0440 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 \u041f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u0441 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 \u0410\u043d\u0430\u043b\u0438\u0437 \u0434\u0430\u043d\u043d\u044b\u0445 ML \u0430\u043d\u0430\u043b\u0438\u0437 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438"},{"location":"diagrams/archimate/#application-layer","title":"Application Layer","text":""},{"location":"diagrams/archimate/#application-components","title":"\u041f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f (Application Components)","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 Frontend SPA React 18 3000 BFF Auth Service Flask 8000 Reports Service FastAPI 8001 Keycloak Keycloak 26.5 8080 Apache Airflow Airflow 2.8 8081 Debezium Connect Kafka Connect 8083 Nginx CDN Nginx 1.25 8002"},{"location":"diagrams/archimate/#application-services","title":"Application Services","text":"\u0421\u0435\u0440\u0432\u0438\u0441 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Auth API /auth/login, /auth/callback, /auth/logout Reports API /api/reports, /api/reports/cdn/* OAuth2 OIDC Authorization Code + PKCE ETL Service \u041f\u0435\u0440\u0438\u043e\u0434\u0438\u0447\u0435\u0441\u043a\u0438\u0439 ETL (15 \u043c\u0438\u043d) CDC Service Real-time Change Data Capture CDN Cache HTTP \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435"},{"location":"diagrams/archimate/#application-functions","title":"Application Functions","text":"\u0424\u0443\u043d\u043a\u0446\u0438\u044f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 PKCE Generation code_verifier, code_challenge (S256) Token Encryption Fernet \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0432 Redis Report Generation JSON \u0438\u0437 ClickHouse Cache Invalidation \u041e\u0447\u0438\u0441\u0442\u043a\u0430 \u043a\u044d\u0448\u0430 \u043f\u043e\u0441\u043b\u0435 ETL Data Transformation JOIN \u0432 ETL CDC Capture \u0417\u0430\u0445\u0432\u0430\u0442 \u0438\u0437 WAL PostgreSQL"},{"location":"diagrams/archimate/#technology-layer","title":"Technology Layer","text":""},{"location":"diagrams/archimate/#nodes-docker-containers","title":"Nodes (Docker Containers)","text":"Container Port \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 frontend-container 3000 React SPA bff-auth-container 8000 BFF Auth reports-service-container 8001 Reports API keycloak-container 8080 Identity Provider clickhouse-container 8123, 9000 OLAP Database kafka-container 9092 Message Broker debezium-container 8083 CDC Connector minio-container 9001, 9002 S3 Storage nginx-cdn-container 8002 CDN Proxy redis-container 6379 Session Store ldap-container 389 Directory crm-db-container 5435 CRM PostgreSQL telemetry-db-container 5436 Telemetry PostgreSQL"},{"location":"diagrams/archimate/#system-software","title":"System Software","text":"Software Version Docker Engine - Docker Compose - PostgreSQL 14 ClickHouse 24.1 Apache Kafka 3.6 Redis 7 OpenLDAP 1.5 MinIO - Nginx 1.25"},{"location":"diagrams/archimate/#motivation-layer","title":"Motivation Layer","text":""},{"location":"diagrams/archimate/#goals","title":"Goals (\u0426\u0435\u043b\u0438)","text":"\u0426\u0435\u043b\u044c \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u0411\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u0430\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f MFA, BFF pattern \u041e\u0442\u0447\u0451\u0442\u043d\u043e\u0441\u0442\u044c \u0432 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u043c \u0432\u0440\u0435\u043c\u0435\u043d\u0438 ETL + CDC \u0420\u0430\u0437\u0434\u0435\u043b\u0435\u043d\u0438\u0435 OLTP/OLAP CDC pipeline \u0421\u043d\u0438\u0436\u0435\u043d\u0438\u0435 \u043d\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u043d\u0430 \u0411\u0414 \u041c\u043d\u043e\u0433\u043e\u0443\u0440\u043e\u0432\u043d\u0435\u0432\u043e\u0435 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435"},{"location":"diagrams/archimate/#principles","title":"Principles (\u041f\u0440\u0438\u043d\u0446\u0438\u043f\u044b)","text":"\u041f\u0440\u0438\u043d\u0446\u0438\u043f \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 BFF Pattern \u0422\u043e\u043a\u0435\u043d\u044b \u043d\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0435, cookies \u043d\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0435 OAuth2 PKCE S256 challenge \u0434\u043b\u044f \u0437\u0430\u0449\u0438\u0442\u044b \u043a\u043e\u0434\u0430 CDC over ETL for CRM Real-time \u0440\u0435\u043f\u043b\u0438\u043a\u0430\u0446\u0438\u044f \u0432\u043c\u0435\u0441\u0442\u043e batch Multi-tier Caching Redis \u2192 S3 \u2192 Nginx CDN"},{"location":"diagrams/archimate/#requirements","title":"Requirements (\u0422\u0440\u0435\u0431\u043e\u0432\u0430\u043d\u0438\u044f)","text":"\u0422\u0440\u0435\u0431\u043e\u0432\u0430\u043d\u0438\u0435 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 MFA \u043e\u0431\u044f\u0437\u0430\u0442\u0435\u043b\u044c\u043d\u0430 \u0414\u0432\u0443\u0445\u0444\u0430\u043a\u0442\u043e\u0440\u043d\u0430\u044f \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f \u0422\u043e\u043a\u0435\u043d\u044b \u043d\u0435 \u043d\u0430 \u043a\u043b\u0438\u0435\u043d\u0442\u0435 HTTP-only cookies ETL \u043a\u0430\u0436\u0434\u044b\u0435 15 \u043c\u0438\u043d\u0443\u0442 Schedule: */15 * * * * CDC latency &lt; 1s Real-time \u0440\u0435\u043f\u043b\u0438\u043a\u0430\u0446\u0438\u044f Cache TTL 5 min \u0412\u0440\u0435\u043c\u044f \u0436\u0438\u0437\u043d\u0438 \u043a\u044d\u0448\u0430 CDN"},{"location":"diagrams/archimate/#implementation-layer","title":"Implementation Layer","text":""},{"location":"diagrams/archimate/#work-packages","title":"Work Packages","text":"Task \u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 Deliverables Task 1 Security Architecture BFF Auth Service Task 2 Reports &amp; ETL Reports Service, ETL DAGs Task 3 S3/CDN Caching CDN Configuration Task 4 CDC Pipeline CDC Pipeline"},{"location":"diagrams/archimate/#relations","title":"\u0421\u0432\u044f\u0437\u0438 (Relations)","text":"<p>\u041c\u043e\u0434\u0435\u043b\u044c \u0441\u043e\u0434\u0435\u0440\u0436\u0438\u0442 \u0441\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0435 \u0442\u0438\u043f\u044b \u0441\u0432\u044f\u0437\u0435\u0439:</p> <ul> <li>Assignment - \u043d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 (\u0430\u043a\u0442\u043e\u0440 \u2192 \u0440\u043e\u043b\u044c)</li> <li>Triggering - \u0442\u0440\u0438\u0433\u0433\u0435\u0440 (\u0430\u043a\u0442\u043e\u0440 \u2192 \u043f\u0440\u043e\u0446\u0435\u0441\u0441)</li> <li>Realization - \u0440\u0435\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f (\u043f\u0440\u043e\u0446\u0435\u0441\u0441 \u2192 \u0441\u0435\u0440\u0432\u0438\u0441)</li> <li>Serving - \u043e\u0431\u0441\u043b\u0443\u0436\u0438\u0432\u0430\u043d\u0438\u0435 (\u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u2192 \u0430\u043a\u0442\u043e\u0440)</li> <li>Flow - \u043f\u043e\u0442\u043e\u043a \u0434\u0430\u043d\u043d\u044b\u0445</li> <li>Composition - \u043a\u043e\u043c\u043f\u043e\u0437\u0438\u0446\u0438\u044f (\u0443\u0437\u0435\u043b \u2192 \u043f\u043e\u0434\u0443\u0437\u0435\u043b)</li> <li>Access - \u0434\u043e\u0441\u0442\u0443\u043f \u043a \u0434\u0430\u043d\u043d\u044b\u043c</li> <li>Influence - \u0432\u043b\u0438\u044f\u043d\u0438\u0435 (\u043e\u0433\u0440\u0430\u043d\u0438\u0447\u0435\u043d\u0438\u0435 \u2192 \u0442\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f)</li> </ul>"},{"location":"diagrams/archimate/#_7","title":"\u042d\u043a\u0441\u043f\u043e\u0440\u0442","text":""},{"location":"diagrams/archimate/#_8","title":"\u0412 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f","text":"<ol> <li>\u041e\u0442\u043a\u0440\u043e\u0439\u0442\u0435 \u043d\u0443\u0436\u043d\u043e\u0435 View</li> <li>File \u2192 Export \u2192 Export View As Image</li> <li>\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0444\u043e\u0440\u043c\u0430\u0442 (PNG, JPG, SVG, PDF)</li> </ol>"},{"location":"diagrams/archimate/#html-report","title":"\u0412 HTML Report","text":"<ol> <li>File \u2192 Report \u2192 HTML Report</li> <li>\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u043f\u0430\u043f\u043a\u0443 \u0434\u043b\u044f \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f</li> <li>\u041f\u043e\u043b\u0443\u0447\u0438\u0442\u0435 \u0438\u043d\u0442\u0435\u0440\u0430\u043a\u0442\u0438\u0432\u043d\u044b\u0439 HTML \u043e\u0442\u0447\u0451\u0442</li> </ol>"},{"location":"diagrams/archimate/#_9","title":"\u0412 \u0434\u0440\u0443\u0433\u0438\u0445 \u0444\u043e\u0440\u043c\u0430\u0442\u0430\u0445","text":"<p>Archi \u043f\u043e\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442 \u044d\u043a\u0441\u043f\u043e\u0440\u0442 \u0432: - CSV - XML (Open Exchange Format) - Jasper Reports</p>"},{"location":"diagrams/archimate/#_10","title":"\u0420\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435","text":""},{"location":"diagrams/archimate/#_11","title":"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u043e\u0432","text":"<ol> <li>\u0412 Palette \u0432\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0442\u0438\u043f \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430</li> <li>\u041f\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u043d\u0430 View</li> <li>\u0417\u0430\u0434\u0430\u0439\u0442\u0435 \u0438\u043c\u044f \u0438 \u0441\u0432\u043e\u0439\u0441\u0442\u0432\u0430</li> </ol>"},{"location":"diagrams/archimate/#_12","title":"\u0414\u043e\u0431\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0441\u0432\u044f\u0437\u0435\u0439","text":"<ol> <li>\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u043d\u0441\u0442\u0440\u0443\u043c\u0435\u043d\u0442 \u0441\u0432\u044f\u0437\u0438 (Magic Connector \u0438\u043b\u0438 \u043a\u043e\u043d\u043a\u0440\u0435\u0442\u043d\u044b\u0439 \u0442\u0438\u043f)</li> <li>\u0421\u043e\u0435\u0434\u0438\u043d\u0438\u0442\u0435 \u0434\u0432\u0430 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u0430</li> <li>Archi \u0430\u0432\u0442\u043e\u043c\u0430\u0442\u0438\u0447\u0435\u0441\u043a\u0438 \u043f\u043e\u0434\u0431\u0435\u0440\u0451\u0442 \u0434\u043e\u043f\u0443\u0441\u0442\u0438\u043c\u044b\u0439 \u0442\u0438\u043f \u0441\u0432\u044f\u0437\u0438</li> </ol>"},{"location":"diagrams/archimate/#view","title":"\u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435 \u043d\u043e\u0432\u043e\u0433\u043e View","text":"<ol> <li>File \u2192 New \u2192 View</li> <li>\u0412\u044b\u0431\u0435\u0440\u0438\u0442\u0435 \u0442\u0438\u043f (ArchiMate, Sketch, Canvas)</li> <li>\u041f\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u044d\u043b\u0435\u043c\u0435\u043d\u0442\u044b \u0438\u0437 Model Tree</li> </ol>"},{"location":"diagrams/archimate/#_13","title":"\u0421\u043c. \u0442\u0430\u043a\u0436\u0435","text":"<ul> <li>Architecture Overview</li> <li>C4 Diagrams</li> <li>Deployment Diagram</li> </ul>"},{"location":"diagrams/c4-level1/","title":"C4 Level 1: System Context","text":""},{"location":"diagrams/c4-level1/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>System Context Diagram \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u0441\u0438\u0441\u0442\u0435\u043c\u0443 BionicPRO \u0432 \u043a\u043e\u043d\u0442\u0435\u043a\u0441\u0442\u0435 \u0435\u0451 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0438 \u0432\u043d\u0435\u0448\u043d\u0438\u0445 \u0441\u0438\u0441\u0442\u0435\u043c.</p>"},{"location":"diagrams/c4-level1/#_2","title":"\u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430","text":"<pre><code>@startuml BionicPRO_C4_Level1_Context\n!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml\n\ntitle BionicPRO - C4 Level 1: System Context Diagram\n\n' ==================== ACTORS ====================\nPerson(prosthesis_user, \"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430\", \"\u0412\u043b\u0430\u0434\u0435\u043b\u0435\u0446 \u0431\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u043f\u0440\u043e\u0442\u0435\u0437\u0430, \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u0443\u0435\u0442 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0434\u043b\u044f \u043c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433\u0430 \u0438 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438\")\nPerson(buyer, \"\u041f\u043e\u043a\u0443\u043f\u0430\u0442\u0435\u043b\u044c\", \"\u0417\u0430\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u0438 \u043e\u043f\u043b\u0430\u0447\u0438\u0432\u0430\u0435\u0442 \u043f\u0440\u043e\u0442\u0435\u0437\u044b \u0447\u0435\u0440\u0435\u0437 \u0438\u043d\u0442\u0435\u0440\u043d\u0435\u0442-\u043c\u0430\u0433\u0430\u0437\u0438\u043d\")\nPerson(operator, \"\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 CRM\", \"\u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u0438\u0439 \u0441\u043e\u0442\u0440\u0443\u0434\u043d\u0438\u043a, \u0443\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438 \u0438 \u043a\u043b\u0438\u0435\u043d\u0442\u0430\u043c\u0438\")\nPerson(ml_engineer, \"ML-\u0438\u043d\u0436\u0435\u043d\u0435\u0440\", \"\u0410\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0435 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 \u0434\u043b\u044f \u0443\u043b\u0443\u0447\u0448\u0435\u043d\u0438\u044f \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u043e\u0432 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u043c\")\nPerson(admin, \"\u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440\", \"\u0423\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0441\u0438\u0441\u0442\u0435\u043c\u043e\u0439, \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c\u0438 \u0438 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u044c\u044e\")\n\n' ==================== MAIN SYSTEM ====================\nSystem(bionicpro, \"BionicPRO Platform\", \"\u041f\u043b\u0430\u0442\u0444\u043e\u0440\u043c\u0430 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0431\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u043c\u0438 \u043f\u0440\u043e\u0442\u0435\u0437\u0430\u043c\u0438:\\n- \u0410\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u044f \u0438 \u0430\u0432\u0442\u043e\u0440\u0438\u0437\u0430\u0446\u0438\u044f\\n- \u0421\u0431\u043e\u0440 \u0438 \u0430\u043d\u0430\u043b\u0438\u0437 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438\\n- \u0424\u043e\u0440\u043c\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043e\u0442\u0447\u0451\u0442\u043e\u0432\\n- CRM \u0438 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438\")\n\n' ==================== EXTERNAL SYSTEMS ====================\nSystem_Ext(prosthesis, \"\u0411\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u043f\u0440\u043e\u0442\u0435\u0437\", \"\u0423\u0441\u0442\u0440\u043e\u0439\u0441\u0442\u0432\u043e \u0441 \u0447\u0438\u043f\u043e\u043c ESP32/C++\\n\u041f\u0435\u0440\u0435\u0434\u0430\u0451\u0442 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u044e \u0447\u0435\u0440\u0435\u0437 4G/WiFi\")\nSystem_Ext(ldap_ru, \"LDAP Russia\", \"\u041a\u0430\u0442\u0430\u043b\u043e\u0433 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439\\n\u0440\u043e\u0441\u0441\u0438\u0439\u0441\u043a\u043e\u0433\u043e \u043f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u0438\u0442\u0435\u043b\u044c\u0441\u0442\u0432\u0430\")\nSystem_Ext(ldap_eu, \"LDAP Europe\", \"\u041a\u0430\u0442\u0430\u043b\u043e\u0433 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439\\n\u0435\u0432\u0440\u043e\u043f\u0435\u0439\u0441\u043a\u043e\u0433\u043e \u043f\u0440\u0435\u0434\u0441\u0442\u0430\u0432\u0438\u0442\u0435\u043b\u044c\u0441\u0442\u0432\u0430\")\nSystem_Ext(yandex_id, \"\u042f\u043d\u0434\u0435\u043a\u0441 ID\", \"\u0412\u043d\u0435\u0448\u043d\u0438\u0439 OAuth2/OIDC \u043f\u0440\u043e\u0432\u0430\u0439\u0434\u0435\u0440\\n\u0434\u043b\u044f \u0440\u043e\u0441\u0441\u0438\u0439\u0441\u043a\u0438\u0445 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439\")\nSystem_Ext(other_idp, \"Other IdPs\", \"Google, Apple \u0438 \u0434\u0440.\\n\u0432\u043d\u0435\u0448\u043d\u0438\u0435 \u043f\u0440\u043e\u0432\u0430\u0439\u0434\u0435\u0440\u044b \u0438\u0434\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438\")\n\n' ==================== RELATIONSHIPS ====================\nRel(prosthesis_user, bionicpro, \"\u041f\u0440\u043e\u0441\u043c\u0430\u0442\u0440\u0438\u0432\u0430\u0435\u0442 \u043e\u0442\u0447\u0451\u0442\u044b,\\n\u043d\u0430\u0441\u0442\u0440\u0430\u0438\u0432\u0430\u0435\u0442 \u043f\u0440\u043e\u0442\u0435\u0437\", \"HTTPS\")\nRel(buyer, bionicpro, \"\u0417\u0430\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u043f\u0440\u043e\u0442\u0435\u0437\u044b,\\n\u043e\u0442\u0441\u043b\u0435\u0436\u0438\u0432\u0430\u0435\u0442 \u0434\u043e\u0441\u0442\u0430\u0432\u043a\u0443\", \"HTTPS\")\nRel(operator, bionicpro, \"\u0423\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438,\\n\u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442 \u0441 \u043a\u043b\u0438\u0435\u043d\u0442\u0430\u043c\u0438\", \"HTTPS\")\nRel(ml_engineer, bionicpro, \"\u0410\u043d\u0430\u043b\u0438\u0437\u0438\u0440\u0443\u0435\u0442 \u0434\u0430\u043d\u043d\u044b\u0435,\\n\u043e\u0431\u0443\u0447\u0430\u0435\u0442 \u043c\u043e\u0434\u0435\u043b\u0438\", \"SQL/HTTPS\")\nRel(admin, bionicpro, \"\u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0438\u0440\u0443\u0435\u0442\\n\u0441\u0438\u0441\u0442\u0435\u043c\u0443\", \"HTTPS\")\n\nRel(prosthesis, bionicpro, \"\u041f\u0435\u0440\u0435\u0434\u0430\u0451\u0442 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u044e:\\n\u043c\u0438\u043e\u0441\u0438\u0433\u043d\u0430\u043b\u044b, \u0434\u0432\u0438\u0436\u0435\u043d\u0438\u044f,\\n\u0431\u0430\u0442\u0430\u0440\u0435\u044f, \u043e\u0448\u0438\u0431\u043a\u0438\", \"HTTPS/4G\")\nRel_L(bionicpro, ldap_ru, \"User Federation\", \"LDAPS\")\nRel_R(bionicpro, ldap_eu, \"User Federation\", \"LDAPS\")\nRel(bionicpro, yandex_id, \"Identity Brokering\", \"OAuth2/OIDC\")\nRel(bionicpro, other_idp, \"Identity Brokering\", \"OAuth2/OIDC\")\n\nSHOW_LEGEND()\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level1/#users","title":"\u0410\u043a\u0442\u043e\u0440\u044b (Users)","text":"\u0410\u043a\u0442\u043e\u0440 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 \u041e\u0441\u043d\u043e\u0432\u043d\u044b\u0435 \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u044f \u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430 \u0412\u043b\u0430\u0434\u0435\u043b\u0435\u0446 \u0431\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u043e\u0433\u043e \u043f\u0440\u043e\u0442\u0435\u0437\u0430 \u041f\u0440\u043e\u0441\u043c\u043e\u0442\u0440 \u043e\u0442\u0447\u0451\u0442\u043e\u0432, \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430 \u043f\u0440\u043e\u0442\u0435\u0437\u0430 \u041f\u043e\u043a\u0443\u043f\u0430\u0442\u0435\u043b\u044c \u041f\u043e\u0442\u0435\u043d\u0446\u0438\u0430\u043b\u044c\u043d\u044b\u0439 \u043a\u043b\u0438\u0435\u043d\u0442 \u0417\u0430\u043a\u0430\u0437 \u0438 \u043e\u043f\u043b\u0430\u0442\u0430 \u043f\u0440\u043e\u0442\u0435\u0437\u043e\u0432 \u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 CRM \u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u0438\u0439 \u0441\u043e\u0442\u0440\u0443\u0434\u043d\u0438\u043a \u0423\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438 \u0438 \u043a\u043b\u0438\u0435\u043d\u0442\u0430\u043c\u0438 ML-\u0438\u043d\u0436\u0435\u043d\u0435\u0440 \u0421\u043f\u0435\u0446\u0438\u0430\u043b\u0438\u0441\u0442 \u043f\u043e \u0434\u0430\u043d\u043d\u044b\u043c \u0410\u043d\u0430\u043b\u0438\u0437 \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438, \u043e\u0431\u0443\u0447\u0435\u043d\u0438\u0435 \u043c\u043e\u0434\u0435\u043b\u0435\u0439 \u0410\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440 \u0421\u0438\u0441\u0442\u0435\u043c\u043d\u044b\u0439 \u0430\u0434\u043c\u0438\u043d\u0438\u0441\u0442\u0440\u0430\u0442\u043e\u0440 \u0423\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f\u043c\u0438 \u0438 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u044c\u044e"},{"location":"diagrams/c4-level1/#_3","title":"\u0412\u043d\u0435\u0448\u043d\u0438\u0435 \u0441\u0438\u0441\u0442\u0435\u043c\u044b","text":"\u0421\u0438\u0441\u0442\u0435\u043c\u0430 \u041d\u0430\u0437\u043d\u0430\u0447\u0435\u043d\u0438\u0435 \u041f\u0440\u043e\u0442\u043e\u043a\u043e\u043b \u0411\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u043f\u0440\u043e\u0442\u0435\u0437 \u0418\u0441\u0442\u043e\u0447\u043d\u0438\u043a \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u0438 HTTPS/4G LDAP Russia \u041a\u0430\u0442\u0430\u043b\u043e\u0433 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 \u0420\u0424 LDAPS LDAP Europe \u041a\u0430\u0442\u0430\u043b\u043e\u0433 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 EU LDAPS \u042f\u043d\u0434\u0435\u043a\u0441 ID OAuth2 \u043f\u0440\u043e\u0432\u0430\u0439\u0434\u0435\u0440 OIDC Other IdPs \u0414\u0440\u0443\u0433\u0438\u0435 \u043f\u0440\u043e\u0432\u0430\u0439\u0434\u0435\u0440\u044b OAuth2/OIDC"},{"location":"diagrams/c4-level1/#_4","title":"\u0418\u0441\u0445\u043e\u0434\u043d\u044b\u0439 \u0444\u0430\u0439\u043b","text":"<p>c4-level1-context.puml</p>"},{"location":"diagrams/c4-level2/","title":"C4 Level 2: Container Diagram","text":""},{"location":"diagrams/c4-level2/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>Container Diagram \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u0432\u044b\u0441\u043e\u043a\u043e\u0443\u0440\u043e\u0432\u043d\u0435\u0432\u0443\u044e \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u0443 \u0441\u0438\u0441\u0442\u0435\u043c\u044b BionicPRO \u0438 \u0432\u0437\u0430\u0438\u043c\u043e\u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435 \u043c\u0435\u0436\u0434\u0443 \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u0430\u043c\u0438 (\u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u044f\u043c\u0438, \u0431\u0430\u0437\u0430\u043c\u0438 \u0434\u0430\u043d\u043d\u044b\u0445, \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u043c\u0438).</p>"},{"location":"diagrams/c4-level2/#_2","title":"\u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430","text":"<pre><code>@startuml BionicPRO_C4_Level2_Container\n!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml\n\ntitle BionicPRO - C4 Level 2: Container Diagram\n\nPerson(user, \"\u041f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u0440\u043e\u0442\u0435\u0437\u0430\", \"\u041f\u0440\u043e\u0441\u043c\u0430\u0442\u0440\u0438\u0432\u0430\u0435\u0442 \u043e\u0442\u0447\u0451\u0442\u044b\")\nPerson(operator, \"\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440 CRM\", \"\u0423\u043f\u0440\u0430\u0432\u043b\u044f\u0435\u0442 \u0437\u0430\u043a\u0430\u0437\u0430\u043c\u0438\")\n\nSystem_Ext(prosthesis, \"\u0411\u0438\u043e\u043d\u0438\u0447\u0435\u0441\u043a\u0438\u0439 \u043f\u0440\u043e\u0442\u0435\u0437\", \"ESP32\")\nSystem_Ext(ldap, \"LDAP Servers\", \"OpenLDAP\")\nSystem_Ext(external_idp, \"External IdPs\", \"\u042f\u043d\u0434\u0435\u043a\u0441 ID\")\n\nSystem_Boundary(bionicpro, \"BionicPRO Platform\") {\n    Container(frontend, \"Frontend SPA\", \"React 18\", \"\u0412\u0435\u0431-\u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435\")\n    Container(keycloak, \"Keycloak\", \"Keycloak 26.5\", \"Identity Provider\")\n    Container(bff, \"BFF Auth\", \"Flask\", \"Backend-for-Frontend\")\n    ContainerDb(redis, \"Redis\", \"Redis 7\", \"Sessions\")\n    Container(reports_svc, \"Reports Service\", \"FastAPI\", \"REST API\")\n    Container(airflow, \"Airflow\", \"Airflow 2.8\", \"ETL\")\n    Container(debezium, \"Debezium\", \"Kafka Connect\", \"CDC\")\n    Container(kafka, \"Kafka\", \"Kafka 3.6\", \"Message Broker\")\n    ContainerDb(crm_db, \"CRM DB\", \"PostgreSQL\", \"OLTP\")\n    ContainerDb(telemetry_db, \"Telemetry DB\", \"PostgreSQL\", \"OLTP\")\n    ContainerDb(clickhouse, \"ClickHouse\", \"ClickHouse 24.1\", \"OLAP\")\n    ContainerDb(minio, \"MinIO S3\", \"MinIO\", \"Object Storage\")\n    Container(nginx_cdn, \"Nginx CDN\", \"Nginx\", \"CDN Proxy\")\n}\n\nRel(user, frontend, \"HTTPS\")\nRel(frontend, bff, \"HTTP + Cookie\")\nRel(bff, keycloak, \"OAuth2 PKCE\")\nRel(bff, redis, \"TCP\")\nRel(bff, reports_svc, \"HTTP + JWT\")\nRel(keycloak, ldap, \"LDAPS\")\nRel(keycloak, external_idp, \"OAuth2\")\nRel(reports_svc, clickhouse, \"TCP\")\nRel(reports_svc, minio, \"S3 API\")\nRel(frontend, nginx_cdn, \"HTTPS\")\nRel(nginx_cdn, minio, \"HTTP\")\nRel(airflow, crm_db, \"SQL\")\nRel(airflow, telemetry_db, \"SQL\")\nRel(airflow, clickhouse, \"TCP\")\nRel(crm_db, debezium, \"WAL\")\nRel(debezium, kafka, \"Kafka\")\nRel(kafka, clickhouse, \"KafkaEngine\")\nRel(prosthesis, reports_svc, \"HTTPS/4G\")\n\nSHOW_LEGEND()\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level2/#_3","title":"\u0421\u043b\u043e\u0438 \u0430\u0440\u0445\u0438\u0442\u0435\u043a\u0442\u0443\u0440\u044b","text":""},{"location":"diagrams/c4-level2/#presentation-layer","title":"Presentation Layer","text":"\u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Frontend SPA React 18, TypeScript 3000 \u0412\u0435\u0431-\u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 \u0434\u043b\u044f \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u0435\u0439 Nginx CDN Nginx 1.25 8002 CDN proxy \u0441 \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435\u043c"},{"location":"diagrams/c4-level2/#security-layer","title":"Security Layer","text":"\u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Keycloak Keycloak 26.5.2 8080 Identity Provider, MFA BFF Auth Python/Flask 8000 Backend-for-Frontend, PKCE Redis Redis 7 6379 Session storage"},{"location":"diagrams/c4-level2/#application-layer","title":"Application Layer","text":"\u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Reports Service Python/FastAPI 8001 REST API \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432 Airflow Apache Airflow 2.8 8081 ETL \u043e\u0440\u043a\u0435\u0441\u0442\u0440\u0430\u0442\u043e\u0440"},{"location":"diagrams/c4-level2/#data-layer","title":"Data Layer","text":"\u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 CRM DB PostgreSQL 14 5435 OLTP: \u043a\u043b\u0438\u0435\u043d\u0442\u044b, \u0437\u0430\u043a\u0430\u0437\u044b Telemetry DB PostgreSQL 14 5436 OLTP: \u0442\u0435\u043b\u0435\u043c\u0435\u0442\u0440\u0438\u044f ClickHouse ClickHouse 24.1 8123/9000 OLAP: \u0432\u0438\u0442\u0440\u0438\u043d\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432 MinIO S3 MinIO 9001/9002 Object storage"},{"location":"diagrams/c4-level2/#cdc-pipeline","title":"CDC Pipeline","text":"\u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440 \u0422\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f \u041f\u043e\u0440\u0442 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Debezium Debezium Connect 8083 CDC \u043a\u043e\u043d\u043d\u0435\u043a\u0442\u043e\u0440 Kafka Apache Kafka 3.6 9092 Message broker Zookeeper Apache Zookeeper 2181 \u041a\u043e\u043e\u0440\u0434\u0438\u043d\u0430\u0442\u043e\u0440"},{"location":"diagrams/c4-level2/#_4","title":"\u0418\u0441\u0445\u043e\u0434\u043d\u044b\u0439 \u0444\u0430\u0439\u043b","text":"<p>c4-level2-container.puml</p>"},{"location":"diagrams/c4-level3/","title":"C4 Level 3: Component Diagrams","text":""},{"location":"diagrams/c4-level3/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>Component Diagrams \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u044e\u0442 \u0432\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u044e\u044e \u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0443 \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0445 \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u043e\u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u044b BionicPRO.</p>"},{"location":"diagrams/c4-level3/#bff-auth-service-components","title":"BFF Auth Service Components","text":"<p>\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438 (Backend-for-Frontend).</p> <pre><code>@startuml BFF_Components\n!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml\n\ntitle BFF Auth Service - Components\n\nContainer_Boundary(bff, \"BFF Auth Service\") {\n    Component(auth_ctrl, \"Auth Controller\", \"Flask\", \"/auth/login, /callback, /logout\")\n    Component(proxy_ctrl, \"Proxy Controller\", \"Flask\", \"Proxy to backend services\")\n    Component(pkce_svc, \"PKCE Service\", \"Python\", \"code_verifier, code_challenge\")\n    Component(token_svc, \"Token Service\", \"Python\", \"Exchange, refresh, encrypt\")\n    Component(session_svc, \"Session Service\", \"Python\", \"Session management\")\n    Component(kc_client, \"Keycloak Client\", \"requests\", \"OAuth2/OIDC client\")\n    Component(redis_client, \"Redis Client\", \"redis-py\", \"Session storage\")\n    Component(encryption, \"Encryption\", \"Fernet\", \"Token encryption\")\n}\n\nContainer_Ext(keycloak, \"Keycloak\")\nContainerDb_Ext(redis, \"Redis\")\nContainer_Ext(reports, \"Reports Service\")\n\nRel(auth_ctrl, pkce_svc, \"Uses\")\nRel(auth_ctrl, token_svc, \"Uses\")\nRel(auth_ctrl, session_svc, \"Uses\")\nRel(proxy_ctrl, session_svc, \"Validates\")\nRel(proxy_ctrl, token_svc, \"Gets token\")\nRel(token_svc, kc_client, \"Exchange/Refresh\")\nRel(token_svc, encryption, \"Encrypt/Decrypt\")\nRel(token_svc, redis_client, \"Store\")\nRel(session_svc, redis_client, \"CRUD\")\nRel(kc_client, keycloak, \"HTTP\")\nRel(redis_client, redis, \"TCP\")\nRel(proxy_ctrl, reports, \"HTTP + JWT\")\n\nSHOW_LEGEND()\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level3/#bff","title":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b BFF","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u041e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0435\u043d\u043d\u043e\u0441\u0442\u044c Auth Controller Endpoints: /auth/login, /auth/callback, /auth/logout, /auth/me Proxy Controller \u041f\u0440\u043e\u043a\u0441\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0437\u0430\u043f\u0440\u043e\u0441\u043e\u0432 \u043a backend \u0441\u0435\u0440\u0432\u0438\u0441\u0430\u043c PKCE Service \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f code_verifier \u0438 code_challenge (S256) Token Service \u041e\u0431\u043c\u0435\u043d \u043a\u043e\u0434\u0430 \u043d\u0430 \u0442\u043e\u043a\u0435\u043d\u044b, refresh, \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 Session Service \u0421\u043e\u0437\u0434\u0430\u043d\u0438\u0435, \u0432\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f, \u0440\u043e\u0442\u0430\u0446\u0438\u044f \u0441\u0435\u0441\u0441\u0438\u0439 Keycloak Client HTTP \u043a\u043b\u0438\u0435\u043d\u0442 \u0434\u043b\u044f Keycloak API Redis Client \u041a\u043b\u0438\u0435\u043d\u0442 \u0434\u043b\u044f \u0445\u0440\u0430\u043d\u0435\u043d\u0438\u044f \u0441\u0435\u0441\u0441\u0438\u0439 \u0438 \u0442\u043e\u043a\u0435\u043d\u043e\u0432 Encryption Fernet \u0448\u0438\u0444\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u0442\u043e\u043a\u0435\u043d\u043e\u0432"},{"location":"diagrams/c4-level3/#reports-service-components","title":"Reports Service Components","text":"<p>\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b \u0441\u0435\u0440\u0432\u0438\u0441\u0430 \u043e\u0442\u0447\u0451\u0442\u043e\u0432.</p> <pre><code>@startuml Reports_Components\n!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml\n\ntitle Reports Service - Components\n\nContainer_Boundary(reports, \"Reports Service\") {\n    Component(reports_router, \"Reports Router\", \"FastAPI\", \"/api/reports, /api/reports/{date}\")\n    Component(cdn_router, \"CDN Router\", \"FastAPI\", \"/api/reports/cdn/*, /invalidate\")\n    Component(health_router, \"Health Router\", \"FastAPI\", \"/health, /health/cdc\")\n    Component(jwt_handler, \"JWT Handler\", \"Python\", \"Token validation\")\n    Component(ch_service, \"ClickHouse Service\", \"clickhouse-connect\", \"OLAP queries\")\n    Component(s3_service, \"S3 Service\", \"boto3\", \"Object storage\")\n    Component(cache_service, \"Cache Service\", \"redis-py\", \"Metadata cache\")\n    Component(report_gen, \"Report Generator\", \"Python\", \"JSON report generation\")\n    Component(cdc_monitor, \"CDC Monitor\", \"Python\", \"CDC health monitoring\")\n}\n\nContainerDb_Ext(clickhouse, \"ClickHouse\")\nContainerDb_Ext(minio, \"MinIO S3\")\nContainerDb_Ext(redis, \"Redis\")\n\nRel(reports_router, jwt_handler, \"Auth\")\nRel(reports_router, ch_service, \"Query\")\nRel(cdn_router, s3_service, \"S3 ops\")\nRel(cdn_router, report_gen, \"Generate\")\nRel(health_router, cdc_monitor, \"Check CDC\")\nRel(report_gen, ch_service, \"Fetch data\")\nRel(report_gen, s3_service, \"Store\")\nRel(ch_service, clickhouse, \"TCP/9000\")\nRel(s3_service, minio, \"S3 API\")\nRel(cache_service, redis, \"TCP\")\n\nSHOW_LEGEND()\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level3/#reports-service","title":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b Reports Service","text":"\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442 \u041e\u0442\u0432\u0435\u0442\u0441\u0442\u0432\u0435\u043d\u043d\u043e\u0441\u0442\u044c Reports Router REST endpoints \u0434\u043b\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432 CDN Router CDN URLs \u0438 cache invalidation Health Router Health checks, CDC monitoring JWT Handler \u0412\u0430\u043b\u0438\u0434\u0430\u0446\u0438\u044f JWT \u0442\u043e\u043a\u0435\u043d\u043e\u0432 ClickHouse Service \u0417\u0430\u043f\u0440\u043e\u0441\u044b \u043a OLAP \u0431\u0430\u0437\u0435 S3 Service \u0420\u0430\u0431\u043e\u0442\u0430 \u0441 MinIO S3 Cache Service \u041a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435 \u043c\u0435\u0442\u0430\u0434\u0430\u043d\u043d\u044b\u0445 Report Generator \u0413\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u044f JSON \u043e\u0442\u0447\u0451\u0442\u043e\u0432 CDC Monitor \u041c\u043e\u043d\u0438\u0442\u043e\u0440\u0438\u043d\u0433 CDC pipeline"},{"location":"diagrams/c4-level3/#etl-pipeline-components","title":"ETL Pipeline Components","text":"<p>\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b ETL pipeline (Apache Airflow).</p> <pre><code>@startuml ETL_Components\n!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml\n\ntitle ETL Pipeline - Components\n\nContainer_Boundary(airflow, \"Apache Airflow\") {\n    Component(webserver, \"Webserver\", \"Flask\", \"Web UI\")\n    Component(scheduler, \"Scheduler\", \"Python\", \"DAG scheduling\")\n    Component(executor, \"Executor\", \"Python\", \"Task execution\")\n}\n\nContainer_Boundary(etl, \"ETL Jobs\") {\n    Component(dag_reports, \"bionicpro_reports_etl\", \"DAG\", \"Main ETL, */15 * * * *\")\n    Component(extract_crm, \"extract_crm_data\", \"Task\", \"Extract from CRM\")\n    Component(extract_tel, \"extract_telemetry\", \"Task\", \"Extract telemetry\")\n    Component(transform, \"transform_and_join\", \"Task\", \"JOIN, calculate metrics\")\n    Component(load, \"load_to_clickhouse\", \"Task\", \"INSERT to OLAP\")\n    Component(invalidate, \"invalidate_cache\", \"Task\", \"Clear CDN cache\")\n}\n\nContainerDb_Ext(crm_db, \"CRM DB\")\nContainerDb_Ext(tel_db, \"Telemetry DB\")\nContainerDb_Ext(clickhouse, \"ClickHouse\")\nContainer_Ext(reports_svc, \"Reports Service\")\n\nRel(scheduler, executor, \"Submit\")\nRel(executor, dag_reports, \"Execute\")\nRel(dag_reports, extract_crm, \"Task 1\")\nRel(dag_reports, extract_tel, \"Task 2\")\nRel(extract_crm, transform, \"XCom\")\nRel(extract_tel, transform, \"XCom\")\nRel(transform, load, \"XCom\")\nRel(load, invalidate, \"Trigger\")\nRel(extract_crm, crm_db, \"SQL\")\nRel(extract_tel, tel_db, \"SQL\")\nRel(load, clickhouse, \"INSERT\")\nRel(invalidate, reports_svc, \"POST\")\n\nSHOW_LEGEND()\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level3/#cdc-pipeline-components","title":"CDC Pipeline Components","text":"<p>\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u044b CDC pipeline (Debezium \u2192 Kafka \u2192 ClickHouse).</p> <pre><code>@startuml CDC_Components\n!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml\n\ntitle CDC Pipeline - Components\n\nContainer_Boundary(postgres, \"CRM PostgreSQL\") {\n    Component(wal, \"WAL\", \"PostgreSQL\", \"wal_level=logical\")\n    Component(publication, \"Publication\", \"PostgreSQL\", \"crm_publication\")\n    Component(slot, \"Replication Slot\", \"PostgreSQL\", \"debezium_crm_slot\")\n}\n\nContainer_Boundary(debezium, \"Debezium Connect\") {\n    Component(connector, \"PostgreSQL Connector\", \"Java\", \"CDC connector\")\n    Component(transforms, \"SMT Transforms\", \"Java\", \"ExtractNewRecordState\")\n    Component(converter, \"JSON Converter\", \"Kafka Connect\", \"Serialization\")\n}\n\nContainer_Boundary(kafka, \"Apache Kafka\") {\n    Component(topic_cust, \"crm.crm.customers\", \"Topic\", \"Customer events\")\n    Component(topic_pros, \"crm.crm.prostheses\", \"Topic\", \"Prostheses events\")\n    Component(topic_mod, \"crm.crm.models\", \"Topic\", \"Models events\")\n}\n\nContainer_Boundary(clickhouse, \"ClickHouse\") {\n    Component(kafka_engine, \"KafkaEngine Tables\", \"ClickHouse\", \"Consume from Kafka\")\n    Component(mv, \"MaterializedViews\", \"ClickHouse\", \"Transform &amp; insert\")\n    Component(target, \"Target Tables\", \"ReplacingMergeTree\", \"Deduplicated data\")\n    Component(cdc_view, \"cdc_customer_data\", \"View\", \"Joined CDC data\")\n}\n\nRel(wal, publication, \"Contains\")\nRel(slot, connector, \"Stream\")\nRel(connector, transforms, \"Events\")\nRel(transforms, converter, \"Transformed\")\nRel(converter, topic_cust, \"Publish\")\nRel(converter, topic_pros, \"Publish\")\nRel(converter, topic_mod, \"Publish\")\nRel(topic_cust, kafka_engine, \"Consume\")\nRel(topic_pros, kafka_engine, \"Consume\")\nRel(topic_mod, kafka_engine, \"Consume\")\nRel(kafka_engine, mv, \"Trigger\")\nRel(mv, target, \"INSERT\")\nRel(cdc_view, target, \"SELECT FINAL\")\n\nSHOW_LEGEND()\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level3/#_2","title":"\u0418\u0441\u0445\u043e\u0434\u043d\u044b\u0435 \u0444\u0430\u0439\u043b\u044b","text":"<ul> <li>c4-level3-bff-component.puml</li> <li>c4-level3-reports-component.puml</li> <li>c4-level3-etl-component.puml</li> <li>c4-level3-cdc-component.puml</li> </ul>"},{"location":"diagrams/c4-level4/","title":"C4 Level 4: Code (Class Diagrams)","text":""},{"location":"diagrams/c4-level4/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>Class Diagrams \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u044e\u0442 \u0441\u0442\u0440\u0443\u043a\u0442\u0443\u0440\u0443 \u043a\u043e\u0434\u0430 \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0445 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u044b BionicPRO.</p>"},{"location":"diagrams/c4-level4/#bff-auth-service-classes","title":"BFF Auth Service Classes","text":"<pre><code>@startuml BFF_Classes\n!theme plain\ntitle BFF Auth Service - Class Diagram\n\npackage \"Controllers\" {\n    class AuthController {\n        - pkce_service: PKCEService\n        - token_service: TokenService\n        - session_service: SessionService\n        --\n        + login(): Response\n        + callback(code, state): Response\n        + logout(): Response\n        + me(): Response\n    }\n\n    class ProxyController {\n        - session_service: SessionService\n        - token_service: TokenService\n        --\n        + proxy_request(path): Response\n    }\n}\n\npackage \"Services\" {\n    class PKCEService {\n        + generate_verifier(): str\n        + generate_challenge(verifier): str\n    }\n\n    class TokenService {\n        - keycloak_client: KeycloakClient\n        - encryption: EncryptionService\n        --\n        + exchange_code(code, verifier): TokenPair\n        + refresh_tokens(session_id): TokenPair\n        + get_access_token(session_id): str\n    }\n\n    class SessionService {\n        - redis_client: RedisClient\n        --\n        + create_session(user_info): str\n        + get_session(session_id): Session\n        + validate_session(session_id): bool\n        + rotate_session_id(old_id): str\n    }\n\n    class EncryptionService {\n        - fernet: Fernet\n        --\n        + encrypt(plaintext): str\n        + decrypt(ciphertext): str\n    }\n}\n\npackage \"Clients\" {\n    class KeycloakClient {\n        - base_url: str\n        - realm: str\n        --\n        + get_auth_url(state, challenge): str\n        + exchange_code(code, verifier): TokenResponse\n        + refresh_token(refresh_token): TokenResponse\n        + get_user_info(access_token): UserInfo\n    }\n\n    class RedisClient {\n        - connection: Redis\n        --\n        + set(key, value, ttl): void\n        + get(key): str\n        + delete(key): void\n    }\n}\n\npackage \"Models\" {\n    class TokenPair {\n        + access_token: str\n        + refresh_token: str\n        + expires_in: int\n    }\n\n    class Session {\n        + session_id: str\n        + user_info: UserInfo\n        + created_at: datetime\n    }\n\n    class UserInfo {\n        + sub: str\n        + preferred_username: str\n        + email: str\n        + roles: List[str]\n    }\n}\n\nAuthController --&gt; PKCEService\nAuthController --&gt; TokenService\nAuthController --&gt; SessionService\nProxyController --&gt; SessionService\nProxyController --&gt; TokenService\nTokenService --&gt; KeycloakClient\nTokenService --&gt; EncryptionService\nSessionService --&gt; RedisClient\nTokenService --&gt; TokenPair\nSessionService --&gt; Session\n\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level4/#reports-service-classes","title":"Reports Service Classes","text":"<pre><code>@startuml Reports_Classes\n!theme plain\ntitle Reports Service - Class Diagram\n\npackage \"Routers\" {\n    class ReportsRouter {\n        - ch_service: ClickHouseService\n        - cache_service: CacheService\n        --\n        + get_reports(user): ReportsList\n        + get_report_by_date(date, user): DailyReport\n        + get_summary(user): UserSummary\n    }\n\n    class CDNRouter {\n        - s3_service: S3Service\n        - report_generator: ReportGenerator\n        --\n        + get_cdn_list(user): CDNResponse\n        + get_cdn_report(date, user): CDNResponse\n        + invalidate_cache(request): void\n    }\n}\n\npackage \"Services\" {\n    class ClickHouseService {\n        - client: ClickHouseClient\n        --\n        + get_user_reports(username): List[ReportDate]\n        + get_report_by_date(username, date): DailyReport\n        + get_cdc_table_stats(): Dict\n    }\n\n    class S3Service {\n        - client: S3Client\n        - bucket: str\n        --\n        + check_exists(key): bool\n        + put_object(key, data): str\n        + delete_prefix(prefix): int\n        + get_cdn_url(key): str\n    }\n\n    class CacheService {\n        - redis: Redis\n        --\n        + get(key): str\n        + set(key, value, ttl): void\n        + delete_pattern(pattern): int\n    }\n\n    class ReportGenerator {\n        - ch_service: ClickHouseService\n        - s3_service: S3Service\n        --\n        + generate_reports_list(user_id, username): dict\n        + generate_daily_report(user_id, username, date): dict\n    }\n}\n\npackage \"Auth\" {\n    class JWTHandler {\n        - public_key: RSAPublicKey\n        --\n        + decode_token(token): TokenPayload\n        + get_current_user(credentials): User\n    }\n\n    class User {\n        + sub: str\n        + preferred_username: str\n        + email: str\n        + roles: List[str]\n    }\n}\n\npackage \"Models\" {\n    class ReportsList {\n        + reports: List[ReportDate]\n        + total: int\n        + user: str\n    }\n\n    class DailyReport {\n        + date: str\n        + summary: DailySummary\n        + hourly_data: List[HourlyData]\n    }\n\n    class DailySummary {\n        + total_movements: int\n        + avg_response_time_ms: float\n        + total_errors: int\n    }\n\n    class CDNResponse {\n        + cdn_url: str\n        + expires_in: int\n    }\n}\n\nReportsRouter --&gt; ClickHouseService\nReportsRouter --&gt; CacheService\nCDNRouter --&gt; S3Service\nCDNRouter --&gt; ReportGenerator\nReportGenerator --&gt; ClickHouseService\nReportGenerator --&gt; S3Service\nReportsRouter --&gt; JWTHandler\nJWTHandler --&gt; User\n\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level4/#etl-jobs-classes","title":"ETL Jobs Classes","text":"<pre><code>@startuml ETL_Classes\n!theme plain\ntitle ETL Jobs - Class Diagram\n\npackage \"DAGs\" {\n    class BionicProReportsETL {\n        + dag_id: str\n        + schedule_interval: str\n        --\n        + create_dag(): DAG\n    }\n}\n\npackage \"Tasks\" {\n    class ExtractCRMTask {\n        - postgres_hook: PostgresHook\n        --\n        + execute(context): DataFrame\n        - fetch_customers(): DataFrame\n        - fetch_prostheses(): DataFrame\n    }\n\n    class ExtractTelemetryTask {\n        - postgres_hook: PostgresHook\n        - lookback_hours: int\n        --\n        + execute(context): DataFrame\n        - aggregate_by_hour(): DataFrame\n    }\n\n    class TransformTask {\n        --\n        + execute(context): DataFrame\n        - join_datasets(crm, telemetry): DataFrame\n        - calculate_metrics(df): DataFrame\n    }\n\n    class LoadToClickHouseTask {\n        - clickhouse_client: ClickHouseClient\n        --\n        + execute(context): List[str]\n        - insert_data(df): int\n        - get_affected_user_ids(df): List[str]\n    }\n\n    class InvalidateCacheTask {\n        - http_hook: HttpHook\n        --\n        + execute(context): void\n        - invalidate_users(user_ids): void\n    }\n}\n\npackage \"Hooks\" {\n    class PostgresHook {\n        - conn_id: str\n        --\n        + get_pandas_df(sql): DataFrame\n    }\n\n    class ClickHouseHook {\n        - conn_id: str\n        --\n        + insert_dataframe(table, df): int\n    }\n\n    class HttpHook {\n        - conn_id: str\n        --\n        + run(endpoint, data): Response\n    }\n}\n\npackage \"Models\" {\n    class CRMData {\n        + customer_id: UUID\n        + customer_name: str\n        + ldap_username: str\n        + prosthesis_id: UUID\n        + chip_id: str\n    }\n\n    class TelemetryData {\n        + chip_id: str\n        + hour: datetime\n        + movements_count: int\n        + avg_response_time: float\n    }\n\n    class TransformedData {\n        + user_id: UUID\n        + ldap_username: str\n        + date: date\n        + hour: datetime\n        + movements_count: int\n        + error_rate: float\n    }\n}\n\nBionicProReportsETL --&gt; ExtractCRMTask\nBionicProReportsETL --&gt; ExtractTelemetryTask\nBionicProReportsETL --&gt; TransformTask\nBionicProReportsETL --&gt; LoadToClickHouseTask\nBionicProReportsETL --&gt; InvalidateCacheTask\n\nExtractCRMTask --&gt; PostgresHook\nExtractTelemetryTask --&gt; PostgresHook\nLoadToClickHouseTask --&gt; ClickHouseHook\nInvalidateCacheTask --&gt; HttpHook\n\nExtractCRMTask --&gt; CRMData\nExtractTelemetryTask --&gt; TelemetryData\nTransformTask --&gt; TransformedData\n\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level4/#data-model","title":"Data Model","text":"<pre><code>@startuml Data_Model\n!theme plain\ntitle BionicPRO - Data Model\n\npackage \"OLTP: PostgreSQL\" {\n    class \"crm.customers\" {\n        + id: UUID &lt;&lt;PK&gt;&gt;\n        + name: VARCHAR\n        + email: VARCHAR &lt;&lt;UK&gt;&gt;\n        + ldap_username: VARCHAR &lt;&lt;UK&gt;&gt;\n        + created_at: TIMESTAMP\n        + updated_at: TIMESTAMP\n    }\n\n    class \"crm.prostheses\" {\n        + id: UUID &lt;&lt;PK&gt;&gt;\n        + customer_id: UUID &lt;&lt;FK&gt;&gt;\n        + model_id: UUID &lt;&lt;FK&gt;&gt;\n        + chip_id: VARCHAR &lt;&lt;UK&gt;&gt;\n        + serial_number: VARCHAR\n    }\n\n    class \"crm.prosthesis_models\" {\n        + id: UUID &lt;&lt;PK&gt;&gt;\n        + name: VARCHAR\n        + warranty_years: INTEGER\n    }\n\n    class \"telemetry.raw_telemetry\" {\n        + id: BIGSERIAL &lt;&lt;PK&gt;&gt;\n        + chip_id: VARCHAR\n        + event_time: TIMESTAMP\n        + movement_type: INTEGER\n        + response_time_ms: FLOAT\n        + battery_level: FLOAT\n        + error_code: INTEGER\n    }\n\n    \"crm.customers\" \"1\" -- \"0..*\" \"crm.prostheses\"\n    \"crm.prosthesis_models\" \"1\" -- \"0..*\" \"crm.prostheses\"\n}\n\npackage \"OLAP: ClickHouse\" {\n    class \"reports.user_prosthesis_stats\" &lt;&lt;MergeTree&gt;&gt; {\n        + user_id: UUID\n        + ldap_username: String\n        + date: Date\n        + hour: DateTime\n        + movements_count: UInt32\n        + avg_response_time: Float32\n        + error_count: UInt32\n        + prosthesis_model: String\n        --\n        PARTITION BY toYYYYMM(date)\n        ORDER BY (ldap_username, date, hour)\n    }\n\n    class \"reports.crm_customers\" &lt;&lt;ReplacingMergeTree&gt;&gt; {\n        + id: UUID\n        + name: String\n        + ldap_username: String\n        + _version: UInt64\n        + _deleted: UInt8\n    }\n\n    class \"reports.crm_prostheses\" &lt;&lt;ReplacingMergeTree&gt;&gt; {\n        + id: UUID\n        + customer_id: UUID\n        + chip_id: String\n        + _version: UInt64\n        + _deleted: UInt8\n    }\n}\n\n\"crm.customers\" ..&gt; \"reports.user_prosthesis_stats\" : ETL\n\"telemetry.raw_telemetry\" ..&gt; \"reports.user_prosthesis_stats\" : ETL\n\"crm.customers\" ..&gt; \"reports.crm_customers\" : CDC\n\n@enduml\n</code></pre>"},{"location":"diagrams/c4-level4/#_2","title":"\u0418\u0441\u0445\u043e\u0434\u043d\u044b\u0435 \u0444\u0430\u0439\u043b\u044b","text":"<ul> <li>c4-level4-bff-classes.puml</li> <li>c4-level4-reports-classes.puml</li> <li>c4-level4-etl-classes.puml</li> <li>c4-level4-data-model.puml</li> </ul>"},{"location":"diagrams/deployment/","title":"Deployment Diagram","text":""},{"location":"diagrams/deployment/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>Deployment Diagram \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u0444\u0438\u0437\u0438\u0447\u0435\u0441\u043a\u043e\u0435 \u0440\u0430\u0437\u043c\u0435\u0449\u0435\u043d\u0438\u0435 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u043e\u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u044b BionicPRO \u0432 Docker \u043a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440\u0430\u0445.</p>"},{"location":"diagrams/deployment/#_2","title":"\u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u0430 \u0440\u0430\u0437\u0432\u0451\u0440\u0442\u044b\u0432\u0430\u043d\u0438\u044f","text":"<pre><code>@startuml Deployment\n!theme plain\ntitle BionicPRO - Deployment Diagram\n\nnode \"Docker Host\" {\n\n    node \"Frontend\" {\n        artifact \"frontend:3000\" as fe\n        note right: React 18\\nTypeScript\n    }\n\n    frame \"Security Layer\" {\n        artifact \"keycloak:8080\" as kc\n        artifact \"ldap:389\" as ldap\n        artifact \"bionicpro-auth:8000\" as bff\n        database \"redis:6379\" as redis\n    }\n\n    frame \"Application Layer\" {\n        artifact \"reports-service:8001\" as rs\n        artifact \"airflow-webserver:8081\" as af\n        artifact \"airflow-scheduler\" as af_sched\n    }\n\n    frame \"Data Layer\" {\n        database \"crm_db:5435\" as crm\n        database \"telemetry_db:5436\" as tel\n        database \"clickhouse:8123\" as ch\n        database \"keycloak_db:5433\" as kc_db\n        database \"airflow_db\" as af_db\n    }\n\n    frame \"CDC Pipeline\" {\n        artifact \"kafka:9092\" as kfk\n        artifact \"zookeeper:2181\" as zk\n        artifact \"debezium:8083\" as dbz\n    }\n\n    frame \"Caching Layer\" {\n        database \"minio:9002\" as s3\n        artifact \"nginx-cdn:8002\" as cdn\n    }\n}\n\ncloud \"External\" {\n    node \"Yandex ID\" as yandex\n    node \"Browser\" as browser\n    node \"Prosthesis\" as prosthesis\n}\n\nbrowser --&gt; fe : HTTPS:3000\nfe --&gt; bff : HTTP:8000\nfe --&gt; cdn : HTTP:8002\n\nbff --&gt; kc : HTTP:8080\nbff --&gt; redis : TCP:6379\nbff --&gt; rs : HTTP:8001\n\nkc --&gt; ldap : LDAP:389\nkc --&gt; kc_db : TCP:5432\nkc --&gt; yandex : HTTPS\n\nrs --&gt; ch : TCP:9000\nrs --&gt; redis : TCP:6379\nrs --&gt; s3 : HTTP:9000\ncdn --&gt; s3 : HTTP:9000\n\naf --&gt; af_db : TCP:5432\naf_sched --&gt; crm : TCP:5432\naf_sched --&gt; tel : TCP:5432\naf_sched --&gt; ch : TCP:9000\n\ncrm --&gt; dbz : Logical Replication\ndbz --&gt; kfk : TCP:9092\nzk &lt;--&gt; kfk : TCP:2181\nkfk --&gt; ch : KafkaEngine\n\nprosthesis --&gt; rs : HTTPS/4G\n\n@enduml\n</code></pre>"},{"location":"diagrams/deployment/#_3","title":"\u0421\u0435\u0440\u0432\u0438\u0441\u044b \u0438 \u043f\u043e\u0440\u0442\u044b","text":""},{"location":"diagrams/deployment/#_4","title":"\u0412\u043d\u0435\u0448\u043d\u0438\u0435 \u043f\u043e\u0440\u0442\u044b","text":"\u0421\u0435\u0440\u0432\u0438\u0441 \u041f\u043e\u0440\u0442 \u041f\u0440\u043e\u0442\u043e\u043a\u043e\u043b \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 Frontend 3000 HTTP React SPA BFF Auth 8000 HTTP Authentication API Reports Service 8001 HTTP Reports REST API Nginx CDN 8002 HTTP CDN Proxy Keycloak 8080 HTTP Identity Provider Airflow 8081 HTTP ETL Web UI Debezium 8083 HTTP CDC REST API Kafka UI 8084 HTTP Kafka Monitoring ClickHouse HTTP 8123 HTTP OLAP HTTP API MinIO Console 9001 HTTP S3 Web UI MinIO S3 API 9002 HTTP S3 API Kafka 9092 TCP Message Broker"},{"location":"diagrams/deployment/#docker-network","title":"\u0412\u043d\u0443\u0442\u0440\u0435\u043d\u043d\u0438\u0435 \u043f\u043e\u0440\u0442\u044b (Docker network)","text":"\u0421\u0435\u0440\u0432\u0438\u0441 \u041f\u043e\u0440\u0442 \u041f\u0440\u043e\u0442\u043e\u043a\u043e\u043b Redis 6379 TCP LDAP 389 LDAP ClickHouse Native 9000 TCP Zookeeper 2181 TCP PostgreSQL (all) 5432 TCP"},{"location":"diagrams/deployment/#docker-compose-services","title":"Docker Compose Services","text":"<pre><code>services:\n  # Frontend\n  frontend:              # :3000\n\n  # Security Layer\n  keycloak:              # :8080\n  keycloak_db:           # :5433\n  ldap:                  # :389\n  bionicpro-auth:        # :8000\n  redis:                 # :6379\n\n  # Application Layer\n  reports-service:       # :8001\n  airflow-webserver:     # :8081\n  airflow-scheduler:     # internal\n\n  # Data Layer\n  crm_db:                # :5435\n  telemetry_db:          # :5436\n  clickhouse:            # :8123, :9000\n\n  # CDC Pipeline\n  kafka:                 # :9092\n  zookeeper:             # :2181\n  debezium:              # :8083\n\n  # Caching Layer\n  minio:                 # :9001, :9002\n  nginx-cdn:             # :8002\n</code></pre>"},{"location":"diagrams/deployment/#volumes-persistent-data","title":"Volumes (Persistent Data)","text":"Volume \u041a\u043e\u043d\u0442\u0435\u0439\u043d\u0435\u0440 \u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435 postgres-keycloak-data keycloak_db Keycloak database postgres-bionicpro-data bionicpro_db User profiles postgres-crm-data crm_db CRM data postgres-telemetry-data telemetry_db Telemetry data postgres-airflow-data airflow_db Airflow metadata clickhouse-data clickhouse OLAP data minio-data minio S3 objects redis-data redis Sessions ldap-data ldap LDAP data kafka-data kafka Kafka logs"},{"location":"diagrams/deployment/#resource-requirements","title":"Resource Requirements","text":""},{"location":"diagrams/deployment/#minimum","title":"Minimum","text":"Resource Value CPU 4 cores RAM 8 GB Disk 20 GB"},{"location":"diagrams/deployment/#recommended","title":"Recommended","text":"Resource Value CPU 8 cores RAM 16 GB Disk 50 GB"},{"location":"diagrams/deployment/#per-service-memory-allocation","title":"Per-Service Memory Allocation","text":"Service Memory Keycloak 512MB - 1GB ClickHouse 1GB - 4GB Kafka + Zookeeper 1GB Airflow (total) 1GB - 2GB PostgreSQL (each) 256MB - 512MB Other services 128MB - 256MB"},{"location":"diagrams/deployment/#network-topology","title":"Network Topology","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     Docker Network (bridge)                  \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502\n\u2502  \u2502 frontend \u2502   \u2502   bff    \u2502   \u2502 reports  \u2502                \u2502\n\u2502  \u2502  :3000   \u2502\u2500\u2500\u25b6\u2502  :8000   \u2502\u2500\u2500\u25b6\u2502  :8001   \u2502                \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518                \u2502\n\u2502                      \u2502              \u2502                       \u2502\n\u2502                      \u25bc              \u25bc                       \u2502\n\u2502               \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                  \u2502\n\u2502               \u2502 keycloak \u2502   \u2502clickhouse\u2502                  \u2502\n\u2502               \u2502  :8080   \u2502   \u2502:8123/9000\u2502                  \u2502\n\u2502               \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518   \u2514\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518                  \u2502\n\u2502                    \u2502              \u2502                        \u2502\n\u2502                    \u25bc              \u25bc                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502  \u2502   ldap   \u2502 \u2502  redis   \u2502 \u2502  kafka   \u2502 \u2502  minio   \u2502     \u2502\n\u2502  \u2502   :389   \u2502 \u2502  :6379   \u2502 \u2502  :9092   \u2502 \u2502  :9002   \u2502     \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"diagrams/deployment/#_5","title":"\u0418\u0441\u0445\u043e\u0434\u043d\u044b\u0439 \u0444\u0430\u0439\u043b","text":"<p>deployment-diagram.puml</p>"},{"location":"diagrams/sequences/","title":"Sequence Diagrams","text":""},{"location":"diagrams/sequences/#_1","title":"\u041e\u043f\u0438\u0441\u0430\u043d\u0438\u0435","text":"<p>\u0414\u0438\u0430\u0433\u0440\u0430\u043c\u043c\u044b \u043f\u043e\u0441\u043b\u0435\u0434\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u0438 \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u044e\u0442 \u0432\u0437\u0430\u0438\u043c\u043e\u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435 \u043a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442\u043e\u0432 \u0441\u0438\u0441\u0442\u0435\u043c\u044b \u0432\u043e \u0432\u0440\u0435\u043c\u0435\u043d\u0438 \u0434\u043b\u044f \u043a\u043b\u044e\u0447\u0435\u0432\u044b\u0445 \u0431\u0438\u0437\u043d\u0435\u0441-\u043f\u0440\u043e\u0446\u0435\u0441\u0441\u043e\u0432.</p>"},{"location":"diagrams/sequences/#authentication-flow-oauth2-pkce","title":"Authentication Flow (OAuth2 PKCE)","text":"<p>\u041f\u0440\u043e\u0446\u0435\u0441\u0441 \u0430\u0443\u0442\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0446\u0438\u0438 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044f \u0441 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435\u043c OAuth2 PKCE flow.</p> <pre><code>@startuml Auth_Flow\n!theme plain\ntitle Authentication Flow (OAuth2 PKCE)\n\nactor User\nparticipant \"Frontend\" as FE\nparticipant \"BFF Auth\" as BFF\nparticipant \"Redis\" as Redis\nparticipant \"Keycloak\" as KC\nparticipant \"LDAP\" as LDAP\n\n== Login ==\nUser -&gt; FE: Click Login\nFE -&gt; BFF: GET /auth/login\nBFF -&gt; BFF: Generate PKCE\\n(verifier, challenge)\nBFF -&gt; Redis: Store verifier\nBFF --&gt; FE: 302 \u2192 Keycloak\n\nFE -&gt; KC: Auth Request + challenge\nKC -&gt; LDAP: Validate credentials\nLDAP --&gt; KC: User found\nKC --&gt; FE: 302 + auth code\n\n== Token Exchange ==\nFE -&gt; BFF: GET /callback?code=xxx\nBFF -&gt; Redis: Get verifier\nBFF -&gt; KC: POST /token + verifier\nKC --&gt; BFF: access + refresh tokens\nBFF -&gt; BFF: Encrypt tokens\nBFF -&gt; Redis: Store encrypted tokens\nBFF --&gt; FE: Set-Cookie: session_id\n\n== API Request ==\nUser -&gt; FE: View reports\nFE -&gt; BFF: GET /api/reports + Cookie\nBFF -&gt; Redis: Get tokens\nBFF -&gt; BFF: Decrypt access_token\nBFF -&gt; \"Reports\" as RS: GET + Bearer token\nRS --&gt; BFF: Data\nBFF --&gt; FE: Response\n\n@enduml\n</code></pre>"},{"location":"diagrams/sequences/#cdc-data-flow","title":"CDC Data Flow","text":"<p>\u041f\u0440\u043e\u0446\u0435\u0441\u0441 \u0440\u0435\u043f\u043b\u0438\u043a\u0430\u0446\u0438\u0438 \u0434\u0430\u043d\u043d\u044b\u0445 \u0438\u0437 CRM \u0432 ClickHouse \u0447\u0435\u0440\u0435\u0437 CDC pipeline.</p> <pre><code>@startuml CDC_Flow\n!theme plain\ntitle CDC Data Flow (Debezium \u2192 Kafka \u2192 ClickHouse)\n\nparticipant \"CRM\\nPostgreSQL\" as CRM\nparticipant \"WAL\" as WAL\nparticipant \"Debezium\" as DBZ\nparticipant \"Kafka\" as KFK\nparticipant \"ClickHouse\\nKafkaEngine\" as KE\nparticipant \"MaterializedView\" as MV\nparticipant \"Target Table\" as TT\n\n== INSERT ==\nCRM -&gt; WAL: Write INSERT\nWAL -&gt; DBZ: Stream event\nDBZ -&gt; DBZ: Transform (SMT)\nDBZ -&gt; KFK: Publish to topic\n\nKFK -&gt; KE: Consume\nKE -&gt; MV: Trigger\nMV -&gt; MV: Extract JSON fields\\nSet _version, _deleted=0\nMV -&gt; TT: INSERT\n\n== UPDATE ==\nCRM -&gt; WAL: Write UPDATE\nWAL -&gt; DBZ: Stream event\nDBZ -&gt; KFK: Publish\nKFK -&gt; KE: Consume\nKE -&gt; MV: Trigger\nMV -&gt; MV: Set new _version\nMV -&gt; TT: INSERT (new version)\n\nnote right of TT\n  ReplacingMergeTree\n  keeps latest _version\nend note\n\n== DELETE ==\nCRM -&gt; WAL: Write DELETE\nWAL -&gt; DBZ: Stream event\nDBZ -&gt; KFK: Publish (__op = 'd')\nKFK -&gt; KE: Consume\nKE -&gt; MV: Trigger\nMV -&gt; MV: Set _deleted = 1\nMV -&gt; TT: INSERT\n\n@enduml\n</code></pre>"},{"location":"diagrams/sequences/#reports-flow-with-cdn-caching","title":"Reports Flow with CDN Caching","text":"<p>\u041f\u0440\u043e\u0446\u0435\u0441\u0441 \u043f\u043e\u043b\u0443\u0447\u0435\u043d\u0438\u044f \u043e\u0442\u0447\u0451\u0442\u043e\u0432 \u0441 \u0438\u0441\u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u043d\u0438\u0435\u043c CDN \u043a\u044d\u0448\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f.</p> <pre><code>@startuml Reports_Flow\n!theme plain\ntitle Reports Flow with CDN Caching\n\nactor User\nparticipant \"Frontend\" as FE\nparticipant \"BFF\" as BFF\nparticipant \"Reports\\nService\" as RS\nparticipant \"MinIO S3\" as S3\nparticipant \"Nginx CDN\" as CDN\nparticipant \"ClickHouse\" as CH\n\nUser -&gt; FE: View report\nFE -&gt; BFF: GET /api/reports/cdn/2024-01-15\nBFF -&gt; RS: GET + JWT\n\nRS -&gt; S3: HEAD (check exists)\n\nalt Cache HIT\n    S3 --&gt; RS: 200 OK\n    RS --&gt; BFF: CDN URL\n    BFF --&gt; FE: CDN URL\n    FE -&gt; CDN: GET report\n    CDN -&gt; CDN: Check cache\n    alt CDN HIT\n        CDN --&gt; FE: Report (cached)\n    else CDN MISS\n        CDN -&gt; S3: GET\n        S3 --&gt; CDN: Report\n        CDN --&gt; FE: Report\n    end\nelse Cache MISS\n    S3 --&gt; RS: 404\n    RS -&gt; CH: SELECT\n    CH --&gt; RS: Data\n    RS -&gt; RS: Generate JSON\n    RS -&gt; S3: PUT report\n    RS --&gt; BFF: CDN URL\n    BFF --&gt; FE: CDN URL\n    FE -&gt; CDN: GET report\n    CDN -&gt; S3: GET\n    CDN --&gt; FE: Report\nend\n\nFE --&gt; User: Display\n\n@enduml\n</code></pre>"},{"location":"diagrams/sequences/#etl-pipeline-flow","title":"ETL Pipeline Flow","text":"<p>\u041f\u0440\u043e\u0446\u0435\u0441\u0441 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f ETL pipeline \u0432 Apache Airflow.</p> <pre><code>@startuml ETL_Flow\n!theme plain\ntitle ETL Pipeline Flow\n\nparticipant \"Scheduler\" as Sched\nparticipant \"Executor\" as Exec\nparticipant \"CRM DB\" as CRM\nparticipant \"Telemetry DB\" as TEL\nparticipant \"ClickHouse\" as CH\nparticipant \"Reports\\nService\" as RS\n\nSched -&gt; Exec: Trigger DAG\\n(*/15 * * * *)\n\n== Parallel Extract ==\npar\n    Exec -&gt; CRM: SELECT customers,\\nprostheses, models\n    CRM --&gt; Exec: CRM DataFrame\nand\n    Exec -&gt; TEL: SELECT aggregated\\ntelemetry\n    TEL --&gt; Exec: Telemetry DataFrame\nend\n\n== Transform ==\nExec -&gt; Exec: JOIN on chip_id\nExec -&gt; Exec: Calculate metrics:\\nerror_rate, etc.\n\n== Load ==\nExec -&gt; CH: INSERT INTO\\nuser_prosthesis_stats\nCH --&gt; Exec: OK\n\nExec -&gt; Exec: Get affected user_ids\n\n== Invalidate Cache ==\nloop for each user_id\n    Exec -&gt; RS: POST /invalidate\n    RS --&gt; Exec: OK\nend\n\nExec -&gt; Sched: DAG completed\n\n@enduml\n</code></pre>"},{"location":"diagrams/sequences/#_2","title":"\u0418\u0441\u0445\u043e\u0434\u043d\u044b\u0435 \u0444\u0430\u0439\u043b\u044b","text":"<ul> <li>sequence-auth-flow.puml</li> <li>sequence-cdc-flow.puml</li> <li>sequence-reports-flow.puml</li> <li>sequence-etl-flow.puml</li> </ul>"}]}