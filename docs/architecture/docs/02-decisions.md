# Архитектурные решения

## ADR-001: Использование BFF Pattern

**Статус:** Принято

**Контекст:** Необходимо обеспечить безопасное хранение OAuth2 токенов.

**Решение:** Использовать Backend-for-Frontend pattern — токены хранятся на сервере в Redis, фронтенд получает только HTTP-only session cookies.

**Последствия:** Повышенная безопасность, но дополнительная сложность инфраструктуры.

---

## ADR-002: CDC вместо ETL для CRM данных

**Статус:** Принято

**Контекст:** ETL каждые 15 минут создаёт нагрузку на CRM базу данных.

**Решение:** Использовать Debezium CDC для real-time репликации CRM → ClickHouse через Kafka.

**Последствия:** Минимальная нагрузка на OLTP, данные в OLAP обновляются за секунды.

---

## ADR-003: ClickHouse для OLAP

**Статус:** Принято

**Контекст:** Требуется быстрая аналитика по большим объёмам телеметрии.

**Решение:** Использовать ClickHouse как OLAP хранилище с партиционированием по месяцам.

**Последствия:** Высокая производительность запросов, но требует отдельной инфраструктуры.

---

## ADR-004: MinIO + Nginx CDN для кэширования

**Статус:** Принято

**Контекст:** Снижение нагрузки на ClickHouse при частых запросах отчётов.

**Решение:** Генерировать JSON отчёты в MinIO S3, раздавать через Nginx с HTTP кэшированием.

**Последствия:** Latency снижается с 200ms до 30ms для закэшированных отчётов.
